import{Z as _e,a0 as ze,a1 as re,r as h,a5 as Oe,O as G,Y as $e,aj as Me,ak as Ae,al as ke,am as De,an as Te,ao as Be,ap as Ne,aq as Pe,x as Le,A as Ve,z as We,d as B,j as e,F as j,S as N,I as T,T as Re,B as F,a as E,g as A,n as Ge,c as P,M as oe,P as R,q as ie,i as He,f as Ke,U as Je,t as Ue,b as qe,C as Ye,m as ae}from"./main-Bw4HDwdl.js";import{M as Xe}from"./index-DM4pgOQc.js";import{C as le}from"./index-B-qvGi8z.js";import{T as O}from"./index-Edtf3g26.js";import{T as Qe,M as ce}from"./index-DZ6_--il.js";import{S as Ze}from"./index-Ch4DwbeY.js";import{T as de}from"./index-ClFmFDqn.js";import{F as ue}from"./Table-Nj5nWv8r.js";import{D as et}from"./index-DCK1FHNl.js";import{S as tt}from"./index-AJ8DPt0q.js";import{_ as st}from"./callSuper-9v1BOlwe.js";import{I as nt}from"./index-CAFBiRG0.js";const V=(s,i,t,n,r)=>({background:s,border:`${re(n.lineWidth)} ${n.lineType} ${i}`,[`${r}-icon`]:{color:t}}),rt=s=>{const{componentCls:i,motionDurationSlow:t,marginXS:n,marginSM:r,fontSize:o,fontSizeLG:l,lineHeight:a,borderRadiusLG:c,motionEaseInOutCirc:u,withDescriptionIconSize:d,colorText:m,colorTextHeading:f,withDescriptionPadding:x,defaultPadding:p}=s;return{[i]:Object.assign(Object.assign({},ze(s)),{position:"relative",display:"flex",alignItems:"center",padding:p,wordWrap:"break-word",borderRadius:c,[`&${i}-rtl`]:{direction:"rtl"},[`${i}-content`]:{flex:1,minWidth:0},[`${i}-icon`]:{marginInlineEnd:n,lineHeight:0},"&-description":{display:"none",fontSize:o,lineHeight:a},"&-message":{color:f},[`&${i}-motion-leave`]:{overflow:"hidden",opacity:1,transition:`max-height ${t} ${u}, opacity ${t} ${u},
        padding-top ${t} ${u}, padding-bottom ${t} ${u},
        margin-bottom ${t} ${u}`},[`&${i}-motion-leave-active`]:{maxHeight:0,marginBottom:"0 !important",paddingTop:0,paddingBottom:0,opacity:0}}),[`${i}-with-description`]:{alignItems:"flex-start",padding:x,[`${i}-icon`]:{marginInlineEnd:r,fontSize:d,lineHeight:0},[`${i}-message`]:{display:"block",marginBottom:n,color:f,fontSize:l},[`${i}-description`]:{display:"block",color:m}},[`${i}-banner`]:{marginBottom:0,border:"0 !important",borderRadius:0}}},ot=s=>{const{componentCls:i,colorSuccess:t,colorSuccessBorder:n,colorSuccessBg:r,colorWarning:o,colorWarningBorder:l,colorWarningBg:a,colorError:c,colorErrorBorder:u,colorErrorBg:d,colorInfo:m,colorInfoBorder:f,colorInfoBg:x}=s;return{[i]:{"&-success":V(r,n,t,s,i),"&-info":V(x,f,m,s,i),"&-warning":V(a,l,o,s,i),"&-error":Object.assign(Object.assign({},V(d,u,c,s,i)),{[`${i}-description > pre`]:{margin:0,padding:0}})}}},it=s=>{const{componentCls:i,iconCls:t,motionDurationMid:n,marginXS:r,fontSizeIcon:o,colorIcon:l,colorIconHover:a}=s;return{[i]:{"&-action":{marginInlineStart:r},[`${i}-close-icon`]:{marginInlineStart:r,padding:0,overflow:"hidden",fontSize:o,lineHeight:re(o),backgroundColor:"transparent",border:"none",outline:"none",cursor:"pointer",[`${t}-close`]:{color:l,transition:`color ${n}`,"&:hover":{color:a}}},"&-close-text":{color:l,transition:`color ${n}`,"&:hover":{color:a}}}}},at=s=>({withDescriptionIconSize:s.fontSizeHeading3,defaultPadding:`${s.paddingContentVerticalSM}px 12px`,withDescriptionPadding:`${s.paddingMD}px ${s.paddingContentHorizontalLG}px`}),lt=_e("Alert",s=>[rt(s),ot(s),it(s)],at);var Y=function(s,i){var t={};for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&i.indexOf(n)<0&&(t[n]=s[n]);if(s!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,n=Object.getOwnPropertySymbols(s);r<n.length;r++)i.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(s,n[r])&&(t[n[r]]=s[n[r]]);return t};const ct={success:Ne,info:Be,error:Te,warning:De},dt=s=>{const{icon:i,prefixCls:t,type:n}=s,r=ct[n]||null;return i?ke(i,h.createElement("span",{className:`${t}-icon`},i),()=>({className:G(`${t}-icon`,i.props.className)})):h.createElement(r,{className:`${t}-icon`})},ut=s=>{const{isClosable:i,prefixCls:t,closeIcon:n,handleClose:r,ariaProps:o}=s,l=n===!0||n===void 0?h.createElement(Pe,null):n;return i?h.createElement("button",Object.assign({type:"button",onClick:r,className:`${t}-close-icon`,tabIndex:0},o),l):null},he=h.forwardRef((s,i)=>{const{description:t,prefixCls:n,message:r,banner:o,className:l,rootClassName:a,style:c,onMouseEnter:u,onMouseLeave:d,onClick:m,afterClose:f,showIcon:x,closable:p,closeText:b,closeIcon:y,action:v,id:S}=s,w=Y(s,["description","prefixCls","message","banner","className","rootClassName","style","onMouseEnter","onMouseLeave","onClick","afterClose","showIcon","closable","closeText","closeIcon","action","id"]),[g,I]=h.useState(!1),C=h.useRef(null);h.useImperativeHandle(i,()=>({nativeElement:C.current}));const{getPrefixCls:$,direction:L,closable:_,closeIcon:K,className:ge,style:xe}=Oe("alert"),z=$("alert",n),[ye,be,je]=lt(z),ve=M=>{var k;I(!0),(k=s.onClose)===null||k===void 0||k.call(s,M)},J=h.useMemo(()=>s.type!==void 0?s.type:o?"warning":"info",[s.type,o]),Se=h.useMemo(()=>typeof p=="object"&&p.closeIcon||b?!0:typeof p=="boolean"?p:y!==!1&&y!==null&&y!==void 0?!0:!!_,[b,y,p,_]),U=o&&x===void 0?!0:x,we=G(z,`${z}-${J}`,{[`${z}-with-description`]:!!t,[`${z}-no-icon`]:!U,[`${z}-banner`]:!!o,[`${z}-rtl`]:L==="rtl"},ge,l,a,je,be),Ce=$e(w,{aria:!0,data:!0}),Ie=h.useMemo(()=>typeof p=="object"&&p.closeIcon?p.closeIcon:b||(y!==void 0?y:typeof _=="object"&&_.closeIcon?_.closeIcon:K),[y,p,b,K]),Fe=h.useMemo(()=>{const M=p??_;if(typeof M=="object"){const{closeIcon:k}=M;return Y(M,["closeIcon"])}return{}},[p,_]);return ye(h.createElement(Me,{visible:!g,motionName:`${z}-motion`,motionAppear:!1,motionEnter:!1,onLeaveStart:M=>({maxHeight:M.offsetHeight}),onLeaveEnd:f},(M,k)=>{let{className:q,style:Ee}=M;return h.createElement("div",Object.assign({id:S,ref:Ae(C,k),"data-show":!g,className:G(we,q),style:Object.assign(Object.assign(Object.assign({},xe),c),Ee),onMouseEnter:u,onMouseLeave:d,onClick:m,role:"alert"},Ce),U?h.createElement(dt,{description:t,icon:s.icon,prefixCls:z,type:J}):null,h.createElement("div",{className:`${z}-content`},r?h.createElement("div",{className:`${z}-message`},r):null,t?h.createElement("div",{className:`${z}-description`},t):null),v?h.createElement("div",{className:`${z}-action`},v):null,h.createElement(ut,{isClosable:Se,prefixCls:z,closeIcon:Ie,handleClose:ve,ariaProps:Fe}))}))});let ht=function(s){function i(){var t;return We(this,i),t=st(this,i,arguments),t.state={error:void 0,info:{componentStack:""}},t}return Le(i,s),Ve(i,[{key:"componentDidCatch",value:function(n,r){this.setState({error:n,info:r})}},{key:"render",value:function(){const{message:n,description:r,id:o,children:l}=this.props,{error:a,info:c}=this.state,u=(c==null?void 0:c.componentStack)||null,d=typeof n>"u"?(a||"").toString():n,m=typeof r>"u"?u:r;return a?h.createElement(he,{id:o,type:"error",message:d,description:h.createElement("pre",{style:{fontSize:"0.9em",overflowX:"auto"}},m)}):l}}])}(h.Component);const me=he;me.ErrorBoundary=ht;const mt=({type:s,dataMap:i,constDataMap:t,componentMap:n,inputAnalysisMethod:r,dataKey:o,data:l,name:a,component_id:c,inputKey:u,...d})=>{if(!i)return e.jsx("div",{children:"加载中...."});i={...i,...t};const m=n[s];if(!m)return e.jsxs("div",{children:["未知类型 ",s]});const{Component:f,dataKey:x,...p}=m;console.log(p);let b=[];return l?b=l:r?b=i[r]:o?o in i&&(b=i[o]):x?x in i&&(b=i[x]):"first_data_key"in i?b=i[i.first_data_key]:c in i&&(b=i[c]),e.jsx(f,{...p,...d,data:b,name:a})},H=h.memo(({formJson:s,dataMap:i})=>{if(!s)return null;const{projectObj:t}=B(),o={rank:[{label:"SGB",value:"SGB"},{label:"SPECIES",value:"SPECIES"},{label:"GENUS",value:"GENUS"},{label:"FAMILY",value:"FAMILY"},{label:"ORDER",value:"ORDER"},{label:"CLASS",value:"CLASS"},{label:"PHYLUM",value:"PHYLUM"}],group_field:t!=null&&t.metadata_form?t==null?void 0:t.metadata_form.map(a=>({label:a.label,value:a.name})):[]},l={GroupSelect:{Component:W,dataKey:"sample_group_list"},Input:{Component:xt},GroupCompareSelect:{Component:gt},BaseSelect:{Component:W},BaseInputNumber:{Component:jt},BaseInput:{Component:yt},BaseSwitch:{Component:bt},RankSelect:{Component:W,dataKey:"rank",mode:void 0,initialValue:"SPECIES"},GroupFieldSelect:{Component:W,dataKey:"group_field",mode:void 0,initialValue:"group"},FilterFieldSelect:{Component:ft,dataKey:"sample_group_list",mode:void 0},GroupSelectSampleButton:{Component:vt},MetaphlanCladeSelect:{Component:pt},SelectAll:{Component:St,dataKey:"sample_group_list"}};return e.jsx(e.Fragment,{children:s.map((a,c)=>e.jsx(mt,{...a,dataMap:i,componentMap:l,constDataMap:o},c))})},(s,i)=>(console.log("prevProps==nextProps: ",JSON.stringify(s)===JSON.stringify(i)),JSON.stringify(s)===JSON.stringify(i))),ft=({label:s,name:i,data:t,rules:n,field:r,...o})=>{const[l,a]=h.useState(),c=j.useFormInstance();return h.useEffect(()=>{if(t&&r){const u=[...new Set(t.map(r))],d=u.map(m=>({label:m,value:m}));a(d),c.setFieldValue(i,u[0])}},[t]),e.jsx(e.Fragment,{children:e.jsx(j.Item,{label:s,name:i,rules:n,children:e.jsx(fe,{...o,options:l})})})},fe=({options:s,clear:i,value:t,onChange:n,...r})=>{const o=j.useFormInstance(),l=a=>{n(a),i&&o.resetFields(i)};return e.jsx(N,{showSearch:!0,filterOption:(a,c)=>((c==null?void 0:c.label)??"").toLowerCase().includes(a.toLowerCase()),...r,options:s,value:t,onChange:l})},pt=({label:s,name:i,data:t,initialValue:n,rules:r,...o})=>{const[l,a]=h.useState(),c=async()=>{let d=(await E.get("/fast-api/get_metaphlan_clade")).data.map(m=>({label:`${m.taxon.replaceAll(" ","_")}_${m.clade}`,value:m.clade}));a(d)};return h.useEffect(()=>{c()},[]),e.jsx(e.Fragment,{children:e.jsx(j.Item,{initialValue:n,label:s,name:i,rules:r,children:e.jsx(N,{...o,options:l,showSearch:!0,filterOption:(u,d)=>((d==null?void 0:d.label)??"").toLowerCase().includes(u.toLowerCase())})})})},gt=({label:s,name:i,data:t,initialValue:n,rules:r,...o})=>{const l=j.useFormInstance(),a=j.useWatch(["sites1","group"],l),c=j.useWatch(["sites2","group"],l),[u,d]=h.useState();return h.useEffect(()=>{a&&c&&d([{label:"Prevalent in both sites",value:"Prevalent in both sites"},{label:`Prevalent in ${c.join("-")}`,value:`Prevalent in ${c.join("-")}`},{label:`Prevalent in ${a.join("-")}`,value:`Prevalent in ${a.join("-")}`},{label:"Not prevalent in either sites",value:"Not prevalent in either sites"}])},[a,c]),e.jsx(e.Fragment,{children:e.jsx(j.Item,{initialValue:n,label:s,name:i,rules:r,children:e.jsx(N,{showSearch:!0,filterOption:(m,f)=>((f==null?void 0:f.label)??"").toLowerCase().includes(m.toLowerCase()),...o,options:u})})})},xt=({label:s,name:i,data:t,initialValue:n,rules:r,...o})=>e.jsx(e.Fragment,{children:e.jsx(j.Item,{initialValue:n,label:s,name:i,rules:r,children:e.jsx(Re,{...o})})}),yt=({label:s,name:i,data:t,initialValue:n,rules:r,...o})=>e.jsx(e.Fragment,{children:e.jsx(j.Item,{initialValue:n,label:s,name:i,rules:r,children:e.jsx(T,{...o})})}),bt=({label:s,name:i,data:t,initialValue:n,rules:r,...o})=>e.jsx(e.Fragment,{children:e.jsx(j.Item,{initialValue:n,label:s,name:i,rules:r,children:e.jsx(Ze,{...o})})}),jt=({label:s,name:i,data:t,initialValue:n,rules:r,...o})=>e.jsx(e.Fragment,{children:e.jsx(j.Item,{initialValue:n,label:s,name:i,rules:r,children:e.jsx(Qe,{...o})})}),W=({label:s,name:i,data:t,initialValue:n,rules:r,...o})=>e.jsx(e.Fragment,{children:e.jsx(j.Item,{initialValue:n||null,label:s,name:i,rules:r,children:e.jsx(fe,{...o,options:t})})}),vt=({label:s,name:i,rules:t,data:n,filter:r,group:o,groupField:l})=>{const[a,c]=h.useState(),[u,d]=h.useState([]),m=j.useFormInstance();let f=[];r&&(f=r.map(y=>y.name));const x=j.useWatch(y=>{const v=Object.entries(y).filter(([S])=>f.includes(S));return Object.fromEntries(v)},m),p=j.useWatch(o,m),b=(y,v)=>{const S=y.reduce((w,g)=>{const I=g[v];return w[I]||(w[I]=[]),w[I].push(g.value),w},{});c(S)};return h.useEffect(()=>{r&&x&&(n=r.reduce((y,v)=>y.filter(S=>v.method(S)===x[v.name]),n),n=n.map(y=>{const{label:v,id:S,value:w,...g}=y;return{label:`${y.label}(${r[0].method(y)})`,value:y.value,...g}})),n&&l?b(n,l):n&&p&&b(n,p),d(n)},[n,p,x]),e.jsxs(e.Fragment,{children:[e.jsx(j.Item,{label:s,name:[i,"sample"],rules:t,children:e.jsx(Ct,{sampleGrouped:a,sampleGroup:u,watch:[i,"group"]})}),e.jsx(j.Item,{label:s,name:[i,"group"],children:e.jsx(It,{sampleGrouped:a})})]})},St=({label:s,name:i,data:t,initialValue:n,rules:r,...o})=>e.jsx(e.Fragment,{children:e.jsx(j.Item,{initialValue:n,label:s,name:i,rules:r,children:e.jsx(wt,{data:t,...o})})}),wt=({data:s,value:i,onChange:t,mode:n,...r})=>{const[o,l]=h.useState(i),a=c=>{console.log(c),t(c),l(c)};return e.jsxs(e.Fragment,{children:[e.jsx(N,{...r,mode:n,value:o,onChange:a,allowClear:!0,options:s}),n=="multiple"&&e.jsxs(F,{onClick:()=>{const c=s.map(u=>u.value);l(c),t(c)},children:["选择全部",o&&e.jsxs(e.Fragment,{children:["(",o.length,")"]})]})]})},Ct=({value:s,onChange:i,sampleGroup:t,watch:n,sampleGrouped:r})=>{const[o,l]=h.useState(),a=j.useFormInstance(),c=j.useWatch(n,a);h.useEffect(()=>{l(c)},[c]);const u=d=>{const m=Object.entries(r||{}).filter(([f])=>d.includes(f)).flatMap(([,f])=>f);i(m)};return h.useEffect(()=>{o&&u(o)},[o]),e.jsxs(e.Fragment,{children:[e.jsx(N,{showSearch:!0,filterOption:(d,m)=>((m==null?void 0:m.label)??"").toLowerCase().includes(d.toLowerCase()),mode:"multiple",value:s,onChange:i,options:t}),s&&e.jsxs(e.Fragment,{children:["一共选择",s.length,"个样本"]})]})},It=({value:s,onChange:i,sampleGrouped:t})=>{const n=r=>{if((s||[]).includes(r)){const o=(s||[]).filter(l=>!l.includes(r));i(o)}else{const o=[...s||[],r];i(o)}};return e.jsx(e.Fragment,{children:e.jsx(A,{gap:"small",wrap:!0,children:Object.entries(t||{}).map(([r,o])=>e.jsx("span",{children:e.jsxs(F,{size:"small",type:(s||[]).includes(r)?"primary":"dashed",onClick:()=>n(r),children:[r,"(",o.length,")"]})},r))})})},ps=async s=>await E.get("/file-operation/read-file",{params:{file_path:s}}),Ft=async(s,i=0)=>await E.get("/file-operation/read-log-file",{params:{file_path:s,offset:i}}),gs=async(s,i)=>await E.post("/file-operation/write-file",{file_path:s,content:i}),xs=async s=>await E.get(`/find-analysis-by-id/${s}`),Et=async(s,i)=>await E.post(`/run-analysis-v2/${s}?run_type=${i}`),_t=async s=>await E.post(`/analysis/stop-analysis/${s}`);function D(s,i,t){let n=t.initialDeps??[],r;function o(){var l,a,c,u;let d;t.key&&((l=t.debug)!=null&&l.call(t))&&(d=Date.now());const m=s();if(!(m.length!==n.length||m.some((p,b)=>n[b]!==p)))return r;n=m;let x;if(t.key&&((a=t.debug)!=null&&a.call(t))&&(x=Date.now()),r=i(...m),t.key&&((c=t.debug)!=null&&c.call(t))){const p=Math.round((Date.now()-d)*100)/100,b=Math.round((Date.now()-x)*100)/100,y=b/16,v=(S,w)=>{for(S=String(S);S.length<w;)S=" "+S;return S};console.info(`%c⏱ ${v(b,5)} /${v(p,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*y,120))}deg 100% 31%);`,t==null?void 0:t.key)}return(u=t==null?void 0:t.onChange)==null||u.call(t,r),r}return o.updateDeps=l=>{n=l},o}function X(s,i){if(s===void 0)throw new Error("Unexpected undefined");return s}const zt=(s,i)=>Math.abs(s-i)<1.01,Ot=(s,i,t)=>{let n;return function(...r){s.clearTimeout(n),n=s.setTimeout(()=>i.apply(this,r),t)}},Q=s=>{const{offsetWidth:i,offsetHeight:t}=s;return{width:i,height:t}},$t=s=>s,Mt=s=>{const i=Math.max(s.startIndex-s.overscan,0),t=Math.min(s.endIndex+s.overscan,s.count-1),n=[];for(let r=i;r<=t;r++)n.push(r);return n},At=(s,i)=>{const t=s.scrollElement;if(!t)return;const n=s.targetWindow;if(!n)return;const r=l=>{const{width:a,height:c}=l;i({width:Math.round(a),height:Math.round(c)})};if(r(Q(t)),!n.ResizeObserver)return()=>{};const o=new n.ResizeObserver(l=>{const a=()=>{const c=l[0];if(c!=null&&c.borderBoxSize){const u=c.borderBoxSize[0];if(u){r({width:u.inlineSize,height:u.blockSize});return}}r(Q(t))};s.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(a):a()});return o.observe(t,{box:"border-box"}),()=>{o.unobserve(t)}},Z={passive:!0},ee=typeof window>"u"?!0:"onscrollend"in window,kt=(s,i)=>{const t=s.scrollElement;if(!t)return;const n=s.targetWindow;if(!n)return;let r=0;const o=s.options.useScrollendEvent&&ee?()=>{}:Ot(n,()=>{i(r,!1)},s.options.isScrollingResetDelay),l=d=>()=>{const{horizontal:m,isRtl:f}=s.options;r=m?t.scrollLeft*(f&&-1||1):t.scrollTop,o(),i(r,d)},a=l(!0),c=l(!1);c(),t.addEventListener("scroll",a,Z);const u=s.options.useScrollendEvent&&ee;return u&&t.addEventListener("scrollend",c,Z),()=>{t.removeEventListener("scroll",a),u&&t.removeEventListener("scrollend",c)}},Dt=(s,i,t)=>{if(i!=null&&i.borderBoxSize){const n=i.borderBoxSize[0];if(n)return Math.round(n[t.options.horizontal?"inlineSize":"blockSize"])}return s[t.options.horizontal?"offsetWidth":"offsetHeight"]},Tt=(s,{adjustments:i=0,behavior:t},n)=>{var r,o;const l=s+i;(o=(r=n.scrollElement)==null?void 0:r.scrollTo)==null||o.call(r,{[n.options.horizontal?"left":"top"]:l,behavior:t})};class Bt{constructor(i){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let t=null;const n=()=>t||(!this.targetWindow||!this.targetWindow.ResizeObserver?null:t=new this.targetWindow.ResizeObserver(r=>{r.forEach(o=>{const l=()=>{this._measureElement(o.target,o)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(l):l()})}));return{disconnect:()=>{var r;(r=n())==null||r.disconnect(),t=null},observe:r=>{var o;return(o=n())==null?void 0:o.observe(r,{box:"border-box"})},unobserve:r=>{var o;return(o=n())==null?void 0:o.unobserve(r)}}})(),this.range=null,this.setOptions=t=>{Object.entries(t).forEach(([n,r])=>{typeof r>"u"&&delete t[n]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:$t,rangeExtractor:Mt,onChange:()=>{},measureElement:Dt,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...t}},this.notify=t=>{var n,r;(r=(n=this.options).onChange)==null||r.call(n,this,t)},this.maybeNotify=D(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),t=>{this.notify(t)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(t=>t()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var t;const n=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==n){if(this.cleanup(),!n){this.maybeNotify();return}this.scrollElement=n,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=((t=this.scrollElement)==null?void 0:t.window)??null,this.elementsCache.forEach(r=>{this.observer.observe(r)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,r=>{this.scrollRect=r,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(r,o)=>{this.scrollAdjustments=0,this.scrollDirection=o?this.getScrollOffset()<r?"forward":"backward":null,this.scrollOffset=r,this.isScrolling=o,this.maybeNotify()}))}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??(typeof this.options.initialOffset=="function"?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(t,n)=>{const r=new Map,o=new Map;for(let l=n-1;l>=0;l--){const a=t[l];if(r.has(a.lane))continue;const c=o.get(a.lane);if(c==null||a.end>c.end?o.set(a.lane,a):a.end<c.end&&r.set(a.lane,!0),r.size===this.options.lanes)break}return o.size===this.options.lanes?Array.from(o.values()).sort((l,a)=>l.end===a.end?l.index-a.index:l.end-a.end)[0]:void 0},this.getMeasurementOptions=D(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(t,n,r,o,l)=>(this.pendingMeasuredCacheIndexes=[],{count:t,paddingStart:n,scrollMargin:r,getItemKey:o,enabled:l}),{key:!1}),this.getMeasurements=D(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:t,paddingStart:n,scrollMargin:r,getItemKey:o,enabled:l},a)=>{if(!l)return this.measurementsCache=[],this.itemSizeCache.clear(),[];this.measurementsCache.length===0&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(d=>{this.itemSizeCache.set(d.key,d.size)}));const c=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];const u=this.measurementsCache.slice(0,c);for(let d=c;d<t;d++){const m=o(d),f=this.options.lanes===1?u[d-1]:this.getFurthestMeasurement(u,d),x=f?f.end+this.options.gap:n+r,p=a.get(m),b=typeof p=="number"?p:this.options.estimateSize(d),y=x+b,v=f?f.lane:d%this.options.lanes;u[d]={index:d,start:x,size:b,end:y,key:m,lane:v}}return this.measurementsCache=u,u},{key:!1,debug:()=>this.options.debug}),this.calculateRange=D(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(t,n,r,o)=>this.range=t.length>0&&n>0?Nt({measurements:t,outerSize:n,scrollOffset:r,lanes:o}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=D(()=>{let t=null,n=null;const r=this.calculateRange();return r&&(t=r.startIndex,n=r.endIndex),this.maybeNotify.updateDeps([this.isScrolling,t,n]),[this.options.rangeExtractor,this.options.overscan,this.options.count,t,n]},(t,n,r,o,l)=>o===null||l===null?[]:t({startIndex:o,endIndex:l,overscan:n,count:r}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=t=>{const n=this.options.indexAttribute,r=t.getAttribute(n);return r?parseInt(r,10):(console.warn(`Missing attribute name '${n}={index}' on measured element.`),-1)},this._measureElement=(t,n)=>{const r=this.indexFromElement(t),o=this.measurementsCache[r];if(!o)return;const l=o.key,a=this.elementsCache.get(l);a!==t&&(a&&this.observer.unobserve(a),this.observer.observe(t),this.elementsCache.set(l,t)),t.isConnected&&this.resizeItem(r,this.options.measureElement(t,n,this))},this.resizeItem=(t,n)=>{const r=this.measurementsCache[t];if(!r)return;const o=this.itemSizeCache.get(r.key)??r.size,l=n-o;l!==0&&((this.shouldAdjustScrollPositionOnItemSizeChange!==void 0?this.shouldAdjustScrollPositionOnItemSizeChange(r,l,this):r.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=l,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(r.index),this.itemSizeCache=new Map(this.itemSizeCache.set(r.key,n)),this.notify(!1))},this.measureElement=t=>{if(!t){this.elementsCache.forEach((n,r)=>{n.isConnected||(this.observer.unobserve(n),this.elementsCache.delete(r))});return}this._measureElement(t,void 0)},this.getVirtualItems=D(()=>[this.getVirtualIndexes(),this.getMeasurements()],(t,n)=>{const r=[];for(let o=0,l=t.length;o<l;o++){const a=t[o],c=n[a];r.push(c)}return r},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=t=>{const n=this.getMeasurements();if(n.length!==0)return X(n[pe(0,n.length-1,r=>X(n[r]).start,t)])},this.getOffsetForAlignment=(t,n,r=0)=>{const o=this.getSize(),l=this.getScrollOffset();n==="auto"&&(n=t>=l+o?"end":"start"),n==="center"?t+=(r-o)/2:n==="end"&&(t-=o);const a=this.getTotalSize()+this.options.scrollMargin-o;return Math.max(Math.min(a,t),0)},this.getOffsetForIndex=(t,n="auto")=>{t=Math.max(0,Math.min(t,this.options.count-1));const r=this.measurementsCache[t];if(!r)return;const o=this.getSize(),l=this.getScrollOffset();if(n==="auto")if(r.end>=l+o-this.options.scrollPaddingEnd)n="end";else if(r.start<=l+this.options.scrollPaddingStart)n="start";else return[l,n];const a=n==="end"?r.end+this.options.scrollPaddingEnd:r.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(a,n,r.size),n]},this.isDynamicMode=()=>this.elementsCache.size>0,this.scrollToOffset=(t,{align:n="start",behavior:r}={})=>{r==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getOffsetForAlignment(t,n),{adjustments:void 0,behavior:r})},this.scrollToIndex=(t,{align:n="auto",behavior:r}={})=>{r==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),t=Math.max(0,Math.min(t,this.options.count-1));let o=0;const l=10,a=u=>{if(!this.targetWindow)return;const d=this.getOffsetForIndex(t,u);if(!d){console.warn("Failed to get offset for index:",t);return}const[m,f]=d;this._scrollToOffset(m,{adjustments:void 0,behavior:r}),this.targetWindow.requestAnimationFrame(()=>{const x=this.getScrollOffset(),p=this.getOffsetForIndex(t,f);if(!p){console.warn("Failed to get offset for index:",t);return}zt(p[0],x)||c(f)})},c=u=>{this.targetWindow&&(o++,o<l?this.targetWindow.requestAnimationFrame(()=>a(u)):console.warn(`Failed to scroll to index ${t} after ${l} attempts.`))};a(n)},this.scrollBy=(t,{behavior:n}={})=>{n==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getScrollOffset()+t,{adjustments:void 0,behavior:n})},this.getTotalSize=()=>{var t;const n=this.getMeasurements();let r;if(n.length===0)r=this.options.paddingStart;else if(this.options.lanes===1)r=((t=n[n.length-1])==null?void 0:t.end)??0;else{const o=Array(this.options.lanes).fill(null);let l=n.length-1;for(;l>=0&&o.some(a=>a===null);){const a=n[l];o[a.lane]===null&&(o[a.lane]=a.end),l--}r=Math.max(...o.filter(a=>a!==null))}return Math.max(r-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(t,{adjustments:n,behavior:r})=>{this.options.scrollToFn(t,{behavior:r,adjustments:n},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(i)}}const pe=(s,i,t,n)=>{for(;s<=i;){const r=(s+i)/2|0,o=t(r);if(o<n)s=r+1;else if(o>n)i=r-1;else return r}return s>0?s-1:0};function Nt({measurements:s,outerSize:i,scrollOffset:t,lanes:n}){const r=s.length-1,o=c=>s[c].start;if(s.length<=n)return{startIndex:0,endIndex:r};let l=pe(0,r,o,t),a=l;if(n===1)for(;a<r&&s[a].end<t+i;)a++;else if(n>1){const c=Array(n).fill(0);for(;a<r&&c.some(d=>d<t+i);){const d=s[a];c[d.lane]=d.end,a++}const u=Array(n).fill(t+i);for(;l>=0&&u.some(d=>d>=t);){const d=s[l];u[d.lane]=d.start,l--}l=Math.max(0,l-l%n),a=Math.min(r,a+(n-1-a%n))}return{startIndex:l,endIndex:a}}const te=typeof document<"u"?h.useLayoutEffect:h.useEffect;function Pt(s){const i=h.useReducer(()=>({}),{})[1],t={...s,onChange:(r,o)=>{var l;o?Ge.flushSync(i):i(),(l=s.onChange)==null||l.call(s,r,o)}},[n]=h.useState(()=>new Bt(t));return n.setOptions(t),te(()=>n._didMount(),[]),te(()=>n._willUpdate()),n}function Lt(s){return Pt({observeElementRect:At,observeElementOffset:kt,scrollToFn:Tt,...s})}const{Text:se}=P,Vt=({file_path:s})=>{var u;h.useEffect(()=>{console.log("fileKey",s),s&&o(s)},[s]);const{messageApi:i}=B(),t=h.useRef(0),[n,r]=h.useState([]),o=async(d,m=!1)=>{const f=await Ft(d);t.current=f.data.offset,r(f.data.content),m&&i.success(`日志加载成功: ${d}`)},l=h.useRef(null),a=Lt({count:n.length,getScrollElement:()=>l.current,estimateSize:()=>30,overscan:10});h.useEffect(()=>{(n==null?void 0:n.length)>0&&a.scrollToIndex(n.length-1,{align:"end",behavior:"smooth"})},[n==null?void 0:n.length]);const c=a.getVirtualItems();return e.jsx(le,{size:"small",extra:e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>{o(s)},children:"刷新日志"}),title:e.jsxs(A,{gap:"small",wrap:"wrap",children:[e.jsxs(O,{color:"blue",children:["文件: ",s]}),e.jsxs(O,{color:"purple",children:["偏移量: ",t.current]})]}),bodyStyle:{padding:0},children:e.jsx("div",{ref:l,style:{height:400,overflowY:"auto",fontFamily:"monospace",backgroundColor:"#1e1e1e",color:"#d4d4d4",padding:"0 12px"},children:e.jsx("div",{style:{height:a.getTotalSize(),width:"100%",position:"relative"},children:e.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${((u=c[0])==null?void 0:u.start)??0}px)`},children:c.map(d=>e.jsx("div",{"data-index":d.index,ref:a.measureElement,style:{padding:"4px 0",borderBottom:"1px solid #333"},children:e.jsxs(A,{gap:"middle",children:[e.jsxs(se,{type:"secondary",style:{width:60,color:"#d4d4d4"},children:["#",d.index+1]}),e.jsx(se,{style:{whiteSpace:"pre-wrap",color:"#d4d4d4"},children:n[d.index]})]})},d.key))})})})})},Wt=({visible:s,onClose:i,params:t})=>e.jsx(oe,{footer:null,title:"参数",width:"50%",open:s,onCancel:i,children:e.jsx(P,{children:e.jsx("pre",{children:JSON.stringify(t,null,2)})})}),Rt=({formJson:s,openModal:i})=>{if(!s)return null;const[t,n]=h.useState([]),r=async()=>{const o=s.map(c=>c.dataKey),a=((await E.post("/list-bio-database",{type_list:o})).data||[]).reduce((c,u)=>{const d=u.type;c[d]||(c[d]=[]);const{name:m,database_id:f,...x}=u;return c[d].push({label:m,value:f,...x}),c},{});n(a),console.log(a)};return h.useEffect(()=>{r()},[s]),e.jsx(e.Fragment,{children:e.jsxs(A,{gap:"small",children:[e.jsx("div",{style:{flex:1},children:e.jsx(H,{formJson:s,dataMap:t})}),e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:i,children:"配置数据库"}),e.jsx(F,{onClick:r,size:"small",type:"primary",children:"刷新"})]})})},Gt=({visible:s,onClose:i,params:t,callback:n})=>{if(!s)return null;const[r,o]=h.useState([]),[l,a]=h.useState(!1),[c]=j.useForm(),[u,d]=h.useState(t[0].dataKey),[m,f]=h.useState(null),x=async g=>{a(!0);const I=await E.post("/list-bio-database",g);o(I.data),a(!1)},p=async()=>({...await c.validateFields(),type:u}),b=async()=>{const g=await p();m?await E.post("/update-bio-database",{...g,database_id:m.database_id}):await E.post("/add-bio-database",g),y(),f(void 0),c.resetFields()},y=()=>{x({type:u})};h.useEffect(()=>{x({type:u})},[t]);const v=g=>{d(g),x({type:g})},S=async g=>{await E.delete(`/delete-bio-database/${g.id}`),y()},w=g=>{c.setFieldsValue(g),f(g)};return e.jsxs(oe,{title:"数据库操作",open:s,onCancel:i,width:"50%",footer:null,children:[e.jsx(de,{tabBarExtraContent:e.jsxs(e.Fragment,{children:[e.jsx(F,{size:"small",color:"cyan",variant:"solid",style:{marginRight:"0.5rem"},type:"primary",onClick:y,children:" 刷新"}),e.jsxs(F,{size:"small",color:"cyan",variant:"solid",type:"primary",onClick:()=>{f(void 0),b()},children:[" ",m?"更新":"添加"]})]}),activeKey:u,onChange:v,items:t.map(g=>({key:g.name,label:g.label,children:e.jsx("div",{})}))}),e.jsxs(j,{form:c,style:{maxWidth:600},labelCol:{span:3},children:[e.jsx(j.Item,{name:"name",label:"名称",rules:[{required:!0,message:"请输入名称"}],children:e.jsx(T,{})}),e.jsx(j.Item,{name:"path",label:"路径",rules:[{required:!0,message:"请输入路径"}],children:e.jsx(T,{})}),e.jsx(j.Item,{name:"db_index",label:"索引",children:e.jsx(T,{})})]}),e.jsx(ue,{dataSource:r,columns:[{title:"名称",dataIndex:"name",key:"name"},{title:"数据库ID",dataIndex:"database_id",key:"database_id"},{title:"类型",dataIndex:"type",key:"type"},{title:"路径",dataIndex:"path",key:"path"},{title:"索引",dataIndex:"db_index",key:"db_index"},{title:"操作",dataIndex:"action",key:"action",ellipsis:!0,render:(g,I)=>e.jsxs(A,{gap:"small",children:[e.jsx(R,{title:"确定删除吗？",onConfirm:()=>{S(I)},children:e.jsx(F,{size:"small",type:"primary",danger:!0,children:"删除"})}),e.jsx(F,{size:"small",type:"primary",onClick:()=>{w(I)},children:"编辑"})]})}],loading:l,pagination:!1})]})},Ht=({visible:s,params:i,onClose:t,callback:n})=>{var y,v,S;const[r]=j.useForm(),{messageApi:o,project:l}=B();h.useEffect(()=>{s&&p()},[i]);const[a,c]=h.useState(),[u,d]=h.useState(),m=()=>{t(),n&&n()},[f,x]=h.useState(),p=async()=>{x(!0);const w=await E.post(`/analysis/edit-params/${i}`);c(w.data),d(w.data.analysis_result),r.resetFields(),r.setFieldsValue(w.data.request_param),x(!1)},b=w=>{if(w&&Object.keys(w).length>0)return Object.keys(w)[0]};return e.jsx(e.Fragment,{children:e.jsx(et,{size:"default",loading:f,title:e.jsx(e.Fragment,{children:a&&e.jsxs(e.Fragment,{children:[e.jsx(O,{children:a==null?void 0:a.component_name}),e.jsx(O,{children:a==null?void 0:a.analysis_name}),e.jsx(O,{children:String(a==null?void 0:a.analysis_id).slice(0,8)})]})}),width:"50%",open:s,onClose:t,children:a&&e.jsx(e.Fragment,{children:e.jsx(Kt,{form:r,requestParam:{...a.request_param,analysis_id:a==null?void 0:a.analysis_id},dataMap:{...u,first_data_key:b(u)},formJson:[...((y=a.content)==null?void 0:y.formJson)||[],...((v=a.content)==null?void 0:v.upstreamFormJson)||[],...(a==null?void 0:a.inputFormJson)||[]],databases:(S=a.content)==null?void 0:S.databases,upstreamFormJson:a==null?void 0:a.upstreamFormJson,callback:m})})})})},Kt=({form:s,requestParam:i,dataMap:t,formJson:n,databases:r,callback:o,showCancal:l=!1})=>{const{modals:a,openModals:c,closeModals:u}=ie(["paramsView","bioDatabases"]),[d,m]=h.useState([]),[f,x]=h.useState([]),{messageApi:p,projectList:b,project:y}=B();h.useEffect(()=>{v()},[JSON.stringify(n)]);const v=()=>{if(Array.isArray(n)){const g=n.filter(C=>!(C!=null&&C.required)&&!(C!=null&&C.db)&&!C.component_id),I=n.filter(C=>(C==null?void 0:C.required)||(C==null?void 0:C.db)||C.component_id);m(I),x(g)}},S=g=>({...i,...g}),w=async(g,I=!1)=>{var L;const C=await s.validateFields(),$=S(C);try{const _=await E.post(`/fast-api/analysis-controller?save=${g}&is_submit=${I}`,$);console.log(_),g?(p.success("执行成功!"),o&&o()):c("paramsView",_.data)}catch(_){console.log(_),(L=_.response)!=null&&L.data&&p.error(_.response.data.detail)}};return e.jsxs(e.Fragment,{children:[e.jsxs(j,{form:s,onValuesChange:(g,I)=>{},children:[e.jsx(de,{items:[{key:"1",label:"必填参数",forceRender:!0,children:e.jsxs(e.Fragment,{children:[e.jsx(H,{formJson:[...d],dataMap:t}),r&&e.jsx(Rt,{openModal:()=>{c("bioDatabases",r)},formJson:r})]})},{key:"2",label:"可选参数",forceRender:!0,children:e.jsx(e.Fragment,{children:e.jsx(H,{formJson:[...f],dataMap:{}})})}]}),e.jsx(j.Item,{label:"分析名称",name:"analysis_name",style:{maxWidth:600},rules:[{required:!0,message:"该字段不能为空!"}],children:e.jsx(T,{})}),e.jsxs(A,{gap:"small",children:[e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>{w(!1)},children:"查看参数"}),e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>w(!0),children:i!=null&&i.analysis_id?e.jsxs(e.Fragment,{children:["更新分析(",i.analysis_name,")(",String(i.analysis_id).slice(0,8),")"]}):e.jsx(e.Fragment,{children:"保存分析"})}),(i==null?void 0:i.analysis_id)&&l&&e.jsx(F,{size:"small",color:"cyan",onClick:()=>s.setFieldValue("analysis_id",void 0),children:"取消更新"})]}),e.jsx(He,{ghost:!0,items:[{key:"1",label:"更多",children:e.jsx(e.Fragment,{children:e.jsx(j.Item,{noStyle:!0,shouldUpdate:!0,children:()=>e.jsx(P,{children:e.jsx("pre",{children:JSON.stringify(S(s.getFieldsValue()),null,2)})})})})}]})]}),e.jsx(Wt,{visible:a.paramsView.visible,onClose:()=>u("paramsView"),params:a.paramsView.params}),e.jsx(Gt,{visible:a.bioDatabases.visible,onClose:()=>u("bioDatabases"),params:a.bioDatabases.params})]})},Jt=({data:s,url:i,filename:t})=>{const{Search:n}=T,[r,o]=h.useState([]),l=a=>a?Object.keys(a).map(c=>({title:c,dataIndex:c,key:c,ellipsis:!0,width:150})):[];return h.useEffect(()=>{if(s){const a=s.map((c,u)=>({...c,key:u}));o(a)}},[s]),e.jsx(e.Fragment,{children:Array.isArray(r)&&e.jsx(e.Fragment,{children:e.jsx(ue,{size:"small",title:()=>e.jsxs(A,{gap:"small",children:[e.jsx(n,{size:"small",placeholder:"input search text",allowClear:!0,onSearch:a=>{const c=s.filter(u=>Object.values(u).some(d=>typeof d=="string"&&d.includes(a)));o(c)},style:{width:304}}),i&&e.jsx(ae,{title:`${window.location.origin}${i}`,children:e.jsx(F,{size:"small",onClick:()=>{window.open(`${i}?t=${Date.now()}`,"_blank")},type:"primary",children:"下载"})}),e.jsx("span",{children:t})]}),scroll:{x:"max-content",y:55*5},dataSource:r,pagination:!1,virtual:!0,columns:l(s[0]),footer:()=>`一共${s.length}条记录`})})})},ne=({data:s,url:i,filename:t})=>e.jsx("div",{children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx(nt,{src:t!=null&&t.endsWith("pdf")?s:`${s}?t=${Date.now()}`,style:{maxWidth:"20rem",marginRight:"0.5rem"}}),i&&e.jsxs("div",{children:[e.jsx(ae,{title:`${window.location.origin}${i}`,children:e.jsx(F,{size:"small",onClick:()=>{window.open(`${i}?t=${Date.now()}`,"_blank")},type:"primary",children:"下载"})}),t]})]})}),{Paragraph:ys}=P,Ut=({data:s})=>e.jsx(e.Fragment,{children:e.jsx(ce,{value:s})}),qt=({data:s})=>e.jsx("div",{style:{padding:"1rem"},children:e.jsx(me,{closable:!0,message:s,type:"info",showIcon:!0})}),Yt=({data:s})=>e.jsx(e.Fragment,{children:e.jsx(P,{children:e.jsx("pre",{style:{margin:0},children:s})})}),Xt=({data:s})=>e.jsx(e.Fragment,{children:e.jsx(ce,{value:s,defaultLanguage:"json"})}),Qt=({data:s})=>e.jsx(e.Fragment,{children:s&&s.startsWith("/brave")?e.jsx(e.Fragment,{children:e.jsx("iframe",{src:s,width:"100%",style:{height:"80vh",border:"none"}})}):e.jsx(e.Fragment,{children:s})}),Zt={table:Jt,string:Ut,html:Qt,json:Xt,text:Yt,info:qt},es=({type:s,...i})=>{const t=Zt[s]||(()=>e.jsxs("div",{children:["未知类型 ",s]}));return e.jsx(t,{...i})},bs=h.forwardRef(({params:s,visible:i,onClose:t},n)=>{const{output_dir:r,analysis_id:o}=s||{};return i?e.jsx(e.Fragment,{children:o&&e.jsx(ts,{onClose:t,analysis_id:o})}):null}),ts=({analysis_id:s,onClose:i,cancalReportCallback:t})=>{var S,w;const[n,r]=h.useState(!1),[o,l]=h.useState(null),a=Ke(),{eventSourceRef:c,status:u,reconnect:d}=Je(),m=h.useRef(null),f=h.useRef(null),{messageApi:x}=B(),{modals:p,openModals:b,closeModals:y}=ie(["editParams"]),v=async g=>{r(!0);const I=await E.get(`/analysis/visualization-results/${g}`);l(I.data),m.current=g,r(!1)};return h.useEffect(()=>{v(s)},[s]),h.useEffect(()=>{var g;if(c){const I=C=>{const $=JSON.parse(C.data);f.current=$,m.current==$.analysis_id&&($.event=="analysis_complete"||$.event=="analysis_failed"||$.event=="analysis_started")&&v(m.current)};return(g=c.current)==null||g.addEventListener("message",I),()=>{var C;console.log("removeEventListener"),(C=c.current)==null||C.removeEventListener("message",I)}}},[c.current]),e.jsx(e.Fragment,{children:e.jsxs(le,{size:"small",title:e.jsx(e.Fragment,{children:o?e.jsxs(e.Fragment,{children:[e.jsx(O,{style:{cursor:"pointer"},onClick:()=>{a(`/component/${o==null?void 0:o.component_type}/${o==null?void 0:o.component_id}`)},children:o==null?void 0:o.component_name}),e.jsx(O,{children:o==null?void 0:o.analysis_name}),e.jsx(O,{children:String(o==null?void 0:o.analysis_id).slice(0,8)}),e.jsx(O,{children:o==null?void 0:o.analysis_status}),m.current==((S=f.current)==null?void 0:S.analysis_id)&&e.jsxs(O,{children:[" ",e.jsx(e.Fragment,{children:(w=f.current)==null?void 0:w.event})]})]}):e.jsx(e.Fragment,{})}),extra:e.jsxs(A,{gap:"small",children:[i&&e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>i(),children:"关闭"}),o&&e.jsxs(e.Fragment,{children:[e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>{b("editParams",o.analysis_id)},children:"编辑参数"}),(o==null?void 0:o.analysis_status)=="running"?e.jsx(e.Fragment,{children:e.jsx(R,{title:"是否停止!",onConfirm:async()=>{await _t(o.analysis_id),x.success("停止成功")},children:e.jsx(F,{size:"small",color:"cyan",variant:"solid",children:"停止"})})}):e.jsx(e.Fragment,{children:e.jsx(R,{title:"是否运行!",onConfirm:async()=>{await Et(o.analysis_id,"job"),x.success("运行成功")},children:e.jsx(F,{size:"small",color:"cyan",variant:"solid",children:o.analysis_status=="created"?"运行":"重新运行"})})})]}),e.jsx(R,{title:o!=null&&o.is_report?"是否取消报告":"是否报告",onConfirm:async()=>{await E.post(`/analysis/update-report/${o==null?void 0:o.analysis_id}`),x.success("操作成功!"),l(null),t&&t()},children:e.jsx(F,{size:"small",color:"cyan",variant:"solid",children:o!=null&&o.is_report?"取消报告":"报告"})}),e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>v(s),children:"刷新"})]}),children:[(o==null?void 0:o.analysis_status)=="failed"?e.jsx("div",{style:{textAlign:"center"},children:e.jsx(Vt,{file_path:o==null?void 0:o.command_log_path})}):e.jsx(e.Fragment,{children:(o==null?void 0:o.analysis_status)=="running"&&(o==null?void 0:o.run_type)!="server"?e.jsx(Ue,{active:!0}):e.jsx(e.Fragment,{children:s&&e.jsx(ss,{analsyisResult:o,loading:n})})}),e.jsx(Ht,{callback:()=>v(s),visible:p.editParams.visible,params:p.editParams.params,onClose:()=>y("editParams")})]})})},ss=({analsyisResult:s,loading:i})=>e.jsxs(tt,{spinning:i,children:[s&&e.jsxs(e.Fragment,{children:[s.images&&e.jsx("div",{children:Array.isArray(s.images)?e.jsx(qe,{gutter:{xs:8,sm:16,md:24,lg:32},children:s.images.map((t,n)=>e.jsx(Ye,{span:4,children:e.jsx(ne,{...t})},n))}):e.jsx(e.Fragment,{children:e.jsx(ne,{...s.images})})}),s.tables&&Array.isArray(s.tables)&&e.jsx(e.Fragment,{children:s.tables.map((t,n)=>e.jsx(es,{...t},n))})]}),e.jsx(Xe,{data:s==null?void 0:s.description})]});export{bs as A,Gt as B,Kt as C,Ht as E,H as F,Vt as L,Wt as P,Rt as a,ps as b,es as c,ts as d,xs as f,Et as r,_t as s,gs as w};
