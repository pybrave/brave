import{r as n,z as le,_ as re,s as w,b as oe,v as ce,c as de,Z as ue,$ as pe,u as me,a as x,j as e,F as je,I as he,t as v,l as h,p as xe,B as u,P as p,a0 as ye,k as _e,d as P,M as fe,e as ge}from"./main-B2jPVJuc.js";import{P as ve}from"./index-Dc0kVygC.js";import{A as be,E as ke,s as Ce,r as we}from"./index-CFkosLO7.js";import{I as Se}from"./index-Dusr40e4.js";import{C as Fe}from"./index-01a6DBbv.js";import{F as Re,S as U,D as Ie}from"./Table-D1zuQkUf.js";import{R as Pe}from"./RedoOutlined-B2jLc-U5.js";var Ae={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M888 792H200V168c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v688c0 4.4 3.6 8 8 8h752c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM305.8 637.7c3.1 3.1 8.1 3.1 11.3 0l138.3-137.6L583 628.5c3.1 3.1 8.2 3.1 11.3 0l275.4-275.3c3.1-3.1 3.1-8.2 0-11.3l-39.6-39.6a8.03 8.03 0 00-11.3 0l-230 229.9L461.4 404a8.03 8.03 0 00-11.3 0L266.3 586.7a8.03 8.03 0 000 11.3l39.5 39.7z"}}]},name:"line-chart",theme:"outlined"},Le=function(i,y){return n.createElement(le,re({},i,{ref:y,icon:Ae}))},$e=n.forwardRef(Le);const Qe=n.forwardRef(({title:S,form:i,appendSampleColumns:y=[],setResultTableList:_,cleanDom:A,analysisType:L,setRecord:b,setTableLoading:F,setTabletData:f,shouldTrigger:$,columnsParamsALL:E,project:r,software:M,component_id:m,component_ids:G,operatePipeline:Me,editParams:ze},K)=>{n.useImperativeHandle(K,()=>({reload:l}));const[De,Z]=n.useState(),[Oe,q]=w.useMessage(),{modal:a,openModal:g,closeModal:d}=oe(),{modals:z,openModals:D,closeModals:Q}=ce(["inspectPanel"]),[Be,Ne]=n.useState(!1),O=de(),X=ue(),{eventSourceRef:k,status:Te,reconnect:We}=pe(),[o,Y]=n.useState([]),R=n.useRef([]),I=n.useRef(null),[ee,B]=n.useState(!0),[Je,se]=n.useState(),{containerURL:N}=me(t=>t.user);n.useEffect(()=>{if(o&&Array.isArray(o)&&o.length>0&&a.visible&&a.params){const t=o.find(s=>s.analysis_id==a.params.analysis_id);t&&se(t)}},[o,a.params]),n.useEffect(()=>{var t;if(k){const s=c=>{var H;const j=JSON.parse(c.data);console.log("analysisId",R.current),R.current.includes(j.analysis_id)?(j.event=="analysis_complete"||j.event=="analysis_failed"||j.event=="analysis_started")&&(l(),I.current&&((H=I.current)==null||H.relaod())):j.run_type=="retry"&&j.event=="container_pulled"&&l()};return(t=k.current)==null||t.addEventListener("message",s),()=>{var c;console.log("removeEventListener"),(c=k.current)==null||c.removeEventListener("message",s)}}},[k.current,r]);const te=t=>{b&&b(t),Z(t)},l=async()=>{B(!0);let t=await x.post("/list-analysis",{component_id:m,component_ids:G,project:r});_&&_(t.data),Y(t.data);const s=t.data.map(c=>c.analysis_id);R.current=s,B(!1)},ae=async t=>{await x.delete(`/fast-api/analysis/${t}`),w.success("successfully delete!"),l()},T=(t,s)=>a.params?t.analysis_id==a.params.analysis_id&&s==a.key:!1,W=async(t,s)=>{await we(t.analysis_id,s),w.success("run successfully"),l()},J=async(t,s)=>{await Ce(t.analysis_id,s),w.success("Stop Success"),l()};let ne=[{title:"Project Name",dataIndex:"project_name",key:"project_name",ellipsis:!0,render:(t,s)=>e.jsx(v,{title:s.project,children:e.jsx("span",{style:{cursor:"pointer"},children:t})})},{title:"Job Status",dataIndex:"job_status",key:"job_status",ellipsis:!0,render:t=>e.jsx(h,{color:t==="success"?"green":t==="failed"?"red":"blue",children:t})},{title:"Server Status",dataIndex:"server_status",key:"server_status",ellipsis:!0,render:t=>e.jsx(h,{color:t==="success"?"green":t==="failed"?"red":"blue",children:t})},{title:"Component Name",dataIndex:"component_name",key:"component_name",ellipsis:!0,render:(t,s)=>e.jsx(v,{title:s.component_id,children:e.jsx("span",{style:{cursor:"pointer"},children:t})})},{title:"Analysis Name",dataIndex:"analysis_name",key:"analysis_name",ellipsis:!0},{title:"Report",dataIndex:"is_report",key:"is_report",ellipsis:!0,render:(t,s)=>e.jsx(h,{color:t?"green":"blue",children:t?"Report":"NonReport"})},{title:"Analysis Id",dataIndex:"analysis_id",key:"analysis_id",ellipsis:!0,render:(t,s)=>e.jsx(xe,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsxs("li",{children:["analysis_id:",s.analysis_id]}),e.jsxs("li",{children:["analysis_name:",s.analysis_name]}),e.jsxs("li",{children:["pipeline_script:",s.pipeline_script]}),e.jsxs("li",{children:["work_dir:",s.work_dir]}),e.jsxs("li",{children:["output_dir:",s.output_dir]}),e.jsxs("li",{children:["command_log_path:",s.command_log_path]}),e.jsxs("li",{children:["trace_file:",s.trace_file]}),e.jsxs("li",{children:["executor_log_file:",s.executor_log_file]}),e.jsxs("li",{children:["workflow_log_file:",s.workflow_log_file]})]})}),children:e.jsxs("span",{style:{cursor:"pointer"},children:[" ",e.jsx("span",{style:{cursor:"pointer"},children:String(t).slice(0,8)})]})})},{title:"Container Name",dataIndex:"container_name",key:"container_name",ellipsis:!0,render:(t,s)=>e.jsxs(v,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsx("li",{children:s.container_image}),s.sub_container_image&&e.jsx("li",{children:s.sub_container_image})]})}),children:[e.jsx(h,{style:{cursor:"pointer"},children:t}),s.sub_container_name&&e.jsx(h,{style:{cursor:"pointer"},children:s.sub_container_name})]})},{title:"Image Status",dataIndex:"image_status",key:"image_status",ellipsis:!0,render:(t,s)=>e.jsx(v,{title:s.image_id,children:e.jsx(h,{color:"green",children:t})})},{title:"Action",key:"action",fixed:"right",ellipsis:!0,width:200,render:(t,s)=>e.jsxs(U,{size:"small",children:[e.jsx(u,{size:"small",color:"primary",variant:"solid",onClick:()=>O(`/analysis-report?key=${s==null?void 0:s.analysis_id}&project=${r}`),children:"Go Report"}),s.image_status=="exist"?e.jsx(e.Fragment,{children:s.job_status=="running"?e.jsx(e.Fragment,{children:e.jsx(p,{title:"Whether or not to stop?",onConfirm:()=>{J(s,"job")},children:e.jsx(u,{size:"small",color:"red",variant:"solid",children:"Stop Job"})})}):e.jsx(e.Fragment,{children:e.jsx(p,{title:"Whether or not to run?",onConfirm:()=>{W(s,"job"),g("modalA",s),te(s)},children:e.jsx(u,{size:"small",color:"cyan",variant:"solid",children:s.job_status=="created"?"Run":"Re-Run"})})})}):e.jsx(e.Fragment,{children:e.jsx(p,{title:"Pull?",onConfirm:async()=>{await x.post(`/container/pull-image/${s.container_id}`),l()},children:e.jsx(u,{size:"small",color:"cyan",variant:"solid",children:s.image_status=="pulling"?"pulling":"Pull"})})}),e.jsx(u,{size:"small",color:"cyan",variant:"solid",onClick:()=>g("editParams",s.analysis_id),children:"Edit Parameters"}),T(s,"modalA")?e.jsx(u,{size:"small",color:"cyan",variant:"solid",onClick:()=>{d()},children:"Close"}):e.jsx(u,{size:"small",color:"cyan",variant:"solid",onClick:()=>{g("modalA",s)},children:"View Results"}),e.jsx(Ie,{menu:{items:[{key:"server",label:e.jsx(e.Fragment,{children:s.image_status=="exist"&&e.jsx(e.Fragment,{children:s.server_status=="running"?e.jsx(e.Fragment,{children:e.jsx(p,{title:"Whether or not to stop?",onConfirm:()=>{J(s,"server")},children:e.jsx("a",{style:{color:"red"},children:"Stop Server"})})}):e.jsx(e.Fragment,{children:e.jsx(p,{title:"Whether to start the server?",onConfirm:()=>{W(s,"server")},children:e.jsx("a",{children:"Run Server"})})})})})},{key:"open_url",disabled:s.server_status!="running",label:e.jsx(e.Fragment,{children:e.jsx(v,{title:e.jsx(e.Fragment,{children:`${N}/container/${s.analysis_id}/`}),children:e.jsx("a",{onClick:()=>{window.open(`${N}/container/${s.analysis_id}/`,"_blank")},children:"Open URL"})})})},{key:"1",label:e.jsx(e.Fragment,{children:T(s,"modalB")?e.jsx("a",{onClick:()=>{d()},children:"Close"}):e.jsx("a",{onClick:()=>{g("modalB",s)},children:"Details"})})},{key:"inspect_job",disabled:s.job_status!="running",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:async()=>{D("inspectPanel",{inspect:"inspect",id:s.analysis_id,run_type:"job"})},children:"Inspect Job"})})},{key:"inspect_server",disabled:s.server_status!="running",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:async()=>{D("inspectPanel",{inspect:"inspect",id:s.analysis_id,run_type:"server"})},children:"Inspect Server"})})},{key:"3",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:()=>{O(`/software-analysis-editor/${s.analysis_id}`,{state:{location:X.pathname}})},children:"Edit"})})},{key:"4",label:e.jsxs(e.Fragment,{children:[" ",e.jsx(p,{title:"Delete or not?",onConfirm:async()=>{await ae(s.analysis_id),l()},children:e.jsx("a",{children:"Delete"})})]})},{key:"5",label:e.jsxs(e.Fragment,{children:[" ",e.jsx(p,{title:s.is_report?"Whether to cancel the report?":"Whether to the report?",onConfirm:async()=>{await x.post(`/analysis/update-report/${s.analysis_id}`),l()},children:s.is_report?"Cancel Report":"Report"})]})},{key:"6",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:()=>{g("addProject",s)},children:"Add Project"})})}]},children:e.jsx("a",{onClick:c=>c.preventDefault(),children:e.jsxs(U,{children:["More",e.jsx(ye,{})]})})})]})}];n.useEffect(()=>{d()},[r]),n.useEffect(()=>{l()},[r]);const[C,ie]=n.useState(""),V=n.useMemo(()=>C?o.filter(t=>Object.values(t).some(s=>String(s).toLowerCase().includes(C.toLowerCase()))):o,[o,C]);return e.jsxs(e.Fragment,{children:[q,e.jsx(Fe,{size:"small",variant:"borderless",style:{boxShadow:"none"},styles:{body:{padding:"0.5rem 0 0 0 "}},title:e.jsxs(e.Fragment,{children:[e.jsx($e,{}),"  Analysis Record"]}),extra:e.jsxs(je,{gap:"small",wrap:!0,children:[e.jsx(he.Search,{size:"small",placeholder:"搜索结果...",allowClear:!0,enterButton:!0,value:C,onChange:t=>ie(t.target.value),style:{width:300}}),e.jsx(Pe,{style:{cursor:"pointer"},onClick:l})]}),children:e.jsx(Re,{rowKey:"analysis_id",size:"small",pagination:!1,loading:ee,scroll:{x:"max-content",y:55*5},columns:ne,footer:()=>`A total of ${V.length} records`,dataSource:V})}),e.jsx("div",{style:{marginBottom:"1rem"}}),e.jsx(be,{visible:a.key=="modalA"&&a.visible,params:a.params,onClose:d}),e.jsx(ve,{ref:I,visible:a.key=="modalB"&&a.visible,params:a.params,onClose:d,callback:l}),e.jsx(ke,{callback:l,visible:a.key=="editParams"&&a.visible,params:a.params,onClose:d}),e.jsx(Ee,{callback:l,visible:a.key=="addProject"&&a.visible,params:a.params,onClose:d}),e.jsx(Se,{callback:l,visible:z.inspectPanel.visible,params:z.inspectPanel.params,onClose:()=>Q("inspectPanel")})]})}),Ee=({visible:S,params:i,onClose:y,callback:_})=>{const[A,L]=n.useState([]),{messageApi:b,project:F}=_e(),[f]=P.useForm(),$=async()=>{const M=(await x.get("/project/list-project")).data.map(m=>({label:`${m.project_name}`,value:m.project_id}));L(M.filter(m=>m.value!=F))};n.useEffect(()=>{$(),f.resetFields(),i!=null&&i.extra_project_ids&&f.setFieldValue("project",JSON.parse(i==null?void 0:i.extra_project_ids))},[F]);const E=async()=>{const r=await f.validateFields();await x.post(`/analysis/update-extra-project/${i==null?void 0:i.analysis_id}`,r),b.success("添加成功!"),_&&_()};return e.jsx(fe,{onOk:E,title:`添加项目(${i==null?void 0:i.analysis_name})`,open:S,onCancel:y,onClose:y,children:e.jsx(P,{form:f,children:e.jsx(P.Item,{name:"project",label:"项目",children:e.jsx(ge,{options:A,mode:"multiple"})})})})};export{Qe as R};
