import{r as i,z as ye,_ as Re,d as L,k as ue,u as De,j as e,F as E,B as g,I as A,E as ze,m as Te,i as oe,a as J,M as _e,$ as Ee,b as Ne,t as f,p as $e,P as K,a0 as Be,A as Le,l as Je,s as Oe,al as je}from"./main-Cq64AMgN.js";import{F as He}from"./index-CV_PF3zW.js";import{C as ge}from"./index-Dc_dGIGZ.js";import{S as qe}from"./index-D9Ce2rPi.js";import{F as fe,S as xe,D as We,b as Qe}from"./Table-DbGD-iom.js";import{A as Ve}from"./react-window-DpKRCTYM.js";import{T as Ge}from"./index-BN2NQmSZ.js";import{T as Ue}from"./index-D_LHLpHX.js";import{R as Xe}from"./RedoOutlined-BJVNqlNz.js";import{S as Ye}from"./index-YruvF9S2.js";var Ze={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M864 256H736v-80c0-35.3-28.7-64-64-64H352c-35.3 0-64 28.7-64 64v80H160c-17.7 0-32 14.3-32 32v32c0 4.4 3.6 8 8 8h60.4l24.7 523c1.6 34.1 29.8 61 63.9 61h454c34.2 0 62.3-26.8 63.9-61l24.7-523H888c4.4 0 8-3.6 8-8v-32c0-17.7-14.3-32-32-32zm-200 0H360v-72h304v72z"}}]},name:"delete",theme:"filled"},Pe=function(s,p){return i.createElement(ye,Re({},s,{ref:p,icon:Ze}))},Ke=i.forwardRef(Pe);const Ae=({parseData:t,columns:s,importData:p})=>e.jsx(fe,{size:"small",bordered:!0,pagination:!1,footer:()=>e.jsxs("div",{style:{textAlign:"right"},children:["A total of",t.length," records   ",e.jsx(g,{size:"small",color:"cyan",variant:"solid",onClick:p,children:"Ok"})]}),columns:s,dataSource:t}),se=({component_type:t,component_id:s,component_name:p,inputForm:c,operatePipeline:_,name:C,file_type:S,callback:M})=>{const[R]=L.useForm();console.log("-->ImportFile渲染");const{messageApi:D,project:ee}=ue(),[Q,r]=i.useState([]);De(d=>d.global.setting);const[F,N]=i.useState(!1),[O,le]=i.useState(),x=i.useRef(null);i.useEffect(()=>{if(c){let u=c.map(o=>Array.isArray(o.name)?o.name[1]:o.name).map(o=>({title:o,dataIndex:o,key:o,render:m=>e.jsx("span",{children:m})}));u=[{title:"Sample Name",dataIndex:"sample_name",key:"sample_name",render:o=>e.jsx("span",{children:o})},...u,{title:"Action",dataIndex:"action",key:"action",ellipsis:!0,render:(o,m)=>e.jsx(E,{gap:"small",children:e.jsx(g,{size:"small",danger:!0,onClick:()=>{H(m.sample_name)},children:"删除"})})}],console.log(u),x.current=u,le(u)}},[c]);const H=d=>{r(u=>u.filter(o=>o.sample_name!==d))},l=d=>{const{content:u,sample_name:o,file_name:m}=d;return F?Q.map(b=>{const{sample_name:w,...W}=b;return{...d,project:ee,component_id:s,file_type:S,content:JSON.stringify(W),sample_name:w}}):[{...d,project:ee,component_id:s,file_name:m,file_type:S,content:S&&S=="collected"?u:JSON.stringify(u),sample_name:o}]},q=async()=>{const d=await R.validateFields();if(d.length==0){D.error("No data added!");return}if(c&&c.length==0){D.error("This component does not have inputForm configured!");return}const u=l(d);try{const o=await J.post("/import-data",u);D.success("Imported successfully!"),M&&M()}catch(o){D.error(o.response.data.detail)}},V=async()=>{const d=await R.validateFields();if(c&&c.length==0){D.error("This component does not have inputForm configured!");return}const u=await J.post("/parse-import-data",{content:JSON.stringify(d.content)});console.log(u),r(u.data)};return i.useEffect(()=>{const d=u=>{var G;const o=((G=u.clipboardData)==null?void 0:G.getData("Text"))||"";if(!o)return;const m=o.includes("	")?"	":",",w=o.split(/\r?\n/).filter(I=>I.trim()!=="").map(I=>I.split(m).map(y=>y.trim()));console.log(w);const W=w.map(I=>{const y={};return x.current.forEach((z,ne)=>{I.length<=ne?y[z.dataIndex]="unknown":y[z.dataIndex]=I[ne]}),y});r(W),D.success("Paste successful!")};return document.addEventListener("paste",d),()=>{document.removeEventListener("paste",d)}},[]),e.jsx(e.Fragment,{children:e.jsx(ge,{variant:"borderless",size:"small",style:{boxShadow:"none"},title:`${p}(${s})`,extra:e.jsxs(E,{gap:"small",children:[e.jsx(qe,{value:F,onChange:d=>N(d)}),e.jsx(g,{size:"small",color:"cyan",variant:"solid",onClick:()=>{_.openModal("modalC",{data:{component_id:s},structure:{component_type:t}})},children:"Edit InputForm"}),e.jsx(g,{size:"small",color:"cyan",variant:"solid",disabled:!Q,onClick:()=>r([]),children:"Clear"}),e.jsx(g,{size:"small",color:"cyan",variant:"solid",disabled:!c,onClick:V,children:"Parse"})]}),children:e.jsxs(L,{form:R,children:[e.jsx(L.Item,{name:"sample_source",label:"Sample Source",rules:[{required:!0,message:"This field cannot be empty!"}],children:e.jsx(A,{placeholder:"gut,brain..."})}),!F&&e.jsx(e.Fragment,{children:S&&S=="collected"?e.jsx(L.Item,{name:"file_name",label:"File Name",rules:[{required:!0,message:"This field cannot be empty!"}],children:e.jsx(A,{})}):e.jsx(L.Item,{name:"sample_name",label:"Sample Name",rules:[{required:!0,message:"This field cannot be empty!"}],children:e.jsx(A,{})})}),c?e.jsx(e.Fragment,{children:e.jsx(He,{formJson:c,dataMap:{}})}):e.jsx(e.Fragment,{children:e.jsx(ze,{description:"This component does not have inputForm configured!",children:e.jsx(g,{color:"cyan",variant:"solid",onClick:()=>{_.openModal("modalC",{data:{component_id:s},structure:{component_type:t}})},children:"Config InputForm"})})}),F&&e.jsx(Ae,{parseData:Q,columns:O,importData:q}),!F&&e.jsx(g,{size:"small",color:"cyan",variant:"solid",onClick:q,children:"Ok"}),e.jsx(Te,{ghost:!0,items:[{key:"1",label:"More",children:e.jsx(e.Fragment,{children:e.jsx(L.Item,{noStyle:!0,shouldUpdate:!0,children:()=>e.jsx(oe,{children:e.jsx("pre",{children:JSON.stringify(l(R.getFieldsValue()),null,2)})})})})}]})]})})})},Me=({visible:t,onClose:s,params:p,callback:c})=>t?e.jsx(e.Fragment,{children:e.jsx(_e,{open:t,onClose:s,width:"80%",onCancel:s,title:"Import Data",footer:null,children:e.jsx(ll,{params:p,type:"inputFile",callback:()=>{s(),c&&c()}})})}):null,el=({params:t,type:s,callback:p})=>{if(!t)return e.jsx(e.Fragment,{children:"无数据"});if(t.component_type=="software"){if(t[s]&&Array.isArray(t[s])&&t[s].length>0)return t[s].map((c,_)=>i.createElement(se,{...c,operatePipeline:t.operatePipeline,key:_,callback:p}))}else{if(t.component_type=="pipeline")return e.jsx(se,{...t});if(t.component_type=="file")return e.jsx(se,{...t,callback:p})}},ll=i.memo(el),nl=i.forwardRef(({pipeline:t,software:s,title:p,form:c,appendSampleColumns:_=[],setResultTableList:C,cleanDom:S,analysisType:M,setRecord:R,setTableLoading:D,setTabletData:ee,shouldTrigger:Q,analysisMethod:r,columnsParamsALL:F,activeTabKey:N,setActiveTabKey:O,cardExtra:le,operatePipeline:x,relationType:H,currentAnalysisMethod:l,setCurrentAnalysisMethod:q,params:V,...d},u)=>{i.useImperativeHandle(u,()=>({reload:k}));const{project:o,projectObj:m}=ue(),[b,w]=i.useState([]),[W,G]=i.useState(),[I,y]=i.useState(!0),{eventSourceRef:z,status:ne,reconnect:sl}=Ee(),{modal:ae,openModal:he,closeModal:Ce}=Ne(),[ve,ie]=i.useState([]),[Se,U]=i.useState([]),[ke,te]=i.useState(!0),[$,X]=i.useState(),[re,Fe]=i.useState(200);i.useEffect(()=>{var a;if(!z)return;const n=j=>{const v=JSON.parse(j.data);if(v.msgType==="analysis_result"){const h=r.map(P=>P.component_id);console.log("componentIdList",h),console.log("data.component_id ",v.component_id),console.log(" componentIdList.includes(data.component_id) ",h.includes(v.component_id)),h.includes(v.component_id)&&k()}};return(a=z.current)==null||a.addEventListener("message",n),()=>{var j;console.log("removeEventListener"),(j=z.current)==null||j.removeEventListener("message",n)}},[z.current]);const k=()=>{if(console.log("analysisMethod: ",r),r&&Array.isArray(r)){const n=r.flatMap(a=>a.component_id);me({componentIdList:n})}else me({params:V})},ce=n=>r.reduce((v,h)=>(v[h==null?void 0:h.component_id]=h,v),{})[n];i.useEffect(()=>{var n,a;if(r&&Array.isArray(r)&&r.length>0&&O){O((n=r[0])==null?void 0:n.component_id);const j=ce((a=r[0])==null?void 0:a.component_id);q(j)}k()},[JSON.stringify(V),JSON.stringify(r),o,m==null?void 0:m.metadata_form]);const be=n=>{const a=W[n];w(a),O(n);const j=ce(n);q(j),a.length>0?(X(a[0].analysis_result_id),U(a[0].columns)):(U([]),X(void 0))},de=async()=>{if((l==null?void 0:l.file_type)=="collected"&&$){te(!0);const n=await J.get(`/analysis-result/table/${$}?row_num=${re}`,{timeout:2e4});ie(n.data),te(!1)}else ie([]),te(!1)};i.useEffect(()=>{de()},[$]);const me=async({analysisMethodValues:n,params:a,componentIdList:j})=>{var v,h;if(y(!0),j){const T=(await J.post("/analysis-result/list-analysis-result-grouped",{project:o,component_ids:j,...a})).data;console.log("groupedData",T),C&&C(T),G(T);let B;N?B=T[N]?T[N]:[]:B=T[(v=r[0])==null?void 0:v.component_id]?T[(h=r[0])==null?void 0:h.component_id]:[],w(B),B.length>0&&(X(B[0].analysis_result_id),U(B[0].columns))}else{let P=await J.post("/analysis-result/list-analysis-result",{project:o,component_ids:j,...a});w(P.data)}y(!1)},pe=async n=>{await J.delete(`/analyais-result/delete-by-id/${n}`),Oe.success("删除成功!"),k()};let we=[{title:"Project Name",dataIndex:"project_name",key:"project_name",width:100,ellipsis:!0,render:(n,a)=>e.jsx(f,{title:a.project,children:e.jsx("span",{style:{cursor:"pointer"},children:n})})},{title:"Analysis Result ID",dataIndex:"analysis_result_id",key:"analysis_result_id",width:50,ellipsis:!0,render:(n,a)=>e.jsx(f,{title:a.analysis_result_id,children:e.jsx("span",{style:{cursor:"pointer"},children:String(n).slice(0,8)})})},{title:"Analysis Id",dataIndex:"analysis_id",key:"analysis_id",width:50,ellipsis:!0,render:(n,a)=>e.jsx(f,{title:a.analysis_id,children:e.jsx("span",{style:{cursor:"pointer"},children:n?String(n).slice(0,8):""})})},{title:"Component Name",dataIndex:"component_name",key:"component_name",width:100,ellipsis:!0,render:(n,a)=>e.jsx(f,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsxs("li",{children:["analysis_id: ",a.analysis_id]}),e.jsxs("li",{children:["component_id: ",a.component_id]}),e.jsxs("li",{children:["analysis_result_id: ",a.analysis_result_id]}),e.jsxs("li",{children:["sample_id: ",a.sample_id]}),e.jsxs("li",{children:["file_name: ",a.file_name]}),e.jsxs("li",{children:["analysis_result_hash: ",a.analysis_result_hash]})]})}),children:e.jsx("span",{style:{cursor:"pointer"},children:n})})},{title:"Sample Name",dataIndex:"sample_name",key:"sample_name",width:100,ellipsis:!0,render:(n,a)=>e.jsx(f,{title:e.jsx(e.Fragment,{children:e.jsx("ul",{children:e.jsxs("li",{children:["sample_id: ",a.sample_id]})})}),children:e.jsx("span",{style:{cursor:"pointer"},children:n})})},{title:"Sample Source",dataIndex:"sample_source",key:"sample_source",width:100,ellipsis:!0},...(()=>{var n;return!(m!=null&&m.metadata_form)||!Array.isArray(m==null?void 0:m.metadata_form)?[]:(n=m==null?void 0:m.metadata_form)==null?void 0:n.map(a=>({title:a.label,dataIndex:a.name,key:a.name,ellipsis:!0}))})(),..._,{title:"Action",key:"action",fixed:"right",ellipsis:!0,width:200,render:(n,a)=>e.jsxs(xe,{size:"middle",children:[e.jsx($e,{content:e.jsx(e.Fragment,{children:e.jsx(oe,{children:e.jsx("pre",{children:JSON.stringify(a.content,null,2)})})}),children:e.jsx(g,{size:"small",color:"cyan",variant:"solid",onClick:()=>{R&&R(a),x.openModal("openFile",{content:a.content,fileType:a.file_type,description:l.description})},children:"Open"})}),a.sample_name?e.jsx(e.Fragment,{children:e.jsx(g,{size:"small",color:"cyan",variant:"solid",onClick:()=>{x.openModal("metadataForm",{analysis_result_id:a.analysis_result_id,sample_id:a.sample_id,callback:k})},children:"metadata"})}):e.jsx(e.Fragment,{children:e.jsx(g,{size:"small",color:"cyan",variant:"solid",onClick:()=>{x.openModal("metadataForm",{analysis_result_id:a.analysis_result_id,callback:k})},children:"Add Metadata"})}),e.jsx(g,{size:"small",color:"cyan",variant:"solid",onClick:()=>{console.log(x),x.openModals("bindSample",{analysis_result_id:a.analysis_result_id,callback:k})},children:"Bind Sample "}),e.jsx(K,{title:"Are you sure you want to delete it?",onConfirm:async()=>{await pe(a.analysis_result_id)},children:e.jsx(g,{size:"small",color:"danger",variant:"solid",children:"Delete"})})]})}];const[Y,Ie]=i.useState(""),Z=i.useMemo(()=>Y?b.filter(n=>Object.values(n).some(a=>String(a).toLowerCase().includes(Y.toLowerCase()))):b,[b,Y]);return e.jsxs(e.Fragment,{children:[e.jsxs(ge,{size:"small",variant:"borderless",style:{boxShadow:"none"},styles:{body:{padding:"0.5rem"}},title:e.jsxs(E,{gap:"small",children:[e.jsx(Qe,{})," ",p,(l==null?void 0:l.component_name)&&e.jsx(f,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsxs("li",{children:["namespace: ",l==null?void 0:l.namespace_name]}),(t==null?void 0:t.component_id)&&e.jsxs("li",{children:["pipeline: ",t==null?void 0:t.component_id]}),(s==null?void 0:s.component_id)&&e.jsxs("li",{children:["software: ",s==null?void 0:s.component_id]}),(l==null?void 0:l.component_id)&&e.jsxs("li",{children:["file: ",l==null?void 0:l.component_id]}),(l==null?void 0:l.name)&&e.jsxs("li",{children:["name: ",l==null?void 0:l.name]})]})}),children:e.jsxs("span",{style:{cursor:"pointer"},children:["(",l==null?void 0:l.component_name,")"]})}),e.jsx(Je,{color:"success",children:l==null?void 0:l.file_type})]}),extra:e.jsxs(e.Fragment,{children:[le,e.jsxs(E,{gap:"small",wrap:!0,children:[e.jsx(A.Search,{size:"small",placeholder:"搜索结果...",allowClear:!0,enterButton:!0,value:Y,onChange:n=>Ie(n.target.value),style:{width:300}}),(l==null?void 0:l.relation_id)&&e.jsx(K,{title:"Are you sure to delete?",onConfirm:()=>{x.deletePipelineRelation(l.relation_id)},children:e.jsxs(g,{size:"small",color:"danger",variant:"solid",children:["Delete ",l==null?void 0:l.component_name]})}),(x==null?void 0:x.openModal)&&e.jsxs(e.Fragment,{children:[e.jsx(g,{size:"small",color:"cyan",variant:"solid",onClick:()=>{he("importFile",{...l,operatePipeline:x})},children:"Import data "}),e.jsx(g,{size:"small",color:"cyan",variant:"solid",onClick:k,children:"Refresh"}),(d.component_type=="software"||d.component_type=="file")&&e.jsx(e.Fragment,{children:e.jsx(We,{menu:{items:[{key:"4",label:e.jsx(f,{title:l==null?void 0:l.component_name,children:e.jsx("a",{onClick:()=>{x.openModal("modalC",{data:void 0,structure:{relation_type:H,parent_component_id:s.component_id,component_type:"file"}})},children:"Add File"})})},{key:"3",label:e.jsx(f,{title:l==null?void 0:l.component_name,children:e.jsx("a",{onClick:()=>{x.openModal("modalC",{data:l,structure:{component_type:"file"}})},children:"Edit File"})})},{key:"2",label:e.jsx(f,{title:l==null?void 0:l.component_name,children:e.jsx("a",{onClick:()=>{x.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:H,parent_component_id:s.component_id}})},children:"New File"})})},{key:"1",label:e.jsx(f,{title:l==null?void 0:l.component_name,children:e.jsx("a",{onClick:()=>{x.openModal("modalA",{data:l,pipelineStructure:{relation_type:H}})},children:"Replace File"})})},{label:e.jsx(f,{title:l==null?void 0:l.component_name,children:e.jsx(K,{title:"Whether to remove file?",onConfirm:()=>{x.deletePipelineRelation(l.relation_id)},children:e.jsx("a",{children:"Remove File"})})}),key:"0"}]},children:e.jsx("a",{onClick:n=>n.preventDefault(),children:e.jsxs(xe,{children:["More",e.jsx(Be,{})]})})})})]}),e.jsx(Le,{onClick:()=>{x.openModal("descriptionModal",l.description)},style:{cursor:"pointer"}})]})]}),tabList:r&&Array.isArray(r)&&r.length>1?r.map(n=>({key:n.component_id,label:e.jsx(f,{title:n.component_id,children:n.component_name?n.component_name:"no_name"})})):void 0,activeTabKey:N,onTabChange:be,children:[(l==null?void 0:l.file_type)=="collected"?e.jsxs(e.Fragment,{children:[e.jsx(Ge,{activeKey:$,onChange:n=>{const a=b.filter(j=>j.analysis_result_id==n);a.length>0&&U(a[0].columns),X(n)},tabBarExtraContent:e.jsxs(E,{gap:"small",children:[e.jsx(Ue,{size:"small",value:re,onChange:n=>Fe(n)}),e.jsx(K,{title:`Are you sure you want to delete ${$}?`,onConfirm:async()=>{await pe($)},children:e.jsx(Ke,{style:{cursor:"pointer",color:"red"}})}),e.jsx(Xe,{style:{cursor:"pointer"},onClick:()=>de()})]}),items:b.map((n,a)=>({key:n.analysis_result_id,label:e.jsx(f,{title:`${n==null?void 0:n.content} ${n.analysis_result_id}`,children:`${n==null?void 0:n.file_name} (${n==null?void 0:n.sample_source})`})}))}),e.jsx(Ye,{spinning:ke,children:e.jsx("div",{style:{height:"50vh"},children:e.jsx(al,{rows:[Se.map(n=>n.columns_name),...ve]})})})]}):e.jsx(e.Fragment,{children:e.jsx(fe,{rowKey:n=>n.id,size:"small",pagination:{pageSize:10},loading:I,scroll:{x:"max-content",y:55*5},columns:F||we,footer:()=>`A total of ${Z&&Array.isArray(Z)&&Z.length} records`,dataSource:Z})}),(l==null?void 0:l.parseFormat)&&(l==null?void 0:l.relation_type)=="software_output_file"&&e.jsx(oe,{children:e.jsx("pre",{children:JSON.stringify(l.parseFormat,null,2)})})]}),e.jsx(Me,{visible:ae.visible&&ae.key=="importFile",params:ae.params,callback:k,onClose:Ce})]})}),gl=({visible:t,onClose:s,params:p})=>t?e.jsx(e.Fragment,{children:e.jsx(_e,{title:"分析结果",open:t,onCancel:s,width:"80%",children:e.jsx(nl,{...p,analysisType:"sample"})})}):null;function al({rows:t,columns:s}){const{token:p}=je.useToken();return e.jsxs(e.Fragment,{children:[s&&e.jsx(E,{align:"center",style:{background:p.colorBgContainerDisabled,borderBottom:`1px solid ${p.colorBorderSecondary}`,padding:"0 8px",fontWeight:500},children:Array.isArray(s)&&e.jsx(e.Fragment,{children:s.map((c,_)=>e.jsx("span",{children:e.jsx("div",{style:{flex:"0 0 200px",whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden",padding:"0 8px"},title:c.columns_name,children:e.jsx(f,{title:c.analysis_result_id,children:c.columns_name})},_)},_))})}),e.jsx(Ve,{rowComponent:tl,rowCount:t==null?void 0:t.length,rowHeight:30,rowProps:{rows:t}})]})}function tl({index:t,rows:s,style:p}){const c=s[t],{token:_}=je.useToken();return e.jsx(E,{align:"center",style:{...p,backgroundColor:t%2?_.colorBgContainer:_.colorFillQuaternary,borderBottom:`1px solid ${_.colorBorderSecondary}`,padding:"0 8px",fontSize:13,minWidth:"fit-content",transition:"background-color 0.2s"},className:"table-row",onMouseEnter:C=>{C.currentTarget.style.backgroundColor=_.colorFillTertiary},onMouseLeave:C=>{C.currentTarget.style.backgroundColor=t%2?_.colorBgContainer:_.colorFillQuaternary},children:c.map((C,S)=>e.jsx("div",{style:{flex:"0 0 200px",whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden",padding:"0 8px"},title:String(C),children:String(C)},S))})}export{gl as A,nl as R};
