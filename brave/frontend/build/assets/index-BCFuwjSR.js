import{r as x,d as sl,aq as il,a as Q,j as l,o as r,m as ol,B as o,c as U,P as W,I as tl,g as ml,w as dl,e as cl,M as rl}from"./index-sBAHO47Q.js";import{S as _l,F as pl,a as xl}from"./Table-DgCb1KGo.js";import{C as jl}from"./index-BGYi6o0L.js";const gl=x.forwardRef(({pipeline:_,software:m,title:z,form:fl,appendSampleColumns:X=[],setResultTableList:E,cleanDom:R,analysisType:ul,setRecord:h,setTableLoading:Cl,setTabletData:Sl,shouldTrigger:vl,analysisMethod:s,columnsParamsALL:J,activeTabKey:f,setActiveTabKey:I,cardExtra:Y,operatePipeline:i,relationType:D,currentAnalysisMethod:n,setCurrentAnalysisMethod:N,params:B,...T},Z)=>{x.useImperativeHandle(Z,()=>({reload:j}));const{project:K,projectObj:p}=sl(),[u,C]=x.useState([]),[y,P]=x.useState(),[A,b]=x.useState(!1),{eventSourceRef:S,status:kl,reconnect:Fl}=il();x.useEffect(()=>{var a;if(!S)return;const e=d=>{const c=JSON.parse(d.data);if(c.msgType==="analysis_result"){const t=s.map(k=>k.component_id);console.log("componentIdList",t),console.log("data.component_id ",c.component_id),console.log(" componentIdList.includes(data.component_id) ",t.includes(c.component_id)),t.includes(c.component_id)&&j()}};return(a=S.current)==null||a.addEventListener("message",e),()=>{var d;console.log("removeEventListener"),(d=S.current)==null||d.removeEventListener("message",e)}},[S.current]);const j=()=>{if(s&&Array.isArray(s)){const e=s.flatMap(a=>a.component_id);O({componentIdList:e})}else O({params:B})},$=e=>s.reduce((c,t)=>(c[t==null?void 0:t.component_id]=t,c),{})[e];x.useEffect(()=>{var e,a;if(s&&Array.isArray(s)&&s.length>0&&I){I((e=s[0])==null?void 0:e.component_id);const d=$((a=s[0])==null?void 0:a.component_id);N(d)}j()},[JSON.stringify(B),JSON.stringify(s)]);const M=e=>{C(y[e]),I(e);const a=$(e);N(a)},O=async({analysisMethodValues:e,params:a,componentIdList:d})=>{var t,k;b(!0);let c=await Q.post("/analysis-result/list-analysis-result",{project:K,component_ids:d,...a});if(d){const g=c.data.reduce((F,q)=>{const L=q.component_id;F[L]||(F[L]=[]);const{sample_name:G,id:H,sample_group:V,...el}=q;return F[L].push({label:G,value:H,sample_group:V||"no_group",sample_name:G,id:H,...el}),F},{});console.log("groupedData",g),E&&E(g),P(g),C(f?g[f]?g[f]:[]:g[(t=s[0])==null?void 0:t.component_id]?g[(k=s[0])==null?void 0:k.component_id]:[])}else C(c.data);b(!1)},ll=async e=>{await Q.delete(`/analyais-result/delete-by-id/${e}`),cl.success("删除成功!"),j()};let nl=[{title:"项目名称",dataIndex:"project_name",key:"project_name",width:100,ellipsis:!0,render:(e,a)=>l.jsx(r,{title:a.project,children:l.jsx("span",{style:{cursor:"pointer"},children:e})})},{title:"分析结果ID",dataIndex:"analysis_result_id",key:"analysis_result_id",width:50,ellipsis:!0,render:(e,a)=>l.jsx(r,{title:a.analysis_result_id,children:l.jsx("span",{style:{cursor:"pointer"},children:String(e).slice(0,8)})})},{title:"组件名称",dataIndex:"component_name",key:"component_name",width:100,ellipsis:!0,render:(e,a)=>l.jsx(r,{title:l.jsx(l.Fragment,{children:l.jsxs("ul",{children:[l.jsxs("li",{children:["analysis_id: ",a.analysis_id]}),l.jsxs("li",{children:["component_id: ",a.component_id]}),l.jsxs("li",{children:["analysis_result_id: ",a.analysis_result_id]}),l.jsxs("li",{children:["sample_id: ",a.sample_id]}),l.jsxs("li",{children:["file_name: ",a.file_name]}),l.jsxs("li",{children:["analysis_result_hash: ",a.analysis_result_hash]})]})}),children:l.jsx("span",{style:{cursor:"pointer"},children:e})})},{title:"样本名称",dataIndex:"sample_name",key:"sample_name",width:100,ellipsis:!0,render:(e,a)=>l.jsx(r,{title:l.jsx(l.Fragment,{children:l.jsx("ul",{children:l.jsxs("li",{children:["sample_id: ",a.sample_id]})})}),children:l.jsx("span",{style:{cursor:"pointer"},children:e})})},...(()=>{var e;return!(p!=null&&p.metadata_form)||!Array.isArray(p==null?void 0:p.metadata_form)?[]:(e=p==null?void 0:p.metadata_form)==null?void 0:e.map(a=>({title:a.label,dataIndex:a.name,key:a.name,ellipsis:!0}))})(),...X,{title:"操作",key:"action",fixed:"right",ellipsis:!0,width:200,render:(e,a)=>l.jsxs(_l,{size:"middle",children:[l.jsx(ol,{content:l.jsx(l.Fragment,{children:l.jsx(U,{children:l.jsx("pre",{children:JSON.stringify(a.content,null,2)})})}),children:l.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{h&&h(a),R&&R(void 0),i.openModal("openFile",{content:a.content,description:n.description})},children:"查看"})}),a.sample_name?l.jsx(l.Fragment,{children:l.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("metadataForm",{analysis_result_id:a.analysis_result_id,sample_id:a.sample_id,callback:j})},children:"metadata"})}):l.jsx(l.Fragment,{children:l.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("metadataForm",{analysis_result_id:a.analysis_result_id,callback:j})},children:"添加metadata"})}),l.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{console.log(i),i.openModals("bindSample",{analysis_result_id:a.analysis_result_id,callback:j})},children:"绑定样本"}),l.jsx(W,{title:"确定删除吗?",onConfirm:async()=>{await ll(a.analysis_result_id)},children:l.jsx(o,{size:"small",color:"danger",variant:"solid",children:"删除"})})]})}];const[v,al]=x.useState(""),w=x.useMemo(()=>v?u.filter(e=>Object.values(e).some(a=>String(a).toLowerCase().includes(v.toLowerCase()))):u,[u,v]);return l.jsx(l.Fragment,{children:l.jsxs(jl,{size:"small",title:l.jsxs(l.Fragment,{children:[l.jsx(xl,{})," ",z,(n==null?void 0:n.component_name)&&l.jsx(r,{title:l.jsx(l.Fragment,{children:l.jsxs("ul",{children:[l.jsxs("li",{children:["namespace: ",n==null?void 0:n.namespace_name]}),(_==null?void 0:_.component_id)&&l.jsxs("li",{children:["pipeline: ",_==null?void 0:_.component_id]}),(m==null?void 0:m.component_id)&&l.jsxs("li",{children:["software: ",m==null?void 0:m.component_id]}),(n==null?void 0:n.component_id)&&l.jsxs("li",{children:["file: ",n==null?void 0:n.component_id]}),(n==null?void 0:n.name)&&l.jsxs("li",{children:["name: ",n==null?void 0:n.name]})]})}),children:l.jsxs("span",{style:{cursor:"pointer"},children:["(",n==null?void 0:n.component_name,")"]})})]}),extra:l.jsxs(l.Fragment,{children:[Y,l.jsxs(ml,{gap:"small",children:[(i==null?void 0:i.openModal)&&l.jsxs(l.Fragment,{children:[l.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModals("modalD",{...n,operatePipeline:i})},children:"导入数据"}),(T.component_type=="software"||T.component_type=="file")&&l.jsxs(l.Fragment,{children:[l.jsx(r,{title:n==null?void 0:n.component_name,children:l.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("modalC",{data:void 0,structure:{relation_type:D,parent_component_id:m.component_id,component_type:"file"}})},children:"新增文件"})}),l.jsx(r,{title:n==null?void 0:n.component_name,children:l.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("modalC",{data:n,structure:{component_type:"file"}})},children:"更新文件"})}),l.jsx(r,{title:n==null?void 0:n.component_name,children:l.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:D,parent_component_id:m.component_id}})},children:"添加文件"})}),l.jsx(r,{title:n==null?void 0:n.component_name,children:l.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("modalA",{data:n,pipelineStructure:{relation_type:D}})},children:"替换文件"})}),l.jsx(r,{title:n==null?void 0:n.component_name,children:l.jsx(W,{title:"是否移除文件!",onConfirm:()=>{i.deletePipelineRelation(n.relation_id)},children:l.jsx(o,{size:"small",color:"cyan",variant:"solid",children:"移除文件"})})})]})]}),l.jsx(o,{size:"small",color:"primary",variant:"solid",onClick:j,children:"刷新"}),l.jsx(dl,{onClick:()=>{i.openModal("descriptionModal",n.description)},style:{cursor:"pointer"}})]})]}),tabList:s&&Array.isArray(s)&&s.length>1?s.map(e=>({key:e.component_id,label:e.component_name?e.component_name:"no_name"})):void 0,activeTabKey:f,onTabChange:M,children:[l.jsx(pl,{title:()=>l.jsx(tl.Search,{size:"small",placeholder:"搜索结果...",allowClear:!0,enterButton:!0,value:v,onChange:e=>al(e.target.value),style:{width:300}}),rowKey:e=>e.id,size:"small",bordered:!0,pagination:{pageSize:10},loading:A,scroll:{x:"max-content",y:55*5},columns:J||nl,footer:()=>`一共${w&&Array.isArray(w)&&u.length}条记录`,dataSource:w}),(n==null?void 0:n.parseFormat)&&(n==null?void 0:n.relation_type)=="software_output_file"&&l.jsx(U,{children:l.jsx("pre",{children:JSON.stringify(n.parseFormat,null,2)})})]})})}),Ll=({visible:_,onClose:m,params:z})=>_?l.jsx(l.Fragment,{children:l.jsx(rl,{title:"分析结果",open:_,onCancel:m,width:"80%",children:l.jsx(gl,{...z,analysisType:"sample"})})}):null;export{Ll as A,gl as R};
