import{r as n,t as q,_ as G,d as h,o as W,e as X,Q as Y,U as Z,a as v,j as e,I as ee,f as se,B as c,n as j,l as ae,P as d,V as ne}from"./index-B_3LX8Sv.js";import{P as ie}from"./index-OGLv2aFq.js";import{A as le,E as te,s as re,r as oe}from"./index-BR1xyGpG.js";import{C as ce}from"./index-BKM-36RV.js";import{F as de,S as R,D as me}from"./Table-DPfHYlNE.js";import{T as _}from"./index-CnwY4WqK.js";var ue={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M888 792H200V168c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v688c0 4.4 3.6 8 8 8h752c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM305.8 637.7c3.1 3.1 8.1 3.1 11.3 0l138.3-137.6L583 628.5c3.1 3.1 8.2 3.1 11.3 0l275.4-275.3c3.1-3.1 3.1-8.2 0-11.3l-39.6-39.6a8.03 8.03 0 00-11.3 0l-230 229.9L461.4 404a8.03 8.03 0 00-11.3 0L266.3 586.7a8.03 8.03 0 000 11.3l39.5 39.7z"}}]},name:"line-chart",theme:"outlined"},pe=function(k,C){return n.createElement(q,G({},k,{ref:C,icon:ue}))},xe=n.forwardRef(pe);const Te=n.forwardRef(({title:E,form:k,appendSampleColumns:C=[],setResultTableList:w,cleanDom:ye,analysisType:he,setRecord:b,setTableLoading:je,setTabletData:_e,shouldTrigger:fe,columnsParamsALL:ge,project:m,software:ve,component_id:z,component_ids:P,operatePipeline:ke,editParams:Ce},M)=>{n.useImperativeHandle(M,()=>({reload:l}));const[we,B]=n.useState(),[be,T]=h.useMessage(),{modal:i,openModal:u,closeModal:o}=W(),[Ie,Se]=n.useState(!1),D=X(),$=Y(),{eventSourceRef:p,status:Ae,reconnect:Fe}=Z(),[t,O]=n.useState([]),f=n.useRef([]),g=n.useRef(null),[H,I]=n.useState(!1),[Le,V]=n.useState();n.useEffect(()=>{if(t&&Array.isArray(t)&&t.length>0&&i.visible&&i.params){const a=t.find(s=>s.analysis_id==i.params.analysis_id);a&&V(a)}},[t,i.params]),n.useEffect(()=>{var a;if(p){const s=r=>{var L;const y=JSON.parse(r.data);console.log("analysisId",f.current),f.current.includes(y.analysis_id)&&(y.event=="analysis_complete"||y.event=="analysis_failed"||y.event=="analysis_started")&&(l(),g.current&&((L=g.current)==null||L.relaod()))};return(a=p.current)==null||a.addEventListener("message",s),()=>{var r;console.log("removeEventListener"),(r=p.current)==null||r.removeEventListener("message",s)}}},[p.current,m]);const N=a=>{b&&b(a),B(a)},l=async()=>{I(!0);let a=await v.post("/list-analysis",{component_id:z,component_ids:P,project:m});w&&w(a.data),O(a.data);const s=a.data.map(r=>r.analysis_id);f.current=s,I(!1)},U=async a=>{await v.delete(`/fast-api/analysis/${a}`),h.success("删除成功!"),l()},S=(a,s)=>i.params?a.analysis_id==i.params.analysis_id&&s==i.key:!1,A=async(a,s)=>{await oe(a.analysis_id,s),h.success("运行成功"),l()},J=async a=>{await re(a.analysis_id),h.success("停止成功"),l()};let K=[{title:"project_name",dataIndex:"project_name",key:"project_name",ellipsis:!0,render:(a,s)=>e.jsx(j,{title:s.project,children:e.jsx("span",{style:{cursor:"pointer"},children:a})})},{title:"analysis_status",dataIndex:"analysis_status",key:"analysis_status",ellipsis:!0,render:a=>e.jsx(_,{color:a==="success"?"green":a==="failed"?"red":"blue",children:a})},{title:"组件名称",dataIndex:"component_name",key:"component_name",ellipsis:!0,render:(a,s)=>e.jsx(j,{title:s.component_id,children:e.jsx("span",{style:{cursor:"pointer"},children:a})})},{title:"分析名称",dataIndex:"analysis_name",key:"analysis_name",ellipsis:!0},{title:"报告",dataIndex:"is_report",key:"is_report",ellipsis:!0,render:(a,s)=>e.jsx(_,{color:a?"green":"blue",children:a?"报告":"不报告"})},{title:"analysis_id",dataIndex:"analysis_id",key:"analysis_id",ellipsis:!0,render:(a,s)=>e.jsx(ae,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsxs("li",{children:["analysis_id:",s.analysis_id]}),e.jsxs("li",{children:["analysis_name:",s.analysis_name]}),e.jsxs("li",{children:["pipeline_script:",s.pipeline_script]}),e.jsxs("li",{children:["work_dir:",s.work_dir]}),e.jsxs("li",{children:["output_dir:",s.output_dir]}),e.jsxs("li",{children:["command_log_path:",s.command_log_path]}),e.jsxs("li",{children:["trace_file:",s.trace_file]}),e.jsxs("li",{children:["executor_log_file:",s.executor_log_file]}),e.jsxs("li",{children:["workflow_log_file:",s.workflow_log_file]})]})}),children:e.jsxs("span",{style:{cursor:"pointer"},children:[" ",e.jsx("span",{style:{cursor:"pointer"},children:String(a).slice(0,8)})]})})},{title:"容器",dataIndex:"container_name",key:"container_name",ellipsis:!0,render:(a,s)=>e.jsxs(j,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsx("li",{children:s.container_image}),s.sub_container_image&&e.jsx("li",{children:s.sub_container_image})]})}),children:[e.jsx(_,{style:{cursor:"pointer"},children:a}),s.sub_container_name&&e.jsx(_,{style:{cursor:"pointer"},children:s.sub_container_name})]})},{title:"操作",key:"action",fixed:"right",ellipsis:!0,width:200,render:(a,s)=>e.jsxs(R,{size:"middle",children:[s.analysis_status=="running"?e.jsx(e.Fragment,{children:e.jsx(d,{title:"是否停止!",onConfirm:()=>{J(s)},children:e.jsx(c,{size:"small",color:"cyan",variant:"solid",children:"停止"})})}):e.jsx(e.Fragment,{children:e.jsx(d,{title:"是否运行!",onConfirm:()=>{A(s,"job"),u("modalA",s),N(s)},children:e.jsx(c,{size:"small",color:"cyan",variant:"solid",children:s.analysis_status=="created"?"运行":"重新运行"})})}),e.jsx(c,{size:"small",color:"cyan",variant:"solid",onClick:()=>u("editParams",s.analysis_id),children:"编辑参数"}),S(s,"modalA")?e.jsx(c,{size:"small",color:"cyan",variant:"solid",onClick:()=>{o()},children:"关闭"}):e.jsx(c,{size:"small",color:"cyan",variant:"solid",onClick:()=>{u("modalA",s)},children:"查看结果"}),e.jsx(me,{menu:{items:[{key:"1",label:e.jsx(e.Fragment,{children:S(s,"modalB")?e.jsx("a",{onClick:()=>{o()},children:"关闭"}):e.jsx("a",{onClick:()=>{u("modalB",s)},children:"详情"})})},{key:"2",label:e.jsx(e.Fragment,{children:s.analysis_status=="running"?e.jsx(e.Fragment,{children:s.run_type=="server"&&e.jsx(e.Fragment,{children:e.jsx(j,{title:e.jsx(e.Fragment,{children:s.url}),children:e.jsx("a",{onClick:()=>{window.open(`${s.url}`,"_blank")},children:"打开URL"})})})}):e.jsx(e.Fragment,{children:e.jsx(d,{title:"是否启动服务?",onConfirm:()=>{A(s,"server")},children:e.jsx("a",{children:"启动服务"})})})})},{key:"3",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:()=>{D(`/software-analysis-editor/${s.analysis_id}`,{state:{location:$.pathname}})},children:"编辑"})})},{key:"4",label:e.jsxs(e.Fragment,{children:[" ",e.jsx(d,{title:"是否删除!",onConfirm:async()=>{await U(s.analysis_id),l()},children:e.jsx("a",{children:"删除"})})]})},{key:"5",label:e.jsxs(e.Fragment,{children:[" ",e.jsx(d,{title:s.is_report?"是否取消报告":"是否报告",onConfirm:async()=>{await v.post(`/analysis/update-report/${s.analysis_id}`),l()},children:s.is_report?"取消报告":"报告"})]})}]},children:e.jsx("a",{onClick:r=>r.preventDefault(),children:e.jsxs(R,{children:["更多",e.jsx(ne,{})]})})})]})}];n.useEffect(()=>{o()},[m]),n.useEffect(()=>{l()},[m]);const[x,Q]=n.useState(""),F=n.useMemo(()=>x?t.filter(a=>Object.values(a).some(s=>String(s).toLowerCase().includes(x.toLowerCase()))):t,[t,x]);return e.jsxs(e.Fragment,{children:[T,e.jsx(ce,{size:"small",title:e.jsxs(e.Fragment,{children:[e.jsx(xe,{})," 分析记录"]}),extra:e.jsx(se,{gap:"small",children:e.jsx(c,{size:"small",type:"primary",onClick:l,children:"刷新"})}),children:e.jsx(de,{title:()=>e.jsx(ee.Search,{size:"small",placeholder:"搜索结果...",allowClear:!0,enterButton:!0,value:x,onChange:a=>Q(a.target.value),style:{width:300}}),rowKey:"analysis_id",size:"small",bordered:!0,pagination:!1,loading:H,scroll:{x:"max-content",y:55*5},columns:K,footer:()=>`一共${F.length}条记录`,dataSource:F})}),e.jsx("div",{style:{marginBottom:"1rem"}}),e.jsx(le,{visible:i.key=="modalA"&&i.visible,params:i.params,onClose:o}),e.jsx(ie,{ref:g,visible:i.key=="modalB"&&i.visible,params:i.params,onClose:o,callback:l}),e.jsx(te,{callback:l,visible:i.key=="editParams"&&i.visible,params:i.params,onClose:o})]})});export{Te as R};
