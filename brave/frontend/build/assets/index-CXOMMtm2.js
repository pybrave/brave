import{r as g,d as ln,aq as an,a as V,j as n,o as _,m as en,B as o,c as h,P as Q,g as sn,w as on,e as tn,M as mn}from"./index-DhvRCvGD.js";import{S as dn,F as cn,a as _n}from"./Table-Qj6jybFq.js";import{C as rn}from"./index-CcbGURz4.js";const pn=g.forwardRef(({pipeline:r,software:m,title:S,form:xn,appendSampleColumns:U=[],setResultTableList:E,cleanDom:L,analysisType:jn,setRecord:R,setTableLoading:gn,setTabletData:fn,shouldTrigger:un,analysisMethod:i,columnsParamsALL:w,activeTabKey:f,setActiveTabKey:z,cardExtra:W,operatePipeline:s,relationType:I,currentAnalysisMethod:l,setCurrentAnalysisMethod:J,params:N,...B},X)=>{g.useImperativeHandle(X,()=>({reload:x}));const{project:Y,projectObj:p}=ln(),[u,C]=g.useState([]),[Z,K]=g.useState(),[y,$]=g.useState(!1),{eventSourceRef:k,status:Cn,reconnect:kn}=an();g.useEffect(()=>{var a;if(!k)return;const e=d=>{const c=JSON.parse(d.data);if(c.msgType==="analysis_result"){const t=i.map(F=>F.component_id);console.log("componentIdList",t),console.log("data.component_id ",c.component_id),console.log(" componentIdList.includes(data.component_id) ",t.includes(c.component_id)),t.includes(c.component_id)&&x()}};return(a=k.current)==null||a.addEventListener("message",e),()=>{var d;console.log("removeEventListener"),(d=k.current)==null||d.removeEventListener("message",e)}},[k.current]);const x=()=>{if(i&&Array.isArray(i)){const e=i.flatMap(a=>a.component_id);T({componentIdList:e})}else T({params:N})},b=e=>i.reduce((c,t)=>(c[t==null?void 0:t.component_id]=t,c),{})[e];g.useEffect(()=>{var e,a;if(i&&Array.isArray(i)&&i.length>0&&z){z((e=i[0])==null?void 0:e.component_id);const d=b((a=i[0])==null?void 0:a.component_id);J(d)}x()},[JSON.stringify(N),JSON.stringify(i)]);const P=e=>{C(Z[e]),z(e);const a=b(e);J(a)},T=async({analysisMethodValues:e,params:a,componentIdList:d})=>{var t,F;$(!0);let c=await V.post("/analysis-result/list-analysis-result",{project:Y,component_ids:d,...a});if(d){const j=c.data.reduce((v,q)=>{const D=q.component_id;v[D]||(v[D]=[]);const{sample_name:G,id:H,sample_group:O,...nn}=q;return v[D].push({label:G,value:H,sample_group:O||"no_group",sample_name:G,id:H,...nn}),v},{});console.log("groupedData",j),E&&E(j),K(j),C(f?j[f]?j[f]:[]:j[(t=i[0])==null?void 0:t.component_id]?j[(F=i[0])==null?void 0:F.component_id]:[])}else C(c.data);$(!1)},A=async e=>{await V.delete(`/analyais-result/delete-by-id/${e}`),tn.success("删除成功!"),x()};let M=[{title:"项目名称",dataIndex:"project_name",key:"project_name",width:100,ellipsis:!0,render:(e,a)=>n.jsx(_,{title:a.project,children:n.jsx("span",{style:{cursor:"pointer"},children:e})})},{title:"分析结果ID",dataIndex:"analysis_result_id",key:"analysis_result_id",width:50,ellipsis:!0,render:(e,a)=>n.jsx(_,{title:a.analysis_result_id,children:n.jsx("span",{style:{cursor:"pointer"},children:String(e).slice(0,8)})})},{title:"组件名称",dataIndex:"component_name",key:"component_name",width:100,ellipsis:!0,render:(e,a)=>n.jsx(_,{title:n.jsx(n.Fragment,{children:n.jsxs("ul",{children:[n.jsxs("li",{children:["analysis_id: ",a.analysis_id]}),n.jsxs("li",{children:["component_id: ",a.component_id]}),n.jsxs("li",{children:["analysis_result_id: ",a.analysis_result_id]}),n.jsxs("li",{children:["sample_id: ",a.sample_id]}),n.jsxs("li",{children:["file_name: ",a.file_name]}),n.jsxs("li",{children:["analysis_result_hash: ",a.analysis_result_hash]})]})}),children:n.jsx("span",{style:{cursor:"pointer"},children:e})})},{title:"样本名称",dataIndex:"sample_name",key:"sample_name",width:100,ellipsis:!0,render:(e,a)=>n.jsx(_,{title:n.jsx(n.Fragment,{children:n.jsx("ul",{children:n.jsxs("li",{children:["sample_id: ",a.sample_id]})})}),children:n.jsx("span",{style:{cursor:"pointer"},children:e})})},...(()=>{var e;return!(p!=null&&p.metadata_form)||!Array.isArray(p==null?void 0:p.metadata_form)?[]:(e=p==null?void 0:p.metadata_form)==null?void 0:e.map(a=>({title:a.label,dataIndex:a.name,key:a.name,ellipsis:!0}))})(),...U,{title:"操作",key:"action",fixed:"right",ellipsis:!0,width:200,render:(e,a)=>n.jsxs(dn,{size:"middle",children:[n.jsx(en,{content:n.jsx(n.Fragment,{children:n.jsx(h,{children:n.jsx("pre",{children:JSON.stringify(a.content,null,2)})})}),children:n.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{R&&R(a),L&&L(void 0),s.openModal("openFile",{content:a.content,description:l.description})},children:"查看"})}),a.sample_name?n.jsx(n.Fragment,{children:n.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{s.openModal("metadataForm",{analysis_result_id:a.analysis_result_id,sample_id:a.sample_id,callback:x})},children:"metadata"})}):n.jsx(n.Fragment,{children:n.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{s.openModal("metadataForm",{analysis_result_id:a.analysis_result_id,callback:x})},children:"添加metadata"})}),n.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{console.log(s),s.openModals("bindSample",{analysis_result_id:a.analysis_result_id,callback:x})},children:"绑定样本"}),n.jsx(Q,{title:"确定删除吗?",onConfirm:async()=>{await A(a.analysis_result_id)},children:n.jsx(o,{size:"small",color:"danger",variant:"solid",children:"删除"})})]})}];return n.jsx(n.Fragment,{children:n.jsxs(rn,{size:"small",title:n.jsxs(n.Fragment,{children:[n.jsx(_n,{})," ",S,(l==null?void 0:l.component_name)&&n.jsx(_,{title:n.jsx(n.Fragment,{children:n.jsxs("ul",{children:[n.jsxs("li",{children:["namespace: ",l==null?void 0:l.namespace_name]}),(r==null?void 0:r.component_id)&&n.jsxs("li",{children:["pipeline: ",r==null?void 0:r.component_id]}),(m==null?void 0:m.component_id)&&n.jsxs("li",{children:["software: ",m==null?void 0:m.component_id]}),(l==null?void 0:l.component_id)&&n.jsxs("li",{children:["file: ",l==null?void 0:l.component_id]}),(l==null?void 0:l.name)&&n.jsxs("li",{children:["name: ",l==null?void 0:l.name]})]})}),children:n.jsxs("span",{style:{cursor:"pointer"},children:["(",l==null?void 0:l.component_name,")"]})})]}),extra:n.jsxs(n.Fragment,{children:[W,n.jsxs(sn,{gap:"small",children:[(s==null?void 0:s.openModal)&&n.jsxs(n.Fragment,{children:[n.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{s.openModals("modalD",{...l,operatePipeline:s})},children:"导入数据"}),(B.component_type=="software"||B.component_type=="file")&&n.jsxs(n.Fragment,{children:[n.jsx(_,{title:l==null?void 0:l.component_name,children:n.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{s.openModal("modalC",{data:void 0,structure:{relation_type:I,parent_component_id:m.component_id,component_type:"file"}})},children:"新增文件"})}),n.jsx(_,{title:l==null?void 0:l.component_name,children:n.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{s.openModal("modalC",{data:l,structure:{component_type:"file"}})},children:"更新文件"})}),n.jsx(_,{title:l==null?void 0:l.component_name,children:n.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{s.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:I,parent_component_id:m.component_id}})},children:"添加文件"})}),n.jsx(_,{title:l==null?void 0:l.component_name,children:n.jsx(o,{size:"small",color:"cyan",variant:"solid",onClick:()=>{s.openModal("modalA",{data:l,pipelineStructure:{relation_type:I}})},children:"替换文件"})}),n.jsx(_,{title:l==null?void 0:l.component_name,children:n.jsx(Q,{title:"是否移除文件!",onConfirm:()=>{s.deletePipelineRelation(l.relation_id)},children:n.jsx(o,{size:"small",color:"cyan",variant:"solid",children:"移除文件"})})})]})]}),n.jsx(o,{size:"small",color:"primary",variant:"solid",onClick:x,children:"刷新"}),n.jsx(on,{onClick:()=>{s.openModal("descriptionModal",l.description)},style:{cursor:"pointer"}})]})]}),tabList:i&&Array.isArray(i)&&i.length>1?i.map(e=>({key:e.component_id,label:e.component_name?e.component_name:"no_name"})):void 0,activeTabKey:f,onTabChange:P,children:[n.jsx(cn,{rowKey:e=>e.id,size:"small",bordered:!0,pagination:{pageSize:10},loading:y,scroll:{x:"max-content",y:55*5},columns:w||M,footer:()=>`一共${u&&Array.isArray(u)&&u.length}条记录`,dataSource:u}),(l==null?void 0:l.parseFormat)&&(l==null?void 0:l.relation_type)=="software_output_file"&&n.jsx(h,{children:n.jsx("pre",{children:JSON.stringify(l.parseFormat,null,2)})})]})})}),In=({visible:r,onClose:m,params:S})=>r?n.jsx(n.Fragment,{children:n.jsx(mn,{title:"分析结果",open:r,onCancel:m,width:"80%",children:n.jsx(pn,{...S,analysisType:"sample"})})}):null;export{In as A,pn as R};
