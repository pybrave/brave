import{a as F,r as u,q as fe,k as J,j as e,F as M,i as D,l as k,B as j,M as q,d as C,I as T,P as I,v as re,m as oe,D as ae,s as ge,a2 as le,c as xe,$ as ye,u as W,R as ce,C as N,S as je,y as ve,aT as be,t as we,b as Se,p as Fe}from"./main-Cq64AMgN.js";import Ce from"./index-KwMfgfH8.js";import{C as de}from"./index-Dc_dGIGZ.js";import{F as B}from"./index-CV_PF3zW.js";import{T as K}from"./index-BN2NQmSZ.js";import{F as he}from"./Table-DbGD-iom.js";import{KGMLMapSVG as _e}from"./index-B_gcWTWk.js";import{S as ue}from"./index-YruvF9S2.js";import{A as ze}from"./index-CVXeocLt.js";import{I as ke}from"./index-BCygBs-J.js";import{R as Ie}from"./DownloadOutlined-B_Zvv-ib.js";const yt=async r=>await F.get("/file-operation/read-file",{params:{file_path:r}}),Me=async(r,a=0)=>await F.get("/file-operation/read-log-file",{params:{file_path:r,offset:a}}),jt=async(r,a)=>await F.post("/file-operation/write-file",{file_path:r,content:a}),vt=async r=>await F.get(`/find-analysis-by-id/${r}`),Y=async(r,a)=>await F.post(`/run-analysis-v2/${r}?run_type=${a}`),Q=async(r,a)=>await F.post(`/analysis/stop-analysis/${r}?run_type=${a}`);function O(r,a,s){let i=s.initialDeps??[],n;function o(){var l,t,c,h;let d;s.key&&((l=s.debug)!=null&&l.call(s))&&(d=Date.now());const f=r();if(!(f.length!==i.length||f.some((m,y)=>i[y]!==m)))return n;i=f;let x;if(s.key&&((t=s.debug)!=null&&t.call(s))&&(x=Date.now()),n=a(...f),s.key&&((c=s.debug)!=null&&c.call(s))){const m=Math.round((Date.now()-d)*100)/100,y=Math.round((Date.now()-x)*100)/100,v=y/16,w=(b,S)=>{for(b=String(b);b.length<S;)b=" "+b;return b};console.info(`%c⏱ ${w(y,5)} /${w(m,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*v,120))}deg 100% 31%);`,s==null?void 0:s.key)}return(h=s==null?void 0:s.onChange)==null||h.call(s,n),n}return o.updateDeps=l=>{i=l},o}function X(r,a){if(r===void 0)throw new Error("Unexpected undefined");return r}const Ee=(r,a)=>Math.abs(r-a)<1.01,De=(r,a,s)=>{let i;return function(...n){r.clearTimeout(i),i=r.setTimeout(()=>a.apply(this,n),s)}},Z=r=>{const{offsetWidth:a,offsetHeight:s}=r;return{width:a,height:s}},Ae=r=>r,Oe=r=>{const a=Math.max(r.startIndex-r.overscan,0),s=Math.min(r.endIndex+r.overscan,r.count-1),i=[];for(let n=a;n<=s;n++)i.push(n);return i},$e=(r,a)=>{const s=r.scrollElement;if(!s)return;const i=r.targetWindow;if(!i)return;const n=l=>{const{width:t,height:c}=l;a({width:Math.round(t),height:Math.round(c)})};if(n(Z(s)),!i.ResizeObserver)return()=>{};const o=new i.ResizeObserver(l=>{const t=()=>{const c=l[0];if(c!=null&&c.borderBoxSize){const h=c.borderBoxSize[0];if(h){n({width:h.inlineSize,height:h.blockSize});return}}n(Z(s))};r.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(t):t()});return o.observe(s,{box:"border-box"}),()=>{o.unobserve(s)}},ee={passive:!0},te=typeof window>"u"?!0:"onscrollend"in window,Ve=(r,a)=>{const s=r.scrollElement;if(!s)return;const i=r.targetWindow;if(!i)return;let n=0;const o=r.options.useScrollendEvent&&te?()=>{}:De(i,()=>{a(n,!1)},r.options.isScrollingResetDelay),l=d=>()=>{const{horizontal:f,isRtl:g}=r.options;n=f?s.scrollLeft*(g&&-1||1):s.scrollTop,o(),a(n,d)},t=l(!0),c=l(!1);c(),s.addEventListener("scroll",t,ee);const h=r.options.useScrollendEvent&&te;return h&&s.addEventListener("scrollend",c,ee),()=>{s.removeEventListener("scroll",t),h&&s.removeEventListener("scrollend",c)}},Te=(r,a,s)=>{if(a!=null&&a.borderBoxSize){const i=a.borderBoxSize[0];if(i)return Math.round(i[s.options.horizontal?"inlineSize":"blockSize"])}return r[s.options.horizontal?"offsetWidth":"offsetHeight"]},Le=(r,{adjustments:a=0,behavior:s},i)=>{var n,o;const l=r+a;(o=(n=i.scrollElement)==null?void 0:n.scrollTo)==null||o.call(n,{[i.options.horizontal?"left":"top"]:l,behavior:s})};class We{constructor(a){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let s=null;const i=()=>s||(!this.targetWindow||!this.targetWindow.ResizeObserver?null:s=new this.targetWindow.ResizeObserver(n=>{n.forEach(o=>{const l=()=>{this._measureElement(o.target,o)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(l):l()})}));return{disconnect:()=>{var n;(n=i())==null||n.disconnect(),s=null},observe:n=>{var o;return(o=i())==null?void 0:o.observe(n,{box:"border-box"})},unobserve:n=>{var o;return(o=i())==null?void 0:o.unobserve(n)}}})(),this.range=null,this.setOptions=s=>{Object.entries(s).forEach(([i,n])=>{typeof n>"u"&&delete s[i]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:Ae,rangeExtractor:Oe,onChange:()=>{},measureElement:Te,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...s}},this.notify=s=>{var i,n;(n=(i=this.options).onChange)==null||n.call(i,this,s)},this.maybeNotify=O(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),s=>{this.notify(s)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(s=>s()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var s;const i=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==i){if(this.cleanup(),!i){this.maybeNotify();return}this.scrollElement=i,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=((s=this.scrollElement)==null?void 0:s.window)??null,this.elementsCache.forEach(n=>{this.observer.observe(n)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,n=>{this.scrollRect=n,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(n,o)=>{this.scrollAdjustments=0,this.scrollDirection=o?this.getScrollOffset()<n?"forward":"backward":null,this.scrollOffset=n,this.isScrolling=o,this.maybeNotify()}))}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??(typeof this.options.initialOffset=="function"?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(s,i)=>{const n=new Map,o=new Map;for(let l=i-1;l>=0;l--){const t=s[l];if(n.has(t.lane))continue;const c=o.get(t.lane);if(c==null||t.end>c.end?o.set(t.lane,t):t.end<c.end&&n.set(t.lane,!0),n.size===this.options.lanes)break}return o.size===this.options.lanes?Array.from(o.values()).sort((l,t)=>l.end===t.end?l.index-t.index:l.end-t.end)[0]:void 0},this.getMeasurementOptions=O(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(s,i,n,o,l)=>(this.pendingMeasuredCacheIndexes=[],{count:s,paddingStart:i,scrollMargin:n,getItemKey:o,enabled:l}),{key:!1}),this.getMeasurements=O(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:s,paddingStart:i,scrollMargin:n,getItemKey:o,enabled:l},t)=>{if(!l)return this.measurementsCache=[],this.itemSizeCache.clear(),[];this.measurementsCache.length===0&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(d=>{this.itemSizeCache.set(d.key,d.size)}));const c=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];const h=this.measurementsCache.slice(0,c);for(let d=c;d<s;d++){const f=o(d),g=this.options.lanes===1?h[d-1]:this.getFurthestMeasurement(h,d),x=g?g.end+this.options.gap:i+n,m=t.get(f),y=typeof m=="number"?m:this.options.estimateSize(d),v=x+y,w=g?g.lane:d%this.options.lanes;h[d]={index:d,start:x,size:y,end:v,key:f,lane:w}}return this.measurementsCache=h,h},{key:!1,debug:()=>this.options.debug}),this.calculateRange=O(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(s,i,n,o)=>this.range=s.length>0&&i>0?Be({measurements:s,outerSize:i,scrollOffset:n,lanes:o}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=O(()=>{let s=null,i=null;const n=this.calculateRange();return n&&(s=n.startIndex,i=n.endIndex),this.maybeNotify.updateDeps([this.isScrolling,s,i]),[this.options.rangeExtractor,this.options.overscan,this.options.count,s,i]},(s,i,n,o,l)=>o===null||l===null?[]:s({startIndex:o,endIndex:l,overscan:i,count:n}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=s=>{const i=this.options.indexAttribute,n=s.getAttribute(i);return n?parseInt(n,10):(console.warn(`Missing attribute name '${i}={index}' on measured element.`),-1)},this._measureElement=(s,i)=>{const n=this.indexFromElement(s),o=this.measurementsCache[n];if(!o)return;const l=o.key,t=this.elementsCache.get(l);t!==s&&(t&&this.observer.unobserve(t),this.observer.observe(s),this.elementsCache.set(l,s)),s.isConnected&&this.resizeItem(n,this.options.measureElement(s,i,this))},this.resizeItem=(s,i)=>{const n=this.measurementsCache[s];if(!n)return;const o=this.itemSizeCache.get(n.key)??n.size,l=i-o;l!==0&&((this.shouldAdjustScrollPositionOnItemSizeChange!==void 0?this.shouldAdjustScrollPositionOnItemSizeChange(n,l,this):n.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=l,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(n.index),this.itemSizeCache=new Map(this.itemSizeCache.set(n.key,i)),this.notify(!1))},this.measureElement=s=>{if(!s){this.elementsCache.forEach((i,n)=>{i.isConnected||(this.observer.unobserve(i),this.elementsCache.delete(n))});return}this._measureElement(s,void 0)},this.getVirtualItems=O(()=>[this.getVirtualIndexes(),this.getMeasurements()],(s,i)=>{const n=[];for(let o=0,l=s.length;o<l;o++){const t=s[o],c=i[t];n.push(c)}return n},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=s=>{const i=this.getMeasurements();if(i.length!==0)return X(i[me(0,i.length-1,n=>X(i[n]).start,s)])},this.getOffsetForAlignment=(s,i,n=0)=>{const o=this.getSize(),l=this.getScrollOffset();i==="auto"&&(i=s>=l+o?"end":"start"),i==="center"?s+=(n-o)/2:i==="end"&&(s-=o);const t=this.getTotalSize()+this.options.scrollMargin-o;return Math.max(Math.min(t,s),0)},this.getOffsetForIndex=(s,i="auto")=>{s=Math.max(0,Math.min(s,this.options.count-1));const n=this.measurementsCache[s];if(!n)return;const o=this.getSize(),l=this.getScrollOffset();if(i==="auto")if(n.end>=l+o-this.options.scrollPaddingEnd)i="end";else if(n.start<=l+this.options.scrollPaddingStart)i="start";else return[l,i];const t=i==="end"?n.end+this.options.scrollPaddingEnd:n.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(t,i,n.size),i]},this.isDynamicMode=()=>this.elementsCache.size>0,this.scrollToOffset=(s,{align:i="start",behavior:n}={})=>{n==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getOffsetForAlignment(s,i),{adjustments:void 0,behavior:n})},this.scrollToIndex=(s,{align:i="auto",behavior:n}={})=>{n==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),s=Math.max(0,Math.min(s,this.options.count-1));let o=0;const l=10,t=h=>{if(!this.targetWindow)return;const d=this.getOffsetForIndex(s,h);if(!d){console.warn("Failed to get offset for index:",s);return}const[f,g]=d;this._scrollToOffset(f,{adjustments:void 0,behavior:n}),this.targetWindow.requestAnimationFrame(()=>{const x=this.getScrollOffset(),m=this.getOffsetForIndex(s,g);if(!m){console.warn("Failed to get offset for index:",s);return}Ee(m[0],x)||c(g)})},c=h=>{this.targetWindow&&(o++,o<l?this.targetWindow.requestAnimationFrame(()=>t(h)):console.warn(`Failed to scroll to index ${s} after ${l} attempts.`))};t(i)},this.scrollBy=(s,{behavior:i}={})=>{i==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getScrollOffset()+s,{adjustments:void 0,behavior:i})},this.getTotalSize=()=>{var s;const i=this.getMeasurements();let n;if(i.length===0)n=this.options.paddingStart;else if(this.options.lanes===1)n=((s=i[i.length-1])==null?void 0:s.end)??0;else{const o=Array(this.options.lanes).fill(null);let l=i.length-1;for(;l>=0&&o.some(t=>t===null);){const t=i[l];o[t.lane]===null&&(o[t.lane]=t.end),l--}n=Math.max(...o.filter(t=>t!==null))}return Math.max(n-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(s,{adjustments:i,behavior:n})=>{this.options.scrollToFn(s,{behavior:n,adjustments:i},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(a)}}const me=(r,a,s,i)=>{for(;r<=a;){const n=(r+a)/2|0,o=s(n);if(o<i)r=n+1;else if(o>i)a=n-1;else return n}return r>0?r-1:0};function Be({measurements:r,outerSize:a,scrollOffset:s,lanes:i}){const n=r.length-1,o=c=>r[c].start;if(r.length<=i)return{startIndex:0,endIndex:n};let l=me(0,n,o,s),t=l;if(i===1)for(;t<n&&r[t].end<s+a;)t++;else if(i>1){const c=Array(i).fill(0);for(;t<n&&c.some(d=>d<s+a);){const d=r[t];c[d.lane]=d.end,t++}const h=Array(i).fill(s+a);for(;l>=0&&h.some(d=>d>=s);){const d=r[l];h[d.lane]=d.start,l--}l=Math.max(0,l-l%i),t=Math.min(n,t+(i-1-t%i))}return{startIndex:l,endIndex:t}}const se=typeof document<"u"?u.useLayoutEffect:u.useEffect;function Pe(r){const a=u.useReducer(()=>({}),{})[1],s={...r,onChange:(n,o)=>{var l;o?fe.flushSync(a):a(),(l=r.onChange)==null||l.call(r,n,o)}},[i]=u.useState(()=>new We(s));return i.setOptions(s),se(()=>i._didMount(),[]),se(()=>i._willUpdate()),i}function Ne(r){return Pe({observeElementRect:$e,observeElementOffset:Ve,scrollToFn:Le,...r})}const{Text:ne}=D,Je=({file_path:r})=>{var h;u.useEffect(()=>{console.log("fileKey",r),r&&o(r)},[r]);const{messageApi:a}=J(),s=u.useRef(0),[i,n]=u.useState([]),o=async(d,f=!1)=>{const g=await Me(d);s.current=g.data.offset,n(g.data.content),f&&a.success(`日志加载成功: ${d}`)},l=u.useRef(null),t=Ne({count:i.length,getScrollElement:()=>l.current,estimateSize:()=>30,overscan:10});u.useEffect(()=>{(i==null?void 0:i.length)>0&&t.scrollToIndex(i.length-1,{align:"end",behavior:"smooth"})},[i==null?void 0:i.length]);const c=t.getVirtualItems();return e.jsx(de,{size:"small",extra:e.jsx(j,{size:"small",type:"primary",onClick:()=>{o(r)},children:"Refresh Log"}),title:e.jsxs(M,{gap:"small",wrap:"wrap",children:[e.jsxs(k,{color:"blue",children:["File: ",r]}),e.jsxs(k,{color:"purple",children:["Offset: ",s.current]})]}),bodyStyle:{padding:0},children:e.jsx("div",{ref:l,style:{height:400,overflowY:"auto",fontFamily:"monospace",backgroundColor:"#1e1e1e",color:"#d4d4d4",padding:"0 12px"},children:e.jsx("div",{style:{height:t.getTotalSize(),width:"100%",position:"relative"},children:e.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${((h=c[0])==null?void 0:h.start)??0}px)`},children:c.map(d=>e.jsx("div",{"data-index":d.index,ref:t.measureElement,style:{padding:"4px 0",borderBottom:"1px solid #333"},children:e.jsxs(M,{gap:"middle",children:[e.jsxs(ne,{type:"secondary",style:{width:60,color:"#d4d4d4"},children:["#",d.index+1]}),e.jsx(ne,{style:{whiteSpace:"pre-wrap",color:"#d4d4d4"},children:i[d.index]})]})},d.key))})})})})},qe=({visible:r,onClose:a,params:s})=>e.jsx(q,{footer:null,title:"参数",width:"50%",open:r,onCancel:a,children:e.jsx(D,{children:e.jsx("pre",{children:JSON.stringify(s,null,2)})})}),Ke=({formJson:r,openModal:a})=>{if(!r)return null;const[s,i]=u.useState([]),n=async()=>{const o=r.map(c=>c.dataKey),t=((await F.post("/list-bio-database",{type_list:o})).data||[]).reduce((c,h)=>{const d=h.type;c[d]||(c[d]=[]);const{name:f,database_id:g,...x}=h;return c[d].push({label:f,value:g,...x}),c},{});i(t),console.log(t)};return u.useEffect(()=>{n()},[r]),e.jsx(e.Fragment,{children:e.jsxs(M,{gap:"small",children:[e.jsx("div",{style:{flex:1},children:e.jsx(B,{formJson:r,dataMap:s})}),e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:a,children:"配置数据库"}),e.jsx(j,{onClick:n,size:"small",type:"primary",children:"刷新"})]})})},Re=({visible:r,onClose:a,params:s,callback:i})=>{if(!r)return null;const[n,o]=u.useState([]),[l,t]=u.useState(!1),[c]=C.useForm(),[h,d]=u.useState(s[0].dataKey),[f,g]=u.useState(null),x=async p=>{t(!0);const E=await F.post("/list-bio-database",p);o(E.data),t(!1)},m=async()=>({...await c.validateFields(),type:h}),y=async()=>{const p=await m();f?await F.post("/update-bio-database",{...p,database_id:f.database_id}):await F.post("/add-bio-database",p),v(),g(void 0),c.resetFields()},v=()=>{x({type:h})};u.useEffect(()=>{x({type:h})},[s]);const w=p=>{d(p),x({type:p})},b=async p=>{await F.delete(`/delete-bio-database/${p.id}`),v()},S=p=>{c.setFieldsValue(p),g(p)};return e.jsxs(q,{title:"数据库操作",open:r,onCancel:a,width:"50%",footer:null,children:[e.jsx(K,{tabBarExtraContent:e.jsxs(e.Fragment,{children:[e.jsx(j,{size:"small",color:"cyan",variant:"solid",style:{marginRight:"0.5rem"},type:"primary",onClick:v,children:" 刷新"}),e.jsxs(j,{size:"small",color:"cyan",variant:"solid",type:"primary",onClick:()=>{g(void 0),y()},children:[" ",f?"更新":"添加"]})]}),activeKey:h,onChange:w,items:s.map(p=>({key:p.name,label:p.label,children:e.jsx("div",{})}))}),e.jsxs(C,{form:c,style:{maxWidth:600},labelCol:{span:3},children:[e.jsx(C.Item,{name:"name",label:"名称",rules:[{required:!0,message:"请输入名称"}],children:e.jsx(T,{})}),e.jsx(C.Item,{name:"path",label:"路径",rules:[{required:!0,message:"请输入路径"}],children:e.jsx(T,{})}),e.jsx(C.Item,{name:"db_index",label:"索引",children:e.jsx(T,{})})]}),e.jsx(he,{dataSource:n,columns:[{title:"名称",dataIndex:"name",key:"name"},{title:"数据库ID",dataIndex:"database_id",key:"database_id"},{title:"类型",dataIndex:"type",key:"type"},{title:"路径",dataIndex:"path",key:"path"},{title:"索引",dataIndex:"db_index",key:"db_index"},{title:"操作",dataIndex:"action",key:"action",ellipsis:!0,render:(p,E)=>e.jsxs(M,{gap:"small",children:[e.jsx(I,{title:"确定删除吗？",onConfirm:()=>{b(E)},children:e.jsx(j,{size:"small",type:"primary",danger:!0,children:"删除"})}),e.jsx(j,{size:"small",type:"primary",onClick:()=>{S(E)},children:"编辑"})]})}],loading:l,pagination:!1})]})},Ge=({visible:r,params:a,onClose:s,callback:i})=>{var v,w,b;const[n]=C.useForm(),{messageApi:o,project:l}=J();u.useEffect(()=>{r&&m()},[a]);const[t,c]=u.useState(),[h,d]=u.useState(),f=()=>{s(),i&&i()},[g,x]=u.useState(),m=async()=>{x(!0);const S=await F.post(`/analysis/edit-params/${a}`);c(S.data),d(S.data.analysis_result),n.resetFields(),n.setFieldsValue(S.data.request_param),x(!1)},y=S=>{if(S&&Object.keys(S).length>0)return Object.keys(S)[0]};return e.jsx(e.Fragment,{children:e.jsx(ae,{size:"default",loading:g,title:e.jsx(e.Fragment,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(k,{children:t==null?void 0:t.component_name}),e.jsx(k,{children:t==null?void 0:t.analysis_name}),e.jsx(k,{children:String(t==null?void 0:t.analysis_id).slice(0,8)})]})}),width:"50%",open:r,onClose:s,children:t&&e.jsx(e.Fragment,{children:e.jsx(Ue,{form:n,requestParam:{...t.request_param,analysis_id:t==null?void 0:t.analysis_id},dataMap:{...h,first_data_key:y(h)},formJson:[...((v=t.content)==null?void 0:v.formJson)||[],...((w=t.content)==null?void 0:w.upstreamFormJson)||[],...(t==null?void 0:t.inputFormJson)||[],(t==null?void 0:t.component_type)=="software"?{name:"group_field",label:"Group Field",rules:[{required:!0,message:"该字段不能为空!"}],type:"GroupFieldSelect"}:{}],databases:(b=t.content)==null?void 0:b.databases,upstreamFormJson:t==null?void 0:t.upstreamFormJson,callback:f})})})})},Ue=({form:r,requestParam:a,dataMap:s,formJson:i,databases:n,callback:o,showCancal:l=!1})=>{const{modals:t,openModals:c,closeModals:h}=re(["paramsView","bioDatabases"]),[d,f]=u.useState([]),[g,x]=u.useState([]),{messageApi:m}=J();u.useEffect(()=>{y()},[JSON.stringify(i)]);const y=()=>{if(Array.isArray(i)){const b=i.filter(p=>!(p!=null&&p.required)&&!(p!=null&&p.db)&&!p.component_id),S=i.filter(p=>(p==null?void 0:p.required)||(p==null?void 0:p.db)||p.component_id);f(S),x(b)}},v=b=>({...a,...b}),w=async(b,S=!1)=>{var P;const p=await r.validateFields(),E=v(p);try{const _=await F.post(`/fast-api/analysis-controller?save=${b}&is_submit=${S}`,E);console.log(_),b?(m.success("执行成功!"),o&&o()):c("paramsView",_.data)}catch(_){console.log(_),(P=_.response)!=null&&P.data&&m.error(_.response.data.detail)}};return e.jsxs(e.Fragment,{children:[e.jsxs(C,{form:r,onValuesChange:(b,S)=>{},children:[e.jsx(K,{items:[{key:"1",label:"Required Parameters",forceRender:!0,children:e.jsxs(e.Fragment,{children:[e.jsx(B,{formJson:[...d],dataMap:s}),n&&e.jsx(Ke,{openModal:()=>{c("bioDatabases",n)},formJson:n})]})},{key:"2",label:"Optional parameters",forceRender:!0,children:e.jsx(e.Fragment,{children:e.jsx(B,{formJson:[...g],dataMap:{}})})}]}),e.jsx(C.Item,{label:"Analysyis Name",name:"analysis_name",style:{maxWidth:600},rules:[{required:!0,message:"This field cannot be empty!"}],children:e.jsx(T,{})}),e.jsxs(M,{gap:"small",children:[e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>{w(!1)},children:"View Parameters"}),e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>w(!0),children:a!=null&&a.analysis_id?e.jsxs(e.Fragment,{children:["Update Analysis(",a.analysis_name,")(",String(a.analysis_id).slice(0,8),")"]}):e.jsx(e.Fragment,{children:"Save Analysis"})}),(a==null?void 0:a.analysis_id)&&l&&e.jsx(j,{size:"small",color:"cyan",onClick:()=>r.setFieldValue("analysis_id",void 0),children:"Cancel Analysis"})]}),e.jsx(oe,{ghost:!0,items:[{key:"1",label:"More",children:e.jsx(e.Fragment,{children:e.jsx(C.Item,{noStyle:!0,shouldUpdate:!0,children:()=>e.jsx(D,{children:e.jsx("pre",{children:JSON.stringify(v(r.getFieldsValue()),null,2)})})})})}]})]}),e.jsx(qe,{visible:t.paramsView.visible,onClose:()=>h("paramsView"),params:t.paramsView.params}),e.jsx(Re,{visible:t.bioDatabases.visible,onClose:()=>h("bioDatabases"),params:t.bioDatabases.params})]})},He=({visible:r,onClose:a,params:s,callback:i})=>{if(!r)return null;const[n,o]=u.useState(),[l,t]=ge.useMessage(),[c,h]=u.useState("main"),d=u.useRef(null),f=async g=>{try{const x=await F.get(`/get-component-module-content/${g.component_id}?script_name=${c}`);console.log(x),o(x.data)}catch(x){l.error(`${x.response.data.detail}`)}};return u.useEffect(()=>{f(s)},[JSON.stringify(s),c]),e.jsxs(e.Fragment,{children:[t,e.jsxs(ae,{extra:e.jsxs(M,{justify:"flex-end",gap:"small",children:[e.jsx(I,{title:"是否生成脚本",onConfirm:async()=>{await F.post(`/component/convert-ipynb/${s.component_id}`),l.success("是否生成脚本成功!"),f(s)},children:e.jsx(j,{size:"small",color:"cyan",variant:"solid",children:"生成脚本"})}),e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>{f(s)},children:"刷新"}),e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>{d.current.setValue(n==null?void 0:n.content)},children:"保存"})]}),title:"View File",open:r,onClose:a,width:"50%",children:[e.jsx("ul",{children:e.jsxs("li",{children:["path:",n==null?void 0:n.path]})}),e.jsx("hr",{}),e.jsx(K,{onChange:g=>{h(g)},items:[{label:"main",key:"main"},{label:"input_parse",key:"input_parse"},{label:"output_parse",key:"output_parse"}]}),e.jsx(le,{value:n==null?void 0:n.content,editorRef:d,defaultLanguage:"python"})]})]})},R=({url:r,filename:a,baseURL:s})=>e.jsx(e.Fragment,{children:r&&e.jsx(Fe,{title:e.jsx("div",{style:{wordBreak:"break-all",maxWidth:"400px"},children:`${s}${r}`}),children:e.jsxs(k,{color:"success",style:{cursor:"pointer",whiteSpace:"normal",wordBreak:"break-all",display:"inline-block"},onClick:()=>{window.open(`${s}${r}?t=${Date.now()}`,"_blank")},children:[e.jsxs("span",{children:[a," "]}),e.jsx(Ie,{})]})})}),pe=({data:r,url:a,filename:s,columns:i,baseURL:n,projectObj:o})=>{const{Search:l}=T,[t,c]=u.useState([]),[h,d]=u.useState(),[f,g]=u.useState();u.useEffect(()=>{if(o!=null&&o.research)try{const m=JSON.parse((o==null?void 0:o.research)||"{}");d(m)}catch{}},[o==null?void 0:o.research]);const x=m=>m?Object.keys(m).map(y=>({title:y,dataIndex:y,key:y,ellipsis:!0,width:150})):[];return u.useEffect(()=>{if(r){const m=r.map((y,v)=>({...y,key:v}));c(m)}},[r]),e.jsxs(e.Fragment,{children:[(h==null?void 0:h.table)&&e.jsx(e.Fragment,{children:e.jsx("div",{style:{marginBottom:"1rem"},children:h==null?void 0:h.table.map(m=>e.jsx(k,{color:"blue",style:{cursor:"pointer"},onClick:()=>{const y=r.filter(v=>Object.values(v).some(w=>typeof w=="string"&&w.includes(m)));c(y),g(m)},children:m},m))})}),Array.isArray(t)&&e.jsx(e.Fragment,{children:e.jsx(he,{style:{border:"1px solid #f0f0f0"},size:"small",title:()=>e.jsxs(M,{gap:"small",children:[e.jsx(l,{value:f,size:"small",onChange:m=>{g(m.target.value)},placeholder:"input search text",allowClear:!0,onSearch:m=>{const y=r.filter(v=>Object.values(v).some(w=>typeof w=="string"&&w.includes(m)));c(y)},style:{width:304}}),e.jsx(R,{url:a,filename:s,baseURL:n})]}),scroll:{x:"max-content",y:55*5},dataSource:t,pagination:!1,virtual:!0,columns:i||x(r[0]),footer:()=>`A total of ${r.length} records`})})]})},ie=({data:r,url:a,filename:s,baseURL:i})=>e.jsx("div",{children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx(ke,{src:s!=null&&s.endsWith("pdf")?r:`${r}?t=${Date.now()}`,style:{maxWidth:"20rem",marginRight:"0.5rem"}}),e.jsx(R,{url:a,filename:s,baseURL:i})]})}),{Paragraph:bt}=D,Ye=({data:r})=>e.jsx(e.Fragment,{children:e.jsx(D,{children:e.jsx("pre",{style:{margin:0},children:r})})}),Qe=({data:r})=>e.jsx("div",{children:e.jsx(ze,{closable:!0,message:r,type:"info",showIcon:!0})}),Xe=({data:r})=>e.jsx(e.Fragment,{children:e.jsx(D,{children:e.jsx("pre",{style:{margin:0},children:r})})}),Ze=({data:r})=>e.jsx(e.Fragment,{children:e.jsx(le,{value:r,defaultLanguage:"json"})}),et=({data:r,url:a})=>{const{baseURL:s}=W(o=>o.user),[i,n]=u.useState(!0);return e.jsx(e.Fragment,{children:e.jsxs("div",{style:{position:"relative",width:"100%",height:"80vh"},children:[i&&e.jsx("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.8)",zIndex:1},children:e.jsx(ue,{size:"large",tip:"Loading..."})}),e.jsx("iframe",{src:`${s}${a}`,width:"100%",style:{height:"100%",border:"none"},onLoad:()=>n(!1),title:"content-frame"})]})})},tt=({url:r,filename:a,baseURL:s})=>e.jsx(e.Fragment,{children:e.jsx(R,{url:r,filename:a,baseURL:s})}),st=({data:r,...a})=>{var o,l,t,c,h;const{modal:s,openModal:i,closeModal:n}=Se();return e.jsxs(e.Fragment,{children:[e.jsx(pe,{data:r==null?void 0:r.list,...a,columns:[{title:"ID",dataIndex:"ID",key:"ID",ellipsis:!0,width:150},{title:"Description",dataIndex:"Description",key:"Description",ellipsis:!0,width:400},{title:"GeneRatio",dataIndex:"GeneRatio",key:"GeneRatio",ellipsis:!0,width:150},{title:"geneID",dataIndex:"geneID",key:"geneID",ellipsis:!0,width:150},{title:"Count",dataIndex:"Count",key:"Count",ellipsis:!0,width:150},{title:"pvalue",dataIndex:"pvalue",key:"pvalue",ellipsis:!0,width:150},{title:"p.adjust",dataIndex:"p.adjust",key:"p.adjust",ellipsis:!0,width:150},{title:"qvalue",dataIndex:"qvalue",key:"qvalue",ellipsis:!0,width:150},{title:"organism",dataIndex:"organism",key:"organism",ellipsis:!0,width:150},{title:"pathwayId",dataIndex:"pathwayId",key:"pathwayId",ellipsis:!0,width:150},{title:"操作",key:"action",fixed:"right",ellipsis:!0,width:200,render:(d,f)=>e.jsx(e.Fragment,{children:e.jsx(j,{onClick:()=>{i("KGMLMapSVG",f)},size:"small",color:"cyan",variant:"solid",children:"pathview"})})}]}),s.visible&&e.jsx(q,{width:"80%",title:`${(o=s.params)==null?void 0:o.Description}(${(l=s.params)==null?void 0:l.ID})`,footer:null,onCancel:n,onClose:n,open:s.visible&&s.key=="KGMLMapSVG",children:e.jsx(_e,{compound:r==null?void 0:r.compound,highlightKeys:(t=s.params)==null?void 0:t.geneID.split("/"),pathwayId:(c=s.params)==null?void 0:c.pathwayId,organisms:(h=s.params)==null?void 0:h.organism})})]})},nt={table:pe,string:Ye,html:et,json:Ze,text:Xe,info:Qe,kegg_map:st,download:tt},it=({type:r,...a})=>{const s=nt[r]||(()=>e.jsxs("div",{children:["未知类型 ",r]}));return e.jsx("div",{style:{marginBottom:"1rem"},children:e.jsx(s,{...a})})},wt=u.forwardRef(({params:r,visible:a,onClose:s},i)=>{const{output_dir:n,analysis_id:o}=r||{};return a?e.jsx(e.Fragment,{children:o&&e.jsx(rt,{onClose:s,analysis_id:o})}):null}),rt=({analysis_id:r,onClose:a,cancalReportCallback:s,openPanel:i,overflowY:n="hidden"})=>{var U,H;const[o,l]=u.useState(!1),[t,c]=u.useState(null),h=xe(),{eventSourceRef:d,status:f,reconnect:g}=ye(),x=u.useRef(null),m=u.useRef(null),y=ve(),{modals:v,openModals:w,closeModals:b}=re(["editParams","moduleEdit"]),{containerURL:S,project:p}=W(z=>z.user),[E,P]=u.useState(!1),[_]=C.useForm(),$=async z=>{l(!0);const A=await F.get(`/analysis/visualization-results/${z}`);c(A.data),_.resetFields(),_.setFieldsValue(A.data.request_param),x.current=z,l(!1)},G=z=>({...t==null?void 0:t.request_param,...z});return u.useEffect(()=>{$(r)},[r]),u.useEffect(()=>{var z;if(d){const A=L=>{const V=JSON.parse(L.data);m.current=V,x.current==V.analysis_id&&(V.event=="analysis_complete"||V.event=="analysis_failed"||V.event=="analysis_started")&&$(x.current)};return(z=d.current)==null||z.addEventListener("message",A),()=>{var L;console.log("removeEventListener"),(L=d.current)==null||L.removeEventListener("message",A)}}},[d.current]),e.jsx(e.Fragment,{children:e.jsxs(de,{size:"small",style:n=="auto"?{flex:1,display:"flex",flexDirection:"column",height:" 100%",boxShadow:"none"}:{boxShadow:"none"},styles:{body:{flex:1,display:"flex",flexDirection:"column",height:" 100%",overflowY:n}},variant:"borderless",title:e.jsx(e.Fragment,{children:t?e.jsxs(e.Fragment,{children:[e.jsx(k,{style:{cursor:"pointer"},onClick:()=>{h(`/component/${t==null?void 0:t.component_type}/${t==null?void 0:t.component_id}`)},children:t==null?void 0:t.component_name}),e.jsx(k,{children:t==null?void 0:t.analysis_name}),e.jsx(k,{children:String(t==null?void 0:t.analysis_id).slice(0,8)}),e.jsx(k,{children:t==null?void 0:t.job_status}),x.current==((U=m.current)==null?void 0:U.analysis_id)&&e.jsxs(k,{children:[" ",e.jsx(e.Fragment,{children:(H=m.current)==null?void 0:H.event})]})]}):e.jsx(e.Fragment,{})}),extra:e.jsxs(M,{gap:"small",wrap:!0,children:[i&&e.jsxs(e.Fragment,{children:[t&&e.jsxs(j,{size:"small",color:"primary",variant:"solid",onClick:()=>h(`/component/${t==null?void 0:t.component_type}/${t==null?void 0:t.component_id}`),children:["Go ",t==null?void 0:t.component_type]}),e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i("note")},children:"Open Note"})]}),a&&e.jsxs(e.Fragment,{children:[e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>a(),children:"Close"}),e.jsx(j,{size:"small",color:"primary",variant:"solid",onClick:()=>h(`/analysis-report?key=${t==null?void 0:t.analysis_id}&project=${p}`),children:"Go Report"})]}),t&&e.jsxs(e.Fragment,{children:[e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>{w("moduleEdit",{component_id:t==null?void 0:t.component_id})},children:"Component Code"}),e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>{w("editParams",t.analysis_id)},children:"Edit Parameters"}),(t==null?void 0:t.job_status)=="running"?e.jsx(e.Fragment,{children:e.jsx(I,{title:"Whether or not to stop?",onConfirm:async()=>{await Q(t.analysis_id,"job"),y.success("Stop Success")},children:e.jsx(j,{size:"small",color:"red",variant:"solid",children:"Stop"})})}):e.jsx(e.Fragment,{children:e.jsx(I,{title:"Whether or not to run?",onConfirm:async()=>{await Y(t.analysis_id,"job"),y.success("run successfully")},children:e.jsx(j,{size:"small",color:"cyan",variant:"solid",children:t.job_status=="created"?"Run":"Re-Run"})})}),(t==null?void 0:t.server_status)=="running"?e.jsxs(e.Fragment,{children:[e.jsx(we,{title:e.jsx(e.Fragment,{children:`${S}/container/${t.analysis_id}/`}),children:e.jsx(j,{size:"small",color:"blue",variant:"solid",onClick:()=>{window.open(`${S}/container/${t.analysis_id}/`,"_blank")},children:"Open URL"})}),e.jsx(I,{title:"Whether or not to stop?",onConfirm:async()=>{await Q(t.analysis_id,"server")},children:e.jsx(j,{size:"small",color:"red",variant:"solid",children:"Stop Server"})})]}):e.jsx(e.Fragment,{children:e.jsx(I,{title:"Whether to start the server?",onConfirm:async()=>{await Y(t.analysis_id,"server")},children:e.jsx(j,{size:"small",color:"cyan",variant:"solid",children:"Run Server"})})}),e.jsx(I,{title:t!=null&&t.is_report?"Whether to cancel the report?":"Reported or not?",onConfirm:async()=>{await F.post(`/analysis/update-report/${t==null?void 0:t.analysis_id}`),y.success("operate successfully!"),c(null),s&&s()},children:e.jsx(j,{size:"small",color:"cyan",variant:"solid",children:t!=null&&t.is_report?"Cancel Report":"Report"})})]}),e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>$(r),children:"Refresh"})]}),children:[(t==null?void 0:t.job_status)=="failed"?e.jsx("div",{style:{textAlign:"center"},children:e.jsx("div",{style:{flex:1,overflowY:"auto",marginBottom:"1rem"},children:e.jsx(Je,{file_path:t==null?void 0:t.command_log_path})})}):e.jsx(ue,{spinning:o,tip:"loading...",style:{minHeight:"5rem"},children:e.jsxs(ce,{gutter:[8,8],children:[e.jsx(N,{lg:16,sm:16,xs:24,children:(t==null?void 0:t.job_status)=="running"&&(t==null?void 0:t.run_type)!="server"?e.jsx(je,{active:!0}):e.jsx(e.Fragment,{children:r&&e.jsx(ot,{analsyisResult:t,loading:o})})}),e.jsxs(N,{lg:8,sm:8,xs:24,style:{borderLeft:"1px solid #f0f0f0"},children:[e.jsx(C,{form:_,layout:"vertical",children:(t==null?void 0:t.form_json)&&e.jsxs(e.Fragment,{children:[e.jsx(B,{formJson:t==null?void 0:t.form_json,dataMap:{}}),e.jsx(C.Item,{children:e.jsx(I,{title:"Whether to submit?",onConfirm:async()=>{if((t==null?void 0:t.job_status)=="running")y.error("Running, please wait!");else{const z=G(await _.validateFields());await F.post("/fast-api/analysis-controller?save=true&is_submit=true",z),console.log(z),y.success("Submit Success!")}},children:e.jsx(j,{disabled:(t==null?void 0:t.job_status)=="running",type:"primary",size:"small",children:"Submit"})})}),e.jsx(oe,{ghost:!0,items:[{key:"1",label:"More",children:e.jsx(e.Fragment,{children:e.jsx(C.Item,{noStyle:!0,shouldUpdate:!0,children:()=>e.jsx(D,{children:e.jsx("pre",{children:JSON.stringify(G(_.getFieldsValue()),null,2)})})})})}]})]})}),e.jsx(be,{}),e.jsx(Ce,{data:t==null?void 0:t.description})]})]})}),e.jsx(Ge,{callback:()=>$(r),visible:v.editParams.visible,params:v.editParams.params,onClose:()=>b("editParams")}),e.jsx(He,{visible:v.moduleEdit.visible,onClose:()=>b("moduleEdit"),callback:()=>$(r),params:v.moduleEdit.params})]})})},ot=({analsyisResult:r,loading:a})=>{const{baseURL:s}=W(n=>n.user),{projectObj:i}=W(n=>n.user);return e.jsx("div",{children:r&&e.jsxs(e.Fragment,{children:[r.images&&e.jsx("div",{style:{padding:"1rem"},children:Array.isArray(r.images)?e.jsx(ce,{gutter:{xs:8,sm:16,md:24,lg:32},children:r.images.map((n,o)=>e.jsx(N,{span:4,children:e.jsx(ie,{...n,baseURL:s})},o))}):e.jsx(e.Fragment,{children:e.jsx(ie,{...r.images,baseURL:s})})}),e.jsx("div",{style:{padding:"1rem"},children:r.tables&&Array.isArray(r.tables)&&e.jsx(e.Fragment,{children:r.tables.map((n,o)=>e.jsx(it,{projectObj:i,...n,baseURL:s},o))})})]})})};export{wt as A,Re as B,Ue as C,Ge as E,Je as L,He as M,qe as P,Ke as a,yt as b,it as c,rt as d,vt as f,Y as r,Q as s,jt as w};
