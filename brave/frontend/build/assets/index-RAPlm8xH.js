import{a as C,r as u,q as re,k as T,j as e,F as M,i as $,l as _,B as v,M as R,d as I,I as O,P as k,v as Q,m as oe,D as X,s as ae,a2 as W,c as le,Z as ce,u as V,S as de,t as he,R as ue,C as me,b as fe,p as pe}from"./main-qdx71IeZ.js";import ge from"./index-DnAAkqW2.js";import{C as ee}from"./index-EOZAs8C8.js";import{F as L}from"./index-enAFolCN.js";import{T as B}from"./index-CssIxjBA.js";import{F as te}from"./Table-BlsL6kCC.js";import{KGMLMapSVG as xe}from"./index-DcRhgt6q.js";import{S as se}from"./index-DzNw07ei.js";import{A as ye}from"./index-Bz6urQ5j.js";import{I as je}from"./index-BTiKGIIu.js";import{R as ve}from"./DownloadOutlined-lpdqma_y.js";const ct=async i=>await C.get("/file-operation/read-file",{params:{file_path:i}}),be=async(i,a=0)=>await C.get("/file-operation/read-log-file",{params:{file_path:i,offset:a}}),dt=async(i,a)=>await C.post("/file-operation/write-file",{file_path:i,content:a}),ht=async i=>await C.get(`/find-analysis-by-id/${i}`),N=async(i,a)=>await C.post(`/run-analysis-v2/${i}?run_type=${a}`),J=async(i,a)=>await C.post(`/analysis/stop-analysis/${i}?run_type=${a}`);function D(i,a,t){let r=t.initialDeps??[],n;function s(){var l,o,c,h;let d;t.key&&((l=t.debug)!=null&&l.call(t))&&(d=Date.now());const p=i();if(!(p.length!==r.length||p.some((m,y)=>r[y]!==m)))return n;r=p;let x;if(t.key&&((o=t.debug)!=null&&o.call(t))&&(x=Date.now()),n=a(...p),t.key&&((c=t.debug)!=null&&c.call(t))){const m=Math.round((Date.now()-d)*100)/100,y=Math.round((Date.now()-x)*100)/100,b=y/16,w=(j,S)=>{for(j=String(j);j.length<S;)j=" "+j;return j};console.info(`%c⏱ ${w(y,5)} /${w(m,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*b,120))}deg 100% 31%);`,t==null?void 0:t.key)}return(h=t==null?void 0:t.onChange)==null||h.call(t,n),n}return s.updateDeps=l=>{r=l},s}function K(i,a){if(i===void 0)throw new Error("Unexpected undefined");return i}const we=(i,a)=>Math.abs(i-a)<1.01,Se=(i,a,t)=>{let r;return function(...n){i.clearTimeout(r),r=i.setTimeout(()=>a.apply(this,n),t)}},q=i=>{const{offsetWidth:a,offsetHeight:t}=i;return{width:a,height:t}},Ce=i=>i,Fe=i=>{const a=Math.max(i.startIndex-i.overscan,0),t=Math.min(i.endIndex+i.overscan,i.count-1),r=[];for(let n=a;n<=t;n++)r.push(n);return r},_e=(i,a)=>{const t=i.scrollElement;if(!t)return;const r=i.targetWindow;if(!r)return;const n=l=>{const{width:o,height:c}=l;a({width:Math.round(o),height:Math.round(c)})};if(n(q(t)),!r.ResizeObserver)return()=>{};const s=new r.ResizeObserver(l=>{const o=()=>{const c=l[0];if(c!=null&&c.borderBoxSize){const h=c.borderBoxSize[0];if(h){n({width:h.inlineSize,height:h.blockSize});return}}n(q(t))};i.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(o):o()});return s.observe(t,{box:"border-box"}),()=>{s.unobserve(t)}},U={passive:!0},G=typeof window>"u"?!0:"onscrollend"in window,ze=(i,a)=>{const t=i.scrollElement;if(!t)return;const r=i.targetWindow;if(!r)return;let n=0;const s=i.options.useScrollendEvent&&G?()=>{}:Se(r,()=>{a(n,!1)},i.options.isScrollingResetDelay),l=d=>()=>{const{horizontal:p,isRtl:g}=i.options;n=p?t.scrollLeft*(g&&-1||1):t.scrollTop,s(),a(n,d)},o=l(!0),c=l(!1);c(),t.addEventListener("scroll",o,U);const h=i.options.useScrollendEvent&&G;return h&&t.addEventListener("scrollend",c,U),()=>{t.removeEventListener("scroll",o),h&&t.removeEventListener("scrollend",c)}},Ie=(i,a,t)=>{if(a!=null&&a.borderBoxSize){const r=a.borderBoxSize[0];if(r)return Math.round(r[t.options.horizontal?"inlineSize":"blockSize"])}return i[t.options.horizontal?"offsetWidth":"offsetHeight"]},Me=(i,{adjustments:a=0,behavior:t},r)=>{var n,s;const l=i+a;(s=(n=r.scrollElement)==null?void 0:n.scrollTo)==null||s.call(n,{[r.options.horizontal?"left":"top"]:l,behavior:t})};class Ee{constructor(a){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let t=null;const r=()=>t||(!this.targetWindow||!this.targetWindow.ResizeObserver?null:t=new this.targetWindow.ResizeObserver(n=>{n.forEach(s=>{const l=()=>{this._measureElement(s.target,s)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(l):l()})}));return{disconnect:()=>{var n;(n=r())==null||n.disconnect(),t=null},observe:n=>{var s;return(s=r())==null?void 0:s.observe(n,{box:"border-box"})},unobserve:n=>{var s;return(s=r())==null?void 0:s.unobserve(n)}}})(),this.range=null,this.setOptions=t=>{Object.entries(t).forEach(([r,n])=>{typeof n>"u"&&delete t[r]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:Ce,rangeExtractor:Fe,onChange:()=>{},measureElement:Ie,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...t}},this.notify=t=>{var r,n;(n=(r=this.options).onChange)==null||n.call(r,this,t)},this.maybeNotify=D(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),t=>{this.notify(t)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(t=>t()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var t;const r=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==r){if(this.cleanup(),!r){this.maybeNotify();return}this.scrollElement=r,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=((t=this.scrollElement)==null?void 0:t.window)??null,this.elementsCache.forEach(n=>{this.observer.observe(n)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,n=>{this.scrollRect=n,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(n,s)=>{this.scrollAdjustments=0,this.scrollDirection=s?this.getScrollOffset()<n?"forward":"backward":null,this.scrollOffset=n,this.isScrolling=s,this.maybeNotify()}))}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??(typeof this.options.initialOffset=="function"?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(t,r)=>{const n=new Map,s=new Map;for(let l=r-1;l>=0;l--){const o=t[l];if(n.has(o.lane))continue;const c=s.get(o.lane);if(c==null||o.end>c.end?s.set(o.lane,o):o.end<c.end&&n.set(o.lane,!0),n.size===this.options.lanes)break}return s.size===this.options.lanes?Array.from(s.values()).sort((l,o)=>l.end===o.end?l.index-o.index:l.end-o.end)[0]:void 0},this.getMeasurementOptions=D(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(t,r,n,s,l)=>(this.pendingMeasuredCacheIndexes=[],{count:t,paddingStart:r,scrollMargin:n,getItemKey:s,enabled:l}),{key:!1}),this.getMeasurements=D(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:t,paddingStart:r,scrollMargin:n,getItemKey:s,enabled:l},o)=>{if(!l)return this.measurementsCache=[],this.itemSizeCache.clear(),[];this.measurementsCache.length===0&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(d=>{this.itemSizeCache.set(d.key,d.size)}));const c=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];const h=this.measurementsCache.slice(0,c);for(let d=c;d<t;d++){const p=s(d),g=this.options.lanes===1?h[d-1]:this.getFurthestMeasurement(h,d),x=g?g.end+this.options.gap:r+n,m=o.get(p),y=typeof m=="number"?m:this.options.estimateSize(d),b=x+y,w=g?g.lane:d%this.options.lanes;h[d]={index:d,start:x,size:y,end:b,key:p,lane:w}}return this.measurementsCache=h,h},{key:!1,debug:()=>this.options.debug}),this.calculateRange=D(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(t,r,n,s)=>this.range=t.length>0&&r>0?ke({measurements:t,outerSize:r,scrollOffset:n,lanes:s}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=D(()=>{let t=null,r=null;const n=this.calculateRange();return n&&(t=n.startIndex,r=n.endIndex),this.maybeNotify.updateDeps([this.isScrolling,t,r]),[this.options.rangeExtractor,this.options.overscan,this.options.count,t,r]},(t,r,n,s,l)=>s===null||l===null?[]:t({startIndex:s,endIndex:l,overscan:r,count:n}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=t=>{const r=this.options.indexAttribute,n=t.getAttribute(r);return n?parseInt(n,10):(console.warn(`Missing attribute name '${r}={index}' on measured element.`),-1)},this._measureElement=(t,r)=>{const n=this.indexFromElement(t),s=this.measurementsCache[n];if(!s)return;const l=s.key,o=this.elementsCache.get(l);o!==t&&(o&&this.observer.unobserve(o),this.observer.observe(t),this.elementsCache.set(l,t)),t.isConnected&&this.resizeItem(n,this.options.measureElement(t,r,this))},this.resizeItem=(t,r)=>{const n=this.measurementsCache[t];if(!n)return;const s=this.itemSizeCache.get(n.key)??n.size,l=r-s;l!==0&&((this.shouldAdjustScrollPositionOnItemSizeChange!==void 0?this.shouldAdjustScrollPositionOnItemSizeChange(n,l,this):n.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=l,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(n.index),this.itemSizeCache=new Map(this.itemSizeCache.set(n.key,r)),this.notify(!1))},this.measureElement=t=>{if(!t){this.elementsCache.forEach((r,n)=>{r.isConnected||(this.observer.unobserve(r),this.elementsCache.delete(n))});return}this._measureElement(t,void 0)},this.getVirtualItems=D(()=>[this.getVirtualIndexes(),this.getMeasurements()],(t,r)=>{const n=[];for(let s=0,l=t.length;s<l;s++){const o=t[s],c=r[o];n.push(c)}return n},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=t=>{const r=this.getMeasurements();if(r.length!==0)return K(r[ne(0,r.length-1,n=>K(r[n]).start,t)])},this.getOffsetForAlignment=(t,r,n=0)=>{const s=this.getSize(),l=this.getScrollOffset();r==="auto"&&(r=t>=l+s?"end":"start"),r==="center"?t+=(n-s)/2:r==="end"&&(t-=s);const o=this.getTotalSize()+this.options.scrollMargin-s;return Math.max(Math.min(o,t),0)},this.getOffsetForIndex=(t,r="auto")=>{t=Math.max(0,Math.min(t,this.options.count-1));const n=this.measurementsCache[t];if(!n)return;const s=this.getSize(),l=this.getScrollOffset();if(r==="auto")if(n.end>=l+s-this.options.scrollPaddingEnd)r="end";else if(n.start<=l+this.options.scrollPaddingStart)r="start";else return[l,r];const o=r==="end"?n.end+this.options.scrollPaddingEnd:n.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(o,r,n.size),r]},this.isDynamicMode=()=>this.elementsCache.size>0,this.scrollToOffset=(t,{align:r="start",behavior:n}={})=>{n==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getOffsetForAlignment(t,r),{adjustments:void 0,behavior:n})},this.scrollToIndex=(t,{align:r="auto",behavior:n}={})=>{n==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),t=Math.max(0,Math.min(t,this.options.count-1));let s=0;const l=10,o=h=>{if(!this.targetWindow)return;const d=this.getOffsetForIndex(t,h);if(!d){console.warn("Failed to get offset for index:",t);return}const[p,g]=d;this._scrollToOffset(p,{adjustments:void 0,behavior:n}),this.targetWindow.requestAnimationFrame(()=>{const x=this.getScrollOffset(),m=this.getOffsetForIndex(t,g);if(!m){console.warn("Failed to get offset for index:",t);return}we(m[0],x)||c(g)})},c=h=>{this.targetWindow&&(s++,s<l?this.targetWindow.requestAnimationFrame(()=>o(h)):console.warn(`Failed to scroll to index ${t} after ${l} attempts.`))};o(r)},this.scrollBy=(t,{behavior:r}={})=>{r==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getScrollOffset()+t,{adjustments:void 0,behavior:r})},this.getTotalSize=()=>{var t;const r=this.getMeasurements();let n;if(r.length===0)n=this.options.paddingStart;else if(this.options.lanes===1)n=((t=r[r.length-1])==null?void 0:t.end)??0;else{const s=Array(this.options.lanes).fill(null);let l=r.length-1;for(;l>=0&&s.some(o=>o===null);){const o=r[l];s[o.lane]===null&&(s[o.lane]=o.end),l--}n=Math.max(...s.filter(o=>o!==null))}return Math.max(n-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(t,{adjustments:r,behavior:n})=>{this.options.scrollToFn(t,{behavior:n,adjustments:r},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(a)}}const ne=(i,a,t,r)=>{for(;i<=a;){const n=(i+a)/2|0,s=t(n);if(s<r)i=n+1;else if(s>r)a=n-1;else return n}return i>0?i-1:0};function ke({measurements:i,outerSize:a,scrollOffset:t,lanes:r}){const n=i.length-1,s=c=>i[c].start;if(i.length<=r)return{startIndex:0,endIndex:n};let l=ne(0,n,s,t),o=l;if(r===1)for(;o<n&&i[o].end<t+a;)o++;else if(r>1){const c=Array(r).fill(0);for(;o<n&&c.some(d=>d<t+a);){const d=i[o];c[d.lane]=d.end,o++}const h=Array(r).fill(t+a);for(;l>=0&&h.some(d=>d>=t);){const d=i[l];h[d.lane]=d.start,l--}l=Math.max(0,l-l%r),o=Math.min(n,o+(r-1-o%r))}return{startIndex:l,endIndex:o}}const H=typeof document<"u"?u.useLayoutEffect:u.useEffect;function De(i){const a=u.useReducer(()=>({}),{})[1],t={...i,onChange:(n,s)=>{var l;s?re.flushSync(a):a(),(l=i.onChange)==null||l.call(i,n,s)}},[r]=u.useState(()=>new Ee(t));return r.setOptions(t),H(()=>r._didMount(),[]),H(()=>r._willUpdate()),r}function Ae(i){return De({observeElementRect:_e,observeElementOffset:ze,scrollToFn:Me,...i})}const{Text:Y}=$,Oe=({file_path:i})=>{var h;u.useEffect(()=>{console.log("fileKey",i),i&&s(i)},[i]);const{messageApi:a}=T(),t=u.useRef(0),[r,n]=u.useState([]),s=async(d,p=!1)=>{const g=await be(d);t.current=g.data.offset,n(g.data.content),p&&a.success(`日志加载成功: ${d}`)},l=u.useRef(null),o=Ae({count:r.length,getScrollElement:()=>l.current,estimateSize:()=>30,overscan:10});u.useEffect(()=>{(r==null?void 0:r.length)>0&&o.scrollToIndex(r.length-1,{align:"end",behavior:"smooth"})},[r==null?void 0:r.length]);const c=o.getVirtualItems();return e.jsx(ee,{size:"small",extra:e.jsx(v,{size:"small",type:"primary",onClick:()=>{s(i)},children:"Refresh Log"}),title:e.jsxs(M,{gap:"small",wrap:"wrap",children:[e.jsxs(_,{color:"blue",children:["File: ",i]}),e.jsxs(_,{color:"purple",children:["Offset: ",t.current]})]}),bodyStyle:{padding:0},children:e.jsx("div",{ref:l,style:{height:400,overflowY:"auto",fontFamily:"monospace",backgroundColor:"#1e1e1e",color:"#d4d4d4",padding:"0 12px"},children:e.jsx("div",{style:{height:o.getTotalSize(),width:"100%",position:"relative"},children:e.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${((h=c[0])==null?void 0:h.start)??0}px)`},children:c.map(d=>e.jsx("div",{"data-index":d.index,ref:o.measureElement,style:{padding:"4px 0",borderBottom:"1px solid #333"},children:e.jsxs(M,{gap:"middle",children:[e.jsxs(Y,{type:"secondary",style:{width:60,color:"#d4d4d4"},children:["#",d.index+1]}),e.jsx(Y,{style:{whiteSpace:"pre-wrap",color:"#d4d4d4"},children:r[d.index]})]})},d.key))})})})})},$e=({visible:i,onClose:a,params:t})=>e.jsx(R,{footer:null,title:"参数",width:"50%",open:i,onCancel:a,children:e.jsx($,{children:e.jsx("pre",{children:JSON.stringify(t,null,2)})})}),Ve=({formJson:i,openModal:a})=>{if(!i)return null;const[t,r]=u.useState([]),n=async()=>{const s=i.map(c=>c.dataKey),o=((await C.post("/list-bio-database",{type_list:s})).data||[]).reduce((c,h)=>{const d=h.type;c[d]||(c[d]=[]);const{name:p,database_id:g,...x}=h;return c[d].push({label:p,value:g,...x}),c},{});r(o),console.log(o)};return u.useEffect(()=>{n()},[i]),e.jsx(e.Fragment,{children:e.jsxs(M,{gap:"small",children:[e.jsx("div",{style:{flex:1},children:e.jsx(L,{formJson:i,dataMap:t})}),e.jsx(v,{size:"small",color:"cyan",variant:"solid",onClick:a,children:"配置数据库"}),e.jsx(v,{onClick:n,size:"small",type:"primary",children:"刷新"})]})})},Te=({visible:i,onClose:a,params:t,callback:r})=>{if(!i)return null;const[n,s]=u.useState([]),[l,o]=u.useState(!1),[c]=I.useForm(),[h,d]=u.useState(t[0].dataKey),[p,g]=u.useState(null),x=async f=>{o(!0);const F=await C.post("/list-bio-database",f);s(F.data),o(!1)},m=async()=>({...await c.validateFields(),type:h}),y=async()=>{const f=await m();p?await C.post("/update-bio-database",{...f,database_id:p.database_id}):await C.post("/add-bio-database",f),b(),g(void 0),c.resetFields()},b=()=>{x({type:h})};u.useEffect(()=>{x({type:h})},[t]);const w=f=>{d(f),x({type:f})},j=async f=>{await C.delete(`/delete-bio-database/${f.id}`),b()},S=f=>{c.setFieldsValue(f),g(f)};return e.jsxs(R,{title:"数据库操作",open:i,onCancel:a,width:"50%",footer:null,children:[e.jsx(B,{tabBarExtraContent:e.jsxs(e.Fragment,{children:[e.jsx(v,{size:"small",color:"cyan",variant:"solid",style:{marginRight:"0.5rem"},type:"primary",onClick:b,children:" 刷新"}),e.jsxs(v,{size:"small",color:"cyan",variant:"solid",type:"primary",onClick:()=>{g(void 0),y()},children:[" ",p?"更新":"添加"]})]}),activeKey:h,onChange:w,items:t.map(f=>({key:f.name,label:f.label,children:e.jsx("div",{})}))}),e.jsxs(I,{form:c,style:{maxWidth:600},labelCol:{span:3},children:[e.jsx(I.Item,{name:"name",label:"名称",rules:[{required:!0,message:"请输入名称"}],children:e.jsx(O,{})}),e.jsx(I.Item,{name:"path",label:"路径",rules:[{required:!0,message:"请输入路径"}],children:e.jsx(O,{})}),e.jsx(I.Item,{name:"db_index",label:"索引",children:e.jsx(O,{})})]}),e.jsx(te,{dataSource:n,columns:[{title:"名称",dataIndex:"name",key:"name"},{title:"数据库ID",dataIndex:"database_id",key:"database_id"},{title:"类型",dataIndex:"type",key:"type"},{title:"路径",dataIndex:"path",key:"path"},{title:"索引",dataIndex:"db_index",key:"db_index"},{title:"操作",dataIndex:"action",key:"action",ellipsis:!0,render:(f,F)=>e.jsxs(M,{gap:"small",children:[e.jsx(k,{title:"确定删除吗？",onConfirm:()=>{j(F)},children:e.jsx(v,{size:"small",type:"primary",danger:!0,children:"删除"})}),e.jsx(v,{size:"small",type:"primary",onClick:()=>{S(F)},children:"编辑"})]})}],loading:l,pagination:!1})]})},Le=({visible:i,params:a,onClose:t,callback:r})=>{var b,w,j;const[n]=I.useForm(),{messageApi:s,project:l}=T();u.useEffect(()=>{i&&m()},[a]);const[o,c]=u.useState(),[h,d]=u.useState(),p=()=>{t(),r&&r()},[g,x]=u.useState(),m=async()=>{x(!0);const S=await C.post(`/analysis/edit-params/${a}`);c(S.data),d(S.data.analysis_result),n.resetFields(),n.setFieldsValue(S.data.request_param),x(!1)},y=S=>{if(S&&Object.keys(S).length>0)return Object.keys(S)[0]};return e.jsx(e.Fragment,{children:e.jsx(X,{size:"default",loading:g,title:e.jsx(e.Fragment,{children:o&&e.jsxs(e.Fragment,{children:[e.jsx(_,{children:o==null?void 0:o.component_name}),e.jsx(_,{children:o==null?void 0:o.analysis_name}),e.jsx(_,{children:String(o==null?void 0:o.analysis_id).slice(0,8)})]})}),width:"50%",open:i,onClose:t,children:o&&e.jsx(e.Fragment,{children:e.jsx(Re,{form:n,requestParam:{...o.request_param,analysis_id:o==null?void 0:o.analysis_id},dataMap:{...h,first_data_key:y(h)},formJson:[...((b=o.content)==null?void 0:b.formJson)||[],...((w=o.content)==null?void 0:w.upstreamFormJson)||[],...(o==null?void 0:o.inputFormJson)||[],(o==null?void 0:o.component_type)=="software"?{name:"group_field",label:"Group Field",rules:[{required:!0,message:"该字段不能为空!"}],type:"GroupFieldSelect"}:{}],databases:(j=o.content)==null?void 0:j.databases,upstreamFormJson:o==null?void 0:o.upstreamFormJson,callback:p})})})})},Re=({form:i,requestParam:a,dataMap:t,formJson:r,databases:n,callback:s,showCancal:l=!1})=>{const{modals:o,openModals:c,closeModals:h}=Q(["paramsView","bioDatabases"]),[d,p]=u.useState([]),[g,x]=u.useState([]),{messageApi:m}=T();u.useEffect(()=>{y()},[JSON.stringify(r)]);const y=()=>{if(Array.isArray(r)){const j=r.filter(f=>!(f!=null&&f.required)&&!(f!=null&&f.db)&&!f.component_id),S=r.filter(f=>(f==null?void 0:f.required)||(f==null?void 0:f.db)||f.component_id);p(S),x(j)}},b=j=>({...a,...j}),w=async(j,S=!1)=>{var E;const f=await i.validateFields(),F=b(f);try{const z=await C.post(`/fast-api/analysis-controller?save=${j}&is_submit=${S}`,F);console.log(z),j?(m.success("执行成功!"),s&&s()):c("paramsView",z.data)}catch(z){console.log(z),(E=z.response)!=null&&E.data&&m.error(z.response.data.detail)}};return e.jsxs(e.Fragment,{children:[e.jsxs(I,{form:i,onValuesChange:(j,S)=>{},children:[e.jsx(B,{items:[{key:"1",label:"Required Parameters",forceRender:!0,children:e.jsxs(e.Fragment,{children:[e.jsx(L,{formJson:[...d],dataMap:t}),n&&e.jsx(Ve,{openModal:()=>{c("bioDatabases",n)},formJson:n})]})},{key:"2",label:"Optional parameters",forceRender:!0,children:e.jsx(e.Fragment,{children:e.jsx(L,{formJson:[...g],dataMap:{}})})}]}),e.jsx(I.Item,{label:"Analysyis Name",name:"analysis_name",style:{maxWidth:600},rules:[{required:!0,message:"This field cannot be empty!"}],children:e.jsx(O,{})}),e.jsxs(M,{gap:"small",children:[e.jsx(v,{size:"small",color:"cyan",variant:"solid",onClick:()=>{w(!1)},children:"View Parameters"}),e.jsx(v,{size:"small",color:"cyan",variant:"solid",onClick:()=>w(!0),children:a!=null&&a.analysis_id?e.jsxs(e.Fragment,{children:["Update Analysis(",a.analysis_name,")(",String(a.analysis_id).slice(0,8),")"]}):e.jsx(e.Fragment,{children:"Save Analysis"})}),(a==null?void 0:a.analysis_id)&&l&&e.jsx(v,{size:"small",color:"cyan",onClick:()=>i.setFieldValue("analysis_id",void 0),children:"Cancel Analysis"})]}),e.jsx(oe,{ghost:!0,items:[{key:"1",label:"更多",children:e.jsx(e.Fragment,{children:e.jsx(I.Item,{noStyle:!0,shouldUpdate:!0,children:()=>e.jsx($,{children:e.jsx("pre",{children:JSON.stringify(b(i.getFieldsValue()),null,2)})})})})}]})]}),e.jsx($e,{visible:o.paramsView.visible,onClose:()=>h("paramsView"),params:o.paramsView.params}),e.jsx(Te,{visible:o.bioDatabases.visible,onClose:()=>h("bioDatabases"),params:o.bioDatabases.params})]})},We=({visible:i,onClose:a,params:t,callback:r})=>{if(!i)return null;const[n,s]=u.useState(),[l,o]=ae.useMessage(),[c,h]=u.useState("main"),d=u.useRef(null),p=async g=>{try{const x=await C.get(`/get-component-module-content/${g.component_id}?script_name=${c}`);console.log(x),s(x.data)}catch(x){l.error(`${x.response.data.detail}`)}};return u.useEffect(()=>{p(t)},[JSON.stringify(t),c]),e.jsxs(e.Fragment,{children:[o,e.jsxs(X,{extra:e.jsxs(M,{justify:"flex-end",gap:"small",children:[e.jsx(k,{title:"是否生成脚本",onConfirm:async()=>{await C.post(`/component/convert-ipynb/${t.component_id}`),l.success("是否生成脚本成功!"),p(t)},children:e.jsx(v,{size:"small",color:"cyan",variant:"solid",children:"生成脚本"})}),e.jsx(v,{size:"small",color:"cyan",variant:"solid",onClick:()=>{p(t)},children:"刷新"}),e.jsx(v,{size:"small",color:"cyan",variant:"solid",onClick:()=>{d.current.setValue(n==null?void 0:n.content)},children:"保存"})]}),title:"查看文件",open:i,onClose:a,width:"50%",children:[e.jsx("ul",{children:e.jsxs("li",{children:["path:",n==null?void 0:n.path]})}),e.jsx("hr",{}),e.jsx(B,{onChange:g=>{h(g)},items:[{label:"main",key:"main"},{label:"input_parse",key:"input_parse"},{label:"output_parse",key:"output_parse"}]}),e.jsx(W,{value:n==null?void 0:n.content,editorRef:d,defaultLanguage:"python"})]})]})},P=({url:i,filename:a,baseURL:t})=>e.jsx(e.Fragment,{children:i&&e.jsx(pe,{title:`${t}${i}`,children:e.jsxs(_,{color:"success",style:{cursor:"pointer",whiteSpace:"normal",wordBreak:"break-all",display:"inline-block"},onClick:()=>{window.open(`${t}${i}?t=${Date.now()}`,"_blank")},children:[e.jsxs("span",{children:[a," "]}),e.jsx(ve,{})]})})}),ie=({data:i,url:a,filename:t,columns:r,baseURL:n,projectObj:s})=>{const{Search:l}=O,[o,c]=u.useState([]),[h,d]=u.useState(),[p,g]=u.useState();u.useEffect(()=>{if(s!=null&&s.research)try{const m=JSON.parse((s==null?void 0:s.research)||"{}");d(m)}catch{}},[s==null?void 0:s.research]);const x=m=>m?Object.keys(m).map(y=>({title:y,dataIndex:y,key:y,ellipsis:!0,width:150})):[];return u.useEffect(()=>{if(i){const m=i.map((y,b)=>({...y,key:b}));c(m)}},[i]),e.jsxs(e.Fragment,{children:[(h==null?void 0:h.table)&&e.jsx(e.Fragment,{children:e.jsx("div",{style:{marginBottom:"1rem"},children:h==null?void 0:h.table.map(m=>e.jsx(_,{color:"blue",style:{cursor:"pointer"},onClick:()=>{const y=i.filter(b=>Object.values(b).some(w=>typeof w=="string"&&w.includes(m)));c(y),g(m)},children:m},m))})}),Array.isArray(o)&&e.jsx(e.Fragment,{children:e.jsx(te,{style:{border:"1px solid #f0f0f0"},size:"small",title:()=>e.jsxs(M,{gap:"small",children:[e.jsx(l,{value:p,size:"small",onChange:m=>{g(m.target.value)},placeholder:"input search text",allowClear:!0,onSearch:m=>{const y=i.filter(b=>Object.values(b).some(w=>typeof w=="string"&&w.includes(m)));c(y)},style:{width:304}}),e.jsx(P,{url:a,filename:t,baseURL:n})]}),scroll:{x:"max-content",y:55*5},dataSource:o,pagination:!1,virtual:!0,columns:r||x(i[0]),footer:()=>`A total of ${i.length} records`})})]})},Z=({data:i,url:a,filename:t,baseURL:r})=>e.jsx("div",{children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx(je,{src:t!=null&&t.endsWith("pdf")?i:`${i}?t=${Date.now()}`,style:{maxWidth:"20rem",marginRight:"0.5rem"}}),e.jsx(P,{url:a,filename:t,baseURL:r})]})}),{Paragraph:ut}=$,Be=({data:i})=>e.jsx(e.Fragment,{children:e.jsx(W,{value:i})}),Pe=({data:i})=>e.jsx("div",{children:e.jsx(ye,{closable:!0,message:i,type:"info",showIcon:!0})}),Ne=({data:i})=>e.jsx(e.Fragment,{children:e.jsx($,{children:e.jsx("pre",{style:{margin:0},children:i})})}),Je=({data:i})=>e.jsx(e.Fragment,{children:e.jsx(W,{value:i,defaultLanguage:"json"})}),Ke=({data:i,url:a})=>{const{baseURL:t}=V(s=>s.user),[r,n]=u.useState(!0);return e.jsx(e.Fragment,{children:e.jsxs("div",{style:{position:"relative",width:"100%",height:"80vh"},children:[r&&e.jsx("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.8)",zIndex:1},children:e.jsx(se,{size:"large",tip:"Loading..."})}),e.jsx("iframe",{src:`${t}${a}`,width:"100%",style:{height:"100%",border:"none"},onLoad:()=>n(!1),title:"content-frame"})]})})},qe=({url:i,filename:a,baseURL:t})=>e.jsx(e.Fragment,{children:e.jsx(P,{url:i,filename:a,baseURL:t})}),Ue=({data:i,...a})=>{var s,l,o,c,h;const{modal:t,openModal:r,closeModal:n}=fe();return e.jsxs(e.Fragment,{children:[e.jsx(ie,{data:i==null?void 0:i.list,...a,columns:[{title:"ID",dataIndex:"ID",key:"ID",ellipsis:!0,width:150},{title:"Description",dataIndex:"Description",key:"Description",ellipsis:!0,width:400},{title:"GeneRatio",dataIndex:"GeneRatio",key:"GeneRatio",ellipsis:!0,width:150},{title:"geneID",dataIndex:"geneID",key:"geneID",ellipsis:!0,width:150},{title:"Count",dataIndex:"Count",key:"Count",ellipsis:!0,width:150},{title:"pvalue",dataIndex:"pvalue",key:"pvalue",ellipsis:!0,width:150},{title:"p.adjust",dataIndex:"p.adjust",key:"p.adjust",ellipsis:!0,width:150},{title:"qvalue",dataIndex:"qvalue",key:"qvalue",ellipsis:!0,width:150},{title:"organism",dataIndex:"organism",key:"organism",ellipsis:!0,width:150},{title:"pathwayId",dataIndex:"pathwayId",key:"pathwayId",ellipsis:!0,width:150},{title:"操作",key:"action",fixed:"right",ellipsis:!0,width:200,render:(d,p)=>e.jsx(e.Fragment,{children:e.jsx(v,{onClick:()=>{r("KGMLMapSVG",p)},size:"small",color:"cyan",variant:"solid",children:"pathview"})})}]}),t.visible&&e.jsx(R,{width:"80%",title:`${(s=t.params)==null?void 0:s.Description}(${(l=t.params)==null?void 0:l.ID})`,footer:null,onCancel:n,onClose:n,open:t.visible&&t.key=="KGMLMapSVG",children:e.jsx(xe,{compound:i==null?void 0:i.compound,highlightKeys:(o=t.params)==null?void 0:o.geneID.split("/"),pathwayId:(c=t.params)==null?void 0:c.pathwayId,organisms:(h=t.params)==null?void 0:h.organism})})]})},Ge={table:ie,string:Be,html:Ke,json:Je,text:Ne,info:Pe,kegg_map:Ue,download:qe},He=({type:i,...a})=>{const t=Ge[i]||(()=>e.jsxs("div",{children:["未知类型 ",i]}));return e.jsx("div",{style:{marginBottom:"1rem"},children:e.jsx(t,{...a})})},mt=u.forwardRef(({params:i,visible:a,onClose:t},r)=>{const{output_dir:n,analysis_id:s}=i||{};return a?e.jsx(e.Fragment,{children:s&&e.jsx(Ye,{onClose:t,analysis_id:s})}):null}),Ye=({analysis_id:i,onClose:a,cancalReportCallback:t})=>{var S,f;const[r,n]=u.useState(!1),[s,l]=u.useState(null),o=le(),{eventSourceRef:c,status:h,reconnect:d}=ce(),p=u.useRef(null),g=u.useRef(null),{messageApi:x}=T(),{modals:m,openModals:y,closeModals:b}=Q(["editParams","moduleEdit"]),{containerURL:w}=V(F=>F.user),j=async F=>{n(!0);const E=await C.get(`/analysis/visualization-results/${F}`);l(E.data),p.current=F,n(!1)};return u.useEffect(()=>{j(i)},[i]),u.useEffect(()=>{var F;if(c){const E=z=>{const A=JSON.parse(z.data);g.current=A,p.current==A.analysis_id&&(A.event=="analysis_complete"||A.event=="analysis_failed"||A.event=="analysis_started")&&j(p.current)};return(F=c.current)==null||F.addEventListener("message",E),()=>{var z;console.log("removeEventListener"),(z=c.current)==null||z.removeEventListener("message",E)}}},[c.current]),e.jsx(e.Fragment,{children:e.jsxs(ee,{size:"small",bodyStyle:{padding:0},title:e.jsx(e.Fragment,{children:s?e.jsxs(e.Fragment,{children:[e.jsx(_,{style:{cursor:"pointer"},onClick:()=>{o(`/component/${s==null?void 0:s.component_type}/${s==null?void 0:s.component_id}`)},children:s==null?void 0:s.component_name}),e.jsx(_,{children:s==null?void 0:s.analysis_name}),e.jsx(_,{children:String(s==null?void 0:s.analysis_id).slice(0,8)}),e.jsx(_,{children:s==null?void 0:s.job_status}),p.current==((S=g.current)==null?void 0:S.analysis_id)&&e.jsxs(_,{children:[" ",e.jsx(e.Fragment,{children:(f=g.current)==null?void 0:f.event})]})]}):e.jsx(e.Fragment,{})}),extra:e.jsxs(M,{gap:"small",children:[a&&e.jsx(v,{size:"small",color:"cyan",variant:"solid",onClick:()=>a(),children:"Close"}),s&&e.jsxs(e.Fragment,{children:[e.jsx(v,{size:"small",color:"cyan",variant:"solid",onClick:()=>{y("editParams",s.analysis_id)},children:"Edit Parameters"}),e.jsx(v,{size:"small",color:"cyan",variant:"solid",onClick:()=>{y("moduleEdit",{component_id:s==null?void 0:s.component_id})},children:"Component Code"}),s.server_status=="running"?e.jsxs(e.Fragment,{children:[e.jsx(he,{title:e.jsx(e.Fragment,{children:`${w}/container/${s.analysis_id}/`}),children:e.jsx(v,{size:"small",color:"blue",variant:"solid",onClick:()=>{window.open(`${w}/container/${s.analysis_id}/`,"_blank")},children:"Open URL"})}),e.jsx(k,{title:"Whether or not to stop?",onConfirm:async()=>{await J(s.analysis_id,"server")},children:e.jsx(v,{size:"small",color:"red",variant:"solid",children:"Stop Server"})})]}):e.jsx(e.Fragment,{children:e.jsx(k,{title:"Whether to start the server?",onConfirm:async()=>{await N(s.analysis_id,"server")},children:e.jsx(v,{size:"small",color:"cyan",variant:"solid",children:"Run Server"})})}),(s==null?void 0:s.job_status)=="running"?e.jsx(e.Fragment,{children:e.jsx(k,{title:"Whether or not to stop?",onConfirm:async()=>{await J(s.analysis_id,"job"),x.success("Stop Success")},children:e.jsx(v,{size:"small",color:"cyan",variant:"solid",children:"Stop"})})}):e.jsx(e.Fragment,{children:e.jsx(k,{title:"Whether or not to run?",onConfirm:async()=>{await N(s.analysis_id,"job"),x.success("run successfully")},children:e.jsx(v,{size:"small",color:"cyan",variant:"solid",children:s.job_status=="created"?"Run":"Rerun"})})})]}),e.jsx(k,{title:s!=null&&s.is_report?"Whether to cancel the report?":"Reported or not?",onConfirm:async()=>{await C.post(`/analysis/update-report/${s==null?void 0:s.analysis_id}`),x.success("operate successfully!"),l(null),t&&t()},children:e.jsx(v,{size:"small",color:"cyan",variant:"solid",children:s!=null&&s.is_report?"Cancel Report":"Report"})}),e.jsx(v,{size:"small",color:"cyan",variant:"solid",onClick:()=>j(i),children:"Refresh"})]}),children:[(s==null?void 0:s.job_status)=="failed"?e.jsx("div",{style:{textAlign:"center"},children:e.jsx(Oe,{file_path:s==null?void 0:s.command_log_path})}):e.jsx(e.Fragment,{children:(s==null?void 0:s.job_status)=="running"&&(s==null?void 0:s.run_type)!="server"?e.jsx(de,{active:!0}):e.jsx(e.Fragment,{children:i&&e.jsx(Ze,{analsyisResult:s,loading:r})})}),e.jsx(Le,{callback:()=>j(i),visible:m.editParams.visible,params:m.editParams.params,onClose:()=>b("editParams")}),e.jsx(We,{visible:m.moduleEdit.visible,onClose:()=>b("moduleEdit"),callback:()=>j(i),params:m.moduleEdit.params})]})})},Ze=({analsyisResult:i,loading:a})=>{const{baseURL:t}=V(n=>n.user),{projectObj:r}=V(n=>n.user);return e.jsxs(se,{spinning:a,children:[i&&e.jsxs(e.Fragment,{children:[i.images&&e.jsx("div",{style:{marginBottom:"1rem",padding:"1rem",borderBottom:"1px solid #f0f0f0"},children:Array.isArray(i.images)?e.jsx(ue,{gutter:{xs:8,sm:16,md:24,lg:32},children:i.images.map((n,s)=>e.jsx(me,{span:4,children:e.jsx(Z,{...n,baseURL:t})},s))}):e.jsx(e.Fragment,{children:e.jsx(Z,{...i.images,baseURL:t})})}),e.jsx("div",{style:{padding:"1rem"},children:i.tables&&Array.isArray(i.tables)&&e.jsx(e.Fragment,{children:i.tables.map((n,s)=>e.jsx(He,{projectObj:r,...n,baseURL:t},s))})})]}),e.jsx(ge,{data:i==null?void 0:i.description})]})};export{mt as A,Te as B,Re as C,Le as E,Oe as L,We as M,$e as P,Ve as a,ct as b,He as c,Ye as d,ht as f,N as r,J as s,dt as w};
