import{a as F,r as u,q as me,k as P,j as e,F as D,i as A,l as I,B as j,M as N,d as C,I as T,P as E,v as ne,m as ie,D as re,s as fe,a2 as oe,c as pe,$ as ge,u as W,R as ae,C as B,S as xe,y as ye,aS as je,t as ve,b as be,p as we}from"./main-CoRdKxM6.js";import Se from"./index-Cl14Vxoo.js";import{C as le}from"./index-mKsixq-F.js";import{F as R}from"./index-DeUYg7UX.js";import{T as J}from"./index-BHj1h2oY.js";import{F as ce}from"./Table-C-94KlQV.js";import{KGMLMapSVG as Fe}from"./index-DD8IFb_f.js";import{S as de}from"./index-Cww7bxT4.js";import{A as Ce}from"./index-BdK9PNzv.js";import{I as _e}from"./index-BlGESwK1.js";import{R as ze}from"./DownloadOutlined-DnjYLYJT.js";const gt=async r=>await F.get("/file-operation/read-file",{params:{file_path:r}}),Ie=async(r,l=0)=>await F.get("/file-operation/read-log-file",{params:{file_path:r,offset:l}}),xt=async(r,l)=>await F.post("/file-operation/write-file",{file_path:r,content:l}),yt=async r=>await F.get(`/find-analysis-by-id/${r}`),G=async(r,l)=>await F.post(`/run-analysis-v2/${r}?run_type=${l}`),H=async(r,l)=>await F.post(`/analysis/stop-analysis/${r}?run_type=${l}`);function $(r,l,t){let i=t.initialDeps??[],s;function a(){var n,o,c,d;let h;t.key&&((n=t.debug)!=null&&n.call(t))&&(h=Date.now());const g=r();if(!(g.length!==i.length||g.some((m,y)=>i[y]!==m)))return s;i=g;let x;if(t.key&&((o=t.debug)!=null&&o.call(t))&&(x=Date.now()),s=l(...g),t.key&&((c=t.debug)!=null&&c.call(t))){const m=Math.round((Date.now()-h)*100)/100,y=Math.round((Date.now()-x)*100)/100,v=y/16,w=(b,S)=>{for(b=String(b);b.length<S;)b=" "+b;return b};console.info(`%c⏱ ${w(y,5)} /${w(m,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*v,120))}deg 100% 31%);`,t==null?void 0:t.key)}return(d=t==null?void 0:t.onChange)==null||d.call(t,s),s}return a.updateDeps=n=>{i=n},a}function Y(r,l){if(r===void 0)throw new Error("Unexpected undefined");return r}const Me=(r,l)=>Math.abs(r-l)<1.01,ke=(r,l,t)=>{let i;return function(...s){r.clearTimeout(i),i=r.setTimeout(()=>l.apply(this,s),t)}},Q=r=>{const{offsetWidth:l,offsetHeight:t}=r;return{width:l,height:t}},Ee=r=>r,De=r=>{const l=Math.max(r.startIndex-r.overscan,0),t=Math.min(r.endIndex+r.overscan,r.count-1),i=[];for(let s=l;s<=t;s++)i.push(s);return i},Ae=(r,l)=>{const t=r.scrollElement;if(!t)return;const i=r.targetWindow;if(!i)return;const s=n=>{const{width:o,height:c}=n;l({width:Math.round(o),height:Math.round(c)})};if(s(Q(t)),!i.ResizeObserver)return()=>{};const a=new i.ResizeObserver(n=>{const o=()=>{const c=n[0];if(c!=null&&c.borderBoxSize){const d=c.borderBoxSize[0];if(d){s({width:d.inlineSize,height:d.blockSize});return}}s(Q(t))};r.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(o):o()});return a.observe(t,{box:"border-box"}),()=>{a.unobserve(t)}},X={passive:!0},Z=typeof window>"u"?!0:"onscrollend"in window,Oe=(r,l)=>{const t=r.scrollElement;if(!t)return;const i=r.targetWindow;if(!i)return;let s=0;const a=r.options.useScrollendEvent&&Z?()=>{}:ke(i,()=>{l(s,!1)},r.options.isScrollingResetDelay),n=h=>()=>{const{horizontal:g,isRtl:p}=r.options;s=g?t.scrollLeft*(p&&-1||1):t.scrollTop,a(),l(s,h)},o=n(!0),c=n(!1);c(),t.addEventListener("scroll",o,X);const d=r.options.useScrollendEvent&&Z;return d&&t.addEventListener("scrollend",c,X),()=>{t.removeEventListener("scroll",o),d&&t.removeEventListener("scrollend",c)}},$e=(r,l,t)=>{if(l!=null&&l.borderBoxSize){const i=l.borderBoxSize[0];if(i)return Math.round(i[t.options.horizontal?"inlineSize":"blockSize"])}return r[t.options.horizontal?"offsetWidth":"offsetHeight"]},Ve=(r,{adjustments:l=0,behavior:t},i)=>{var s,a;const n=r+l;(a=(s=i.scrollElement)==null?void 0:s.scrollTo)==null||a.call(s,{[i.options.horizontal?"left":"top"]:n,behavior:t})};class Te{constructor(l){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let t=null;const i=()=>t||(!this.targetWindow||!this.targetWindow.ResizeObserver?null:t=new this.targetWindow.ResizeObserver(s=>{s.forEach(a=>{const n=()=>{this._measureElement(a.target,a)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(n):n()})}));return{disconnect:()=>{var s;(s=i())==null||s.disconnect(),t=null},observe:s=>{var a;return(a=i())==null?void 0:a.observe(s,{box:"border-box"})},unobserve:s=>{var a;return(a=i())==null?void 0:a.unobserve(s)}}})(),this.range=null,this.setOptions=t=>{Object.entries(t).forEach(([i,s])=>{typeof s>"u"&&delete t[i]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:Ee,rangeExtractor:De,onChange:()=>{},measureElement:$e,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...t}},this.notify=t=>{var i,s;(s=(i=this.options).onChange)==null||s.call(i,this,t)},this.maybeNotify=$(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),t=>{this.notify(t)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(t=>t()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var t;const i=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==i){if(this.cleanup(),!i){this.maybeNotify();return}this.scrollElement=i,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=((t=this.scrollElement)==null?void 0:t.window)??null,this.elementsCache.forEach(s=>{this.observer.observe(s)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,s=>{this.scrollRect=s,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(s,a)=>{this.scrollAdjustments=0,this.scrollDirection=a?this.getScrollOffset()<s?"forward":"backward":null,this.scrollOffset=s,this.isScrolling=a,this.maybeNotify()}))}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??(typeof this.options.initialOffset=="function"?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(t,i)=>{const s=new Map,a=new Map;for(let n=i-1;n>=0;n--){const o=t[n];if(s.has(o.lane))continue;const c=a.get(o.lane);if(c==null||o.end>c.end?a.set(o.lane,o):o.end<c.end&&s.set(o.lane,!0),s.size===this.options.lanes)break}return a.size===this.options.lanes?Array.from(a.values()).sort((n,o)=>n.end===o.end?n.index-o.index:n.end-o.end)[0]:void 0},this.getMeasurementOptions=$(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(t,i,s,a,n)=>(this.pendingMeasuredCacheIndexes=[],{count:t,paddingStart:i,scrollMargin:s,getItemKey:a,enabled:n}),{key:!1}),this.getMeasurements=$(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:t,paddingStart:i,scrollMargin:s,getItemKey:a,enabled:n},o)=>{if(!n)return this.measurementsCache=[],this.itemSizeCache.clear(),[];this.measurementsCache.length===0&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(h=>{this.itemSizeCache.set(h.key,h.size)}));const c=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];const d=this.measurementsCache.slice(0,c);for(let h=c;h<t;h++){const g=a(h),p=this.options.lanes===1?d[h-1]:this.getFurthestMeasurement(d,h),x=p?p.end+this.options.gap:i+s,m=o.get(g),y=typeof m=="number"?m:this.options.estimateSize(h),v=x+y,w=p?p.lane:h%this.options.lanes;d[h]={index:h,start:x,size:y,end:v,key:g,lane:w}}return this.measurementsCache=d,d},{key:!1,debug:()=>this.options.debug}),this.calculateRange=$(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(t,i,s,a)=>this.range=t.length>0&&i>0?Le({measurements:t,outerSize:i,scrollOffset:s,lanes:a}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=$(()=>{let t=null,i=null;const s=this.calculateRange();return s&&(t=s.startIndex,i=s.endIndex),this.maybeNotify.updateDeps([this.isScrolling,t,i]),[this.options.rangeExtractor,this.options.overscan,this.options.count,t,i]},(t,i,s,a,n)=>a===null||n===null?[]:t({startIndex:a,endIndex:n,overscan:i,count:s}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=t=>{const i=this.options.indexAttribute,s=t.getAttribute(i);return s?parseInt(s,10):(console.warn(`Missing attribute name '${i}={index}' on measured element.`),-1)},this._measureElement=(t,i)=>{const s=this.indexFromElement(t),a=this.measurementsCache[s];if(!a)return;const n=a.key,o=this.elementsCache.get(n);o!==t&&(o&&this.observer.unobserve(o),this.observer.observe(t),this.elementsCache.set(n,t)),t.isConnected&&this.resizeItem(s,this.options.measureElement(t,i,this))},this.resizeItem=(t,i)=>{const s=this.measurementsCache[t];if(!s)return;const a=this.itemSizeCache.get(s.key)??s.size,n=i-a;n!==0&&((this.shouldAdjustScrollPositionOnItemSizeChange!==void 0?this.shouldAdjustScrollPositionOnItemSizeChange(s,n,this):s.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=n,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(s.index),this.itemSizeCache=new Map(this.itemSizeCache.set(s.key,i)),this.notify(!1))},this.measureElement=t=>{if(!t){this.elementsCache.forEach((i,s)=>{i.isConnected||(this.observer.unobserve(i),this.elementsCache.delete(s))});return}this._measureElement(t,void 0)},this.getVirtualItems=$(()=>[this.getVirtualIndexes(),this.getMeasurements()],(t,i)=>{const s=[];for(let a=0,n=t.length;a<n;a++){const o=t[a],c=i[o];s.push(c)}return s},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=t=>{const i=this.getMeasurements();if(i.length!==0)return Y(i[he(0,i.length-1,s=>Y(i[s]).start,t)])},this.getOffsetForAlignment=(t,i,s=0)=>{const a=this.getSize(),n=this.getScrollOffset();i==="auto"&&(i=t>=n+a?"end":"start"),i==="center"?t+=(s-a)/2:i==="end"&&(t-=a);const o=this.getTotalSize()+this.options.scrollMargin-a;return Math.max(Math.min(o,t),0)},this.getOffsetForIndex=(t,i="auto")=>{t=Math.max(0,Math.min(t,this.options.count-1));const s=this.measurementsCache[t];if(!s)return;const a=this.getSize(),n=this.getScrollOffset();if(i==="auto")if(s.end>=n+a-this.options.scrollPaddingEnd)i="end";else if(s.start<=n+this.options.scrollPaddingStart)i="start";else return[n,i];const o=i==="end"?s.end+this.options.scrollPaddingEnd:s.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(o,i,s.size),i]},this.isDynamicMode=()=>this.elementsCache.size>0,this.scrollToOffset=(t,{align:i="start",behavior:s}={})=>{s==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getOffsetForAlignment(t,i),{adjustments:void 0,behavior:s})},this.scrollToIndex=(t,{align:i="auto",behavior:s}={})=>{s==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),t=Math.max(0,Math.min(t,this.options.count-1));let a=0;const n=10,o=d=>{if(!this.targetWindow)return;const h=this.getOffsetForIndex(t,d);if(!h){console.warn("Failed to get offset for index:",t);return}const[g,p]=h;this._scrollToOffset(g,{adjustments:void 0,behavior:s}),this.targetWindow.requestAnimationFrame(()=>{const x=this.getScrollOffset(),m=this.getOffsetForIndex(t,p);if(!m){console.warn("Failed to get offset for index:",t);return}Me(m[0],x)||c(p)})},c=d=>{this.targetWindow&&(a++,a<n?this.targetWindow.requestAnimationFrame(()=>o(d)):console.warn(`Failed to scroll to index ${t} after ${n} attempts.`))};o(i)},this.scrollBy=(t,{behavior:i}={})=>{i==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getScrollOffset()+t,{adjustments:void 0,behavior:i})},this.getTotalSize=()=>{var t;const i=this.getMeasurements();let s;if(i.length===0)s=this.options.paddingStart;else if(this.options.lanes===1)s=((t=i[i.length-1])==null?void 0:t.end)??0;else{const a=Array(this.options.lanes).fill(null);let n=i.length-1;for(;n>=0&&a.some(o=>o===null);){const o=i[n];a[o.lane]===null&&(a[o.lane]=o.end),n--}s=Math.max(...a.filter(o=>o!==null))}return Math.max(s-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(t,{adjustments:i,behavior:s})=>{this.options.scrollToFn(t,{behavior:s,adjustments:i},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(l)}}const he=(r,l,t,i)=>{for(;r<=l;){const s=(r+l)/2|0,a=t(s);if(a<i)r=s+1;else if(a>i)l=s-1;else return s}return r>0?r-1:0};function Le({measurements:r,outerSize:l,scrollOffset:t,lanes:i}){const s=r.length-1,a=c=>r[c].start;if(r.length<=i)return{startIndex:0,endIndex:s};let n=he(0,s,a,t),o=n;if(i===1)for(;o<s&&r[o].end<t+l;)o++;else if(i>1){const c=Array(i).fill(0);for(;o<s&&c.some(h=>h<t+l);){const h=r[o];c[h.lane]=h.end,o++}const d=Array(i).fill(t+l);for(;n>=0&&d.some(h=>h>=t);){const h=r[n];d[h.lane]=h.start,n--}n=Math.max(0,n-n%i),o=Math.min(s,o+(i-1-o%i))}return{startIndex:n,endIndex:o}}const ee=typeof document<"u"?u.useLayoutEffect:u.useEffect;function We(r){const l=u.useReducer(()=>({}),{})[1],t={...r,onChange:(s,a)=>{var n;a?me.flushSync(l):l(),(n=r.onChange)==null||n.call(r,s,a)}},[i]=u.useState(()=>new Te(t));return i.setOptions(t),ee(()=>i._didMount(),[]),ee(()=>i._willUpdate()),i}function Re(r){return We({observeElementRect:Ae,observeElementOffset:Oe,scrollToFn:Ve,...r})}const{Text:te}=A,Be=({file_path:r})=>{var d;u.useEffect(()=>{console.log("fileKey",r),r&&a(r)},[r]);const{messageApi:l}=P(),t=u.useRef(0),[i,s]=u.useState([]),a=async(h,g=!1)=>{const p=await Ie(h);t.current=p.data.offset,s(p.data.content),g&&l.success(`日志加载成功: ${h}`)},n=u.useRef(null),o=Re({count:i.length,getScrollElement:()=>n.current,estimateSize:()=>30,overscan:10});u.useEffect(()=>{(i==null?void 0:i.length)>0&&o.scrollToIndex(i.length-1,{align:"end",behavior:"smooth"})},[i==null?void 0:i.length]);const c=o.getVirtualItems();return e.jsx(le,{size:"small",extra:e.jsx(j,{size:"small",type:"primary",onClick:()=>{a(r)},children:"Refresh Log"}),title:e.jsxs(D,{gap:"small",wrap:"wrap",children:[e.jsxs(I,{color:"blue",children:["File: ",r]}),e.jsxs(I,{color:"purple",children:["Offset: ",t.current]})]}),bodyStyle:{padding:0},children:e.jsx("div",{ref:n,style:{height:400,overflowY:"auto",fontFamily:"monospace",backgroundColor:"#1e1e1e",color:"#d4d4d4",padding:"0 12px"},children:e.jsx("div",{style:{height:o.getTotalSize(),width:"100%",position:"relative"},children:e.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${((d=c[0])==null?void 0:d.start)??0}px)`},children:c.map(h=>e.jsx("div",{"data-index":h.index,ref:o.measureElement,style:{padding:"4px 0",borderBottom:"1px solid #333"},children:e.jsxs(D,{gap:"middle",children:[e.jsxs(te,{type:"secondary",style:{width:60,color:"#d4d4d4"},children:["#",h.index+1]}),e.jsx(te,{style:{whiteSpace:"pre-wrap",color:"#d4d4d4"},children:i[h.index]})]})},h.key))})})})})},Pe=({visible:r,onClose:l,params:t})=>e.jsx(N,{footer:null,title:"参数",width:"50%",open:r,onCancel:l,children:e.jsx(A,{children:e.jsx("pre",{children:JSON.stringify(t,null,2)})})}),Ne=({formJson:r,openModal:l})=>{if(!r)return null;const[t,i]=u.useState([]),s=async()=>{const a=r.map(c=>c.dataKey),o=((await F.post("/list-bio-database",{type_list:a})).data||[]).reduce((c,d)=>{const h=d.type;c[h]||(c[h]=[]);const{name:g,database_id:p,...x}=d;return c[h].push({label:g,value:p,...x}),c},{});i(o),console.log(o)};return u.useEffect(()=>{s()},[r]),e.jsx(e.Fragment,{children:e.jsxs(D,{gap:"small",children:[e.jsx("div",{style:{flex:1},children:e.jsx(R,{formJson:r,dataMap:t})}),e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:l,children:"配置数据库"}),e.jsx(j,{onClick:s,size:"small",type:"primary",children:"刷新"})]})})},Je=({visible:r,onClose:l,params:t,callback:i})=>{if(!r)return null;const[s,a]=u.useState([]),[n,o]=u.useState(!1),[c]=C.useForm(),[d,h]=u.useState(t[0].dataKey),[g,p]=u.useState(null),x=async f=>{o(!0);const _=await F.post("/list-bio-database",f);a(_.data),o(!1)},m=async()=>({...await c.validateFields(),type:d}),y=async()=>{const f=await m();g?await F.post("/update-bio-database",{...f,database_id:g.database_id}):await F.post("/add-bio-database",f),v(),p(void 0),c.resetFields()},v=()=>{x({type:d})};u.useEffect(()=>{x({type:d})},[t]);const w=f=>{h(f),x({type:f})},b=async f=>{await F.delete(`/delete-bio-database/${f.id}`),v()},S=f=>{c.setFieldsValue(f),p(f)};return e.jsxs(N,{title:"数据库操作",open:r,onCancel:l,width:"50%",footer:null,children:[e.jsx(J,{tabBarExtraContent:e.jsxs(e.Fragment,{children:[e.jsx(j,{size:"small",color:"cyan",variant:"solid",style:{marginRight:"0.5rem"},type:"primary",onClick:v,children:" 刷新"}),e.jsxs(j,{size:"small",color:"cyan",variant:"solid",type:"primary",onClick:()=>{p(void 0),y()},children:[" ",g?"更新":"添加"]})]}),activeKey:d,onChange:w,items:t.map(f=>({key:f.name,label:f.label,children:e.jsx("div",{})}))}),e.jsxs(C,{form:c,style:{maxWidth:600},labelCol:{span:3},children:[e.jsx(C.Item,{name:"name",label:"名称",rules:[{required:!0,message:"请输入名称"}],children:e.jsx(T,{})}),e.jsx(C.Item,{name:"path",label:"路径",rules:[{required:!0,message:"请输入路径"}],children:e.jsx(T,{})}),e.jsx(C.Item,{name:"db_index",label:"索引",children:e.jsx(T,{})})]}),e.jsx(ce,{dataSource:s,columns:[{title:"名称",dataIndex:"name",key:"name"},{title:"数据库ID",dataIndex:"database_id",key:"database_id"},{title:"类型",dataIndex:"type",key:"type"},{title:"路径",dataIndex:"path",key:"path"},{title:"索引",dataIndex:"db_index",key:"db_index"},{title:"操作",dataIndex:"action",key:"action",ellipsis:!0,render:(f,_)=>e.jsxs(D,{gap:"small",children:[e.jsx(E,{title:"确定删除吗？",onConfirm:()=>{b(_)},children:e.jsx(j,{size:"small",type:"primary",danger:!0,children:"删除"})}),e.jsx(j,{size:"small",type:"primary",onClick:()=>{S(_)},children:"编辑"})]})}],loading:n,pagination:!1})]})},qe=({visible:r,params:l,onClose:t,callback:i})=>{var v,w,b;const[s]=C.useForm(),{messageApi:a,project:n}=P();u.useEffect(()=>{r&&m()},[l]);const[o,c]=u.useState(),[d,h]=u.useState(),g=()=>{t(),i&&i()},[p,x]=u.useState(),m=async()=>{x(!0);const S=await F.post(`/analysis/edit-params/${l}`);c(S.data),h(S.data.analysis_result),s.resetFields(),s.setFieldsValue(S.data.request_param),x(!1)},y=S=>{if(S&&Object.keys(S).length>0)return Object.keys(S)[0]};return e.jsx(e.Fragment,{children:e.jsx(re,{size:"default",loading:p,title:e.jsx(e.Fragment,{children:o&&e.jsxs(e.Fragment,{children:[e.jsx(I,{children:o==null?void 0:o.component_name}),e.jsx(I,{children:o==null?void 0:o.analysis_name}),e.jsx(I,{children:String(o==null?void 0:o.analysis_id).slice(0,8)})]})}),width:"50%",open:r,onClose:t,children:o&&e.jsx(e.Fragment,{children:e.jsx(Ke,{form:s,requestParam:{...o.request_param,analysis_id:o==null?void 0:o.analysis_id},dataMap:{...d,first_data_key:y(d)},formJson:[...((v=o.content)==null?void 0:v.formJson)||[],...((w=o.content)==null?void 0:w.upstreamFormJson)||[],...(o==null?void 0:o.inputFormJson)||[],(o==null?void 0:o.component_type)=="software"?{name:"group_field",label:"Group Field",rules:[{required:!0,message:"该字段不能为空!"}],type:"GroupFieldSelect"}:{}],databases:(b=o.content)==null?void 0:b.databases,upstreamFormJson:o==null?void 0:o.upstreamFormJson,callback:g})})})})},Ke=({form:r,requestParam:l,dataMap:t,formJson:i,databases:s,callback:a,showCancal:n=!1})=>{const{modals:o,openModals:c,closeModals:d}=ne(["paramsView","bioDatabases"]),[h,g]=u.useState([]),[p,x]=u.useState([]),{messageApi:m}=P();u.useEffect(()=>{y()},[JSON.stringify(i)]);const y=()=>{if(Array.isArray(i)){const b=i.filter(f=>!(f!=null&&f.required)&&!(f!=null&&f.db)&&!f.component_id),S=i.filter(f=>(f==null?void 0:f.required)||(f==null?void 0:f.db)||f.component_id);g(S),x(b)}},v=b=>({...l,...b}),w=async(b,S=!1)=>{var k;const f=await r.validateFields(),_=v(f);try{const M=await F.post(`/fast-api/analysis-controller?save=${b}&is_submit=${S}`,_);console.log(M),b?(m.success("执行成功!"),a&&a()):c("paramsView",M.data)}catch(M){console.log(M),(k=M.response)!=null&&k.data&&m.error(M.response.data.detail)}};return e.jsxs(e.Fragment,{children:[e.jsxs(C,{form:r,onValuesChange:(b,S)=>{},children:[e.jsx(J,{items:[{key:"1",label:"Required Parameters",forceRender:!0,children:e.jsxs(e.Fragment,{children:[e.jsx(R,{formJson:[...h],dataMap:t}),s&&e.jsx(Ne,{openModal:()=>{c("bioDatabases",s)},formJson:s})]})},{key:"2",label:"Optional parameters",forceRender:!0,children:e.jsx(e.Fragment,{children:e.jsx(R,{formJson:[...p],dataMap:{}})})}]}),e.jsx(C.Item,{label:"Analysyis Name",name:"analysis_name",style:{maxWidth:600},rules:[{required:!0,message:"This field cannot be empty!"}],children:e.jsx(T,{})}),e.jsxs(D,{gap:"small",children:[e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>{w(!1)},children:"View Parameters"}),e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>w(!0),children:l!=null&&l.analysis_id?e.jsxs(e.Fragment,{children:["Update Analysis(",l.analysis_name,")(",String(l.analysis_id).slice(0,8),")"]}):e.jsx(e.Fragment,{children:"Save Analysis"})}),(l==null?void 0:l.analysis_id)&&n&&e.jsx(j,{size:"small",color:"cyan",onClick:()=>r.setFieldValue("analysis_id",void 0),children:"Cancel Analysis"})]}),e.jsx(ie,{ghost:!0,items:[{key:"1",label:"More",children:e.jsx(e.Fragment,{children:e.jsx(C.Item,{noStyle:!0,shouldUpdate:!0,children:()=>e.jsx(A,{children:e.jsx("pre",{children:JSON.stringify(v(r.getFieldsValue()),null,2)})})})})}]})]}),e.jsx(Pe,{visible:o.paramsView.visible,onClose:()=>d("paramsView"),params:o.paramsView.params}),e.jsx(Je,{visible:o.bioDatabases.visible,onClose:()=>d("bioDatabases"),params:o.bioDatabases.params})]})},Ue=({visible:r,onClose:l,params:t,callback:i})=>{if(!r)return null;const[s,a]=u.useState(),[n,o]=fe.useMessage(),[c,d]=u.useState("main"),h=u.useRef(null),g=async p=>{try{const x=await F.get(`/get-component-module-content/${p.component_id}?script_name=${c}`);console.log(x),a(x.data)}catch(x){n.error(`${x.response.data.detail}`)}};return u.useEffect(()=>{g(t)},[JSON.stringify(t),c]),e.jsxs(e.Fragment,{children:[o,e.jsxs(re,{extra:e.jsxs(D,{justify:"flex-end",gap:"small",children:[e.jsx(E,{title:"是否生成脚本",onConfirm:async()=>{await F.post(`/component/convert-ipynb/${t.component_id}`),n.success("是否生成脚本成功!"),g(t)},children:e.jsx(j,{size:"small",color:"cyan",variant:"solid",children:"生成脚本"})}),e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>{g(t)},children:"刷新"}),e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>{h.current.setValue(s==null?void 0:s.content)},children:"保存"})]}),title:"View File",open:r,onClose:l,width:"50%",children:[e.jsx("ul",{children:e.jsxs("li",{children:["path:",s==null?void 0:s.path]})}),e.jsx("hr",{}),e.jsx(J,{onChange:p=>{d(p)},items:[{label:"main",key:"main"},{label:"input_parse",key:"input_parse"},{label:"output_parse",key:"output_parse"}]}),e.jsx(oe,{value:s==null?void 0:s.content,editorRef:h,defaultLanguage:"python"})]})]})},q=({url:r,filename:l,baseURL:t})=>e.jsx(e.Fragment,{children:r&&e.jsx(we,{title:e.jsx("div",{style:{wordBreak:"break-all",maxWidth:"400px"},children:`${t}${r}`}),children:e.jsxs(I,{color:"success",style:{cursor:"pointer",whiteSpace:"normal",wordBreak:"break-all",display:"inline-block"},onClick:()=>{window.open(`${t}${r}?t=${Date.now()}`,"_blank")},children:[e.jsxs("span",{children:[l," "]}),e.jsx(ze,{})]})})}),ue=({data:r,url:l,filename:t,columns:i,baseURL:s,projectObj:a})=>{const{Search:n}=T,[o,c]=u.useState([]),[d,h]=u.useState(),[g,p]=u.useState();u.useEffect(()=>{if(a!=null&&a.research)try{const m=JSON.parse((a==null?void 0:a.research)||"{}");h(m)}catch{}},[a==null?void 0:a.research]);const x=m=>m?Object.keys(m).map(y=>({title:y,dataIndex:y,key:y,ellipsis:!0,width:150})):[];return u.useEffect(()=>{if(r){const m=r.map((y,v)=>({...y,key:v}));c(m)}},[r]),e.jsxs(e.Fragment,{children:[(d==null?void 0:d.table)&&e.jsx(e.Fragment,{children:e.jsx("div",{style:{marginBottom:"1rem"},children:d==null?void 0:d.table.map(m=>e.jsx(I,{color:"blue",style:{cursor:"pointer"},onClick:()=>{const y=r.filter(v=>Object.values(v).some(w=>typeof w=="string"&&w.includes(m)));c(y),p(m)},children:m},m))})}),Array.isArray(o)&&e.jsx(e.Fragment,{children:e.jsx(ce,{style:{border:"1px solid #f0f0f0"},size:"small",title:()=>e.jsxs(D,{gap:"small",children:[e.jsx(n,{value:g,size:"small",onChange:m=>{p(m.target.value)},placeholder:"input search text",allowClear:!0,onSearch:m=>{const y=r.filter(v=>Object.values(v).some(w=>typeof w=="string"&&w.includes(m)));c(y)},style:{width:304}}),e.jsx(q,{url:l,filename:t,baseURL:s})]}),scroll:{x:"max-content",y:55*5},dataSource:o,pagination:!1,virtual:!0,columns:i||x(r[0]),footer:()=>`A total of ${r.length} records`})})]})},se=({data:r,url:l,filename:t,baseURL:i})=>e.jsx("div",{children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx(_e,{src:t!=null&&t.endsWith("pdf")?r:`${r}?t=${Date.now()}`,style:{maxWidth:"20rem",marginRight:"0.5rem"}}),e.jsx(q,{url:l,filename:t,baseURL:i})]})}),{Paragraph:jt}=A,Ge=({data:r})=>e.jsx(e.Fragment,{children:e.jsx(A,{children:e.jsx("pre",{style:{margin:0},children:r})})}),He=({data:r})=>e.jsx("div",{children:e.jsx(Ce,{closable:!0,message:r,type:"info",showIcon:!0})}),Ye=({data:r})=>e.jsx(e.Fragment,{children:e.jsx(A,{children:e.jsx("pre",{style:{margin:0},children:r})})}),Qe=({data:r})=>e.jsx(e.Fragment,{children:e.jsx(oe,{value:r,defaultLanguage:"json"})}),Xe=({data:r,url:l})=>{const{baseURL:t}=W(a=>a.user),[i,s]=u.useState(!0);return e.jsx(e.Fragment,{children:e.jsxs("div",{style:{position:"relative",width:"100%",height:"80vh"},children:[i&&e.jsx("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.8)",zIndex:1},children:e.jsx(de,{size:"large",tip:"Loading..."})}),e.jsx("iframe",{src:`${t}${l}`,width:"100%",style:{height:"100%",border:"none"},onLoad:()=>s(!1),title:"content-frame"})]})})},Ze=({url:r,filename:l,baseURL:t})=>e.jsx(e.Fragment,{children:e.jsx(q,{url:r,filename:l,baseURL:t})}),et=({data:r,...l})=>{var a,n,o,c,d;const{modal:t,openModal:i,closeModal:s}=be();return e.jsxs(e.Fragment,{children:[e.jsx(ue,{data:r==null?void 0:r.list,...l,columns:[{title:"ID",dataIndex:"ID",key:"ID",ellipsis:!0,width:150},{title:"Description",dataIndex:"Description",key:"Description",ellipsis:!0,width:400},{title:"GeneRatio",dataIndex:"GeneRatio",key:"GeneRatio",ellipsis:!0,width:150},{title:"geneID",dataIndex:"geneID",key:"geneID",ellipsis:!0,width:150},{title:"Count",dataIndex:"Count",key:"Count",ellipsis:!0,width:150},{title:"pvalue",dataIndex:"pvalue",key:"pvalue",ellipsis:!0,width:150},{title:"p.adjust",dataIndex:"p.adjust",key:"p.adjust",ellipsis:!0,width:150},{title:"qvalue",dataIndex:"qvalue",key:"qvalue",ellipsis:!0,width:150},{title:"organism",dataIndex:"organism",key:"organism",ellipsis:!0,width:150},{title:"pathwayId",dataIndex:"pathwayId",key:"pathwayId",ellipsis:!0,width:150},{title:"操作",key:"action",fixed:"right",ellipsis:!0,width:200,render:(h,g)=>e.jsx(e.Fragment,{children:e.jsx(j,{onClick:()=>{i("KGMLMapSVG",g)},size:"small",color:"cyan",variant:"solid",children:"pathview"})})}]}),t.visible&&e.jsx(N,{width:"80%",title:`${(a=t.params)==null?void 0:a.Description}(${(n=t.params)==null?void 0:n.ID})`,footer:null,onCancel:s,onClose:s,open:t.visible&&t.key=="KGMLMapSVG",children:e.jsx(Fe,{compound:r==null?void 0:r.compound,highlightKeys:(o=t.params)==null?void 0:o.geneID.split("/"),pathwayId:(c=t.params)==null?void 0:c.pathwayId,organisms:(d=t.params)==null?void 0:d.organism})})]})},tt={table:ue,string:Ge,html:Xe,json:Qe,text:Ye,info:He,kegg_map:et,download:Ze},st=({type:r,...l})=>{const t=tt[r]||(()=>e.jsxs("div",{children:["未知类型 ",r]}));return e.jsx("div",{style:{marginBottom:"1rem"},children:e.jsx(t,{...l})})},vt=u.forwardRef(({params:r,visible:l,onClose:t},i)=>{const{output_dir:s,analysis_id:a}=r||{};return l?e.jsx(e.Fragment,{children:a&&e.jsx(nt,{onClose:t,analysis_id:a})}):null}),nt=({analysis_id:r,onClose:l,cancalReportCallback:t,openPanel:i})=>{var K,U;const[s,a]=u.useState(!1),[n,o]=u.useState(null),c=pe(),{eventSourceRef:d,status:h,reconnect:g}=ge(),p=u.useRef(null),x=u.useRef(null),m=ye(),{modals:y,openModals:v,closeModals:w}=ne(["editParams","moduleEdit"]),{containerURL:b}=W(z=>z.user),[S,f]=u.useState(!1),[_]=C.useForm(),k=async z=>{a(!0);const O=await F.get(`/analysis/visualization-results/${z}`);o(O.data),_.resetFields(),_.setFieldsValue(O.data.request_param),p.current=z,a(!1)},M=z=>({...n==null?void 0:n.request_param,...z});return u.useEffect(()=>{k(r)},[r]),u.useEffect(()=>{var z;if(d){const O=L=>{const V=JSON.parse(L.data);x.current=V,p.current==V.analysis_id&&(V.event=="analysis_complete"||V.event=="analysis_failed"||V.event=="analysis_started")&&k(p.current)};return(z=d.current)==null||z.addEventListener("message",O),()=>{var L;console.log("removeEventListener"),(L=d.current)==null||L.removeEventListener("message",O)}}},[d.current]),e.jsx(e.Fragment,{children:e.jsxs(le,{size:"small",style:{flex:1,display:"flex",flexDirection:"column",height:" 100%",boxShadow:"none"},styles:{body:{flex:1,display:"flex",flexDirection:"column",height:" 100%",overflowY:"auto"}},variant:"borderless",title:e.jsx(e.Fragment,{children:n?e.jsxs(e.Fragment,{children:[e.jsx(I,{style:{cursor:"pointer"},onClick:()=>{c(`/component/${n==null?void 0:n.component_type}/${n==null?void 0:n.component_id}`)},children:n==null?void 0:n.component_name}),e.jsx(I,{children:n==null?void 0:n.analysis_name}),e.jsx(I,{children:String(n==null?void 0:n.analysis_id).slice(0,8)}),e.jsx(I,{children:n==null?void 0:n.job_status}),p.current==((K=x.current)==null?void 0:K.analysis_id)&&e.jsxs(I,{children:[" ",e.jsx(e.Fragment,{children:(U=x.current)==null?void 0:U.event})]})]}):e.jsx(e.Fragment,{})}),extra:e.jsxs(D,{gap:"small",children:[i&&e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i("note")},children:"Open Note"}),l&&e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>l(),children:"Close"}),n&&e.jsxs(e.Fragment,{children:[e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>{v("moduleEdit",{component_id:n==null?void 0:n.component_id})},children:"Component Code"}),e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>{v("editParams",n.analysis_id)},children:"Edit Parameters"}),(n==null?void 0:n.job_status)=="running"?e.jsx(e.Fragment,{children:e.jsx(E,{title:"Whether or not to stop?",onConfirm:async()=>{await H(n.analysis_id,"job"),m.success("Stop Success")},children:e.jsx(j,{size:"small",color:"red",variant:"solid",children:"Stop"})})}):e.jsx(e.Fragment,{children:e.jsx(E,{title:"Whether or not to run?",onConfirm:async()=>{await G(n.analysis_id,"job"),m.success("run successfully")},children:e.jsx(j,{size:"small",color:"cyan",variant:"solid",children:n.job_status=="created"?"Run":"Re-Run"})})}),(n==null?void 0:n.server_status)=="running"?e.jsxs(e.Fragment,{children:[e.jsx(ve,{title:e.jsx(e.Fragment,{children:`${b}/container/${n.analysis_id}/`}),children:e.jsx(j,{size:"small",color:"blue",variant:"solid",onClick:()=>{window.open(`${b}/container/${n.analysis_id}/`,"_blank")},children:"Open URL"})}),e.jsx(E,{title:"Whether or not to stop?",onConfirm:async()=>{await H(n.analysis_id,"server")},children:e.jsx(j,{size:"small",color:"red",variant:"solid",children:"Stop Server"})})]}):e.jsx(e.Fragment,{children:e.jsx(E,{title:"Whether to start the server?",onConfirm:async()=>{await G(n.analysis_id,"server")},children:e.jsx(j,{size:"small",color:"cyan",variant:"solid",children:"Run Server"})})}),e.jsx(E,{title:n!=null&&n.is_report?"Whether to cancel the report?":"Reported or not?",onConfirm:async()=>{await F.post(`/analysis/update-report/${n==null?void 0:n.analysis_id}`),m.success("operate successfully!"),o(null),t&&t()},children:e.jsx(j,{size:"small",color:"cyan",variant:"solid",children:n!=null&&n.is_report?"Cancel Report":"Report"})})]}),e.jsx(j,{size:"small",color:"cyan",variant:"solid",onClick:()=>k(r),children:"Refresh"})]}),children:[(n==null?void 0:n.job_status)=="failed"?e.jsx("div",{style:{textAlign:"center"},children:e.jsx("div",{style:{flex:1,overflowY:"auto",marginBottom:"1rem"},children:e.jsx(Be,{file_path:n==null?void 0:n.command_log_path})})}):e.jsx(de,{spinning:s,tip:"loading...",style:{minHeight:"5rem"},children:e.jsxs(ae,{gutter:[8,8],children:[e.jsx(B,{lg:16,sm:16,xs:24,children:(n==null?void 0:n.job_status)=="running"&&(n==null?void 0:n.run_type)!="server"?e.jsx(xe,{active:!0}):e.jsx(e.Fragment,{children:r&&e.jsx(it,{analsyisResult:n,loading:s})})}),e.jsxs(B,{lg:8,sm:8,xs:24,style:{borderLeft:"1px solid #f0f0f0"},children:[e.jsx(C,{form:_,layout:"vertical",children:(n==null?void 0:n.form_json)&&e.jsxs(e.Fragment,{children:[e.jsx(R,{formJson:n==null?void 0:n.form_json,dataMap:{}}),e.jsx(C.Item,{children:e.jsx(E,{title:"Whether to submit?",onConfirm:async()=>{if((n==null?void 0:n.job_status)=="running")m.error("Running, please wait!");else{const z=M(await _.validateFields());await F.post("/fast-api/analysis-controller?save=true&is_submit=true",z),console.log(z),m.success("Submit Success!")}},children:e.jsx(j,{disabled:(n==null?void 0:n.job_status)=="running",type:"primary",size:"small",children:"Submit"})})}),e.jsx(ie,{ghost:!0,items:[{key:"1",label:"More",children:e.jsx(e.Fragment,{children:e.jsx(C.Item,{noStyle:!0,shouldUpdate:!0,children:()=>e.jsx(A,{children:e.jsx("pre",{children:JSON.stringify(M(_.getFieldsValue()),null,2)})})})})}]})]})}),e.jsx(je,{}),e.jsx(Se,{data:n==null?void 0:n.description})]})]})}),e.jsx(qe,{callback:()=>k(r),visible:y.editParams.visible,params:y.editParams.params,onClose:()=>w("editParams")}),e.jsx(Ue,{visible:y.moduleEdit.visible,onClose:()=>w("moduleEdit"),callback:()=>k(r),params:y.moduleEdit.params})]})})},it=({analsyisResult:r,loading:l})=>{const{baseURL:t}=W(s=>s.user),{projectObj:i}=W(s=>s.user);return e.jsx("div",{children:r&&e.jsxs(e.Fragment,{children:[r.images&&e.jsx("div",{style:{padding:"1rem"},children:Array.isArray(r.images)?e.jsx(ae,{gutter:{xs:8,sm:16,md:24,lg:32},children:r.images.map((s,a)=>e.jsx(B,{span:4,children:e.jsx(se,{...s,baseURL:t})},a))}):e.jsx(e.Fragment,{children:e.jsx(se,{...r.images,baseURL:t})})}),e.jsx("div",{style:{padding:"1rem"},children:r.tables&&Array.isArray(r.tables)&&e.jsx(e.Fragment,{children:r.tables.map((s,a)=>e.jsx(st,{projectObj:i,...s,baseURL:t},a))})})]})})};export{vt as A,Je as B,Ke as C,qe as E,Be as L,Ue as M,Pe as P,Ne as a,gt as b,st as c,nt as d,yt as f,G as r,H as s,xt as w};
