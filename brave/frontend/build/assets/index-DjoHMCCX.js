import{r as h,k as y,j as e,d as u,e as b,F as G,I as B,T as L,B as O,a as N}from"./main-DXywrSBF.js";import{S as P}from"./index-C4p1iVpj.js";import{T as A}from"./index-K-Wj2x7K.js";const K=({type:s,dataMap:t,constDataMap:o,componentMap:r,inputAnalysisMethod:n,dataKey:l,data:i,name:c,component_id:a,inputKey:d,...p})=>{if(!t)return e.jsx("div",{children:"加载中...."});t={...t,...o};const m=r[s];if(!m)return e.jsxs("div",{children:["未知类型 ",s]});const{Component:S,dataKey:j,...C}=m;console.log(C);let f=[];return i?f=i:n?f=t[n]:l?l in t&&(f=t[l]):j?j in t&&(f=t[j]):"first_data_key"in t?f=t[t.first_data_key]:a in t&&(f=t[a]),e.jsx(S,{...C,...p,data:f,name:c})},Z=h.memo(({formJson:s,dataMap:t})=>{if(!s)return null;const{projectObj:o}=y(),l={rank:[{label:"SGB",value:"SGB"},{label:"SPECIES",value:"SPECIES"},{label:"GENUS",value:"GENUS"},{label:"FAMILY",value:"FAMILY"},{label:"ORDER",value:"ORDER"},{label:"CLASS",value:"CLASS"},{label:"PHYLUM",value:"PHYLUM"}],group_field:o!=null&&o.metadata_form?o==null?void 0:o.metadata_form.map(c=>({label:c.label,value:c.name})):[]},i={GroupSelect:{Component:w,dataKey:"sample_group_list"},Input:{Component:T},GroupCompareSelect:{Component:k},BaseSelect:{Component:w},BaseInputNumber:{Component:J},BaseInput:{Component:W},BaseSwitch:{Component:D},RankSelect:{Component:w,dataKey:"rank",mode:void 0,initialValue:"SPECIES"},GroupFieldSelect:{Component:w,dataKey:"group_field",mode:void 0,initialValue:"group"},FilterFieldSelect:{Component:$,dataKey:"sample_group_list",mode:void 0},GroupSelectSampleButton:{Component:U},MetaphlanCladeSelect:{Component:R},SelectAll:{Component:V,dataKey:"sample_group_list"}};return e.jsx(e.Fragment,{children:s.map((c,a)=>e.jsx(K,{...c,dataMap:t,componentMap:i,constDataMap:l},a))})},(s,t)=>(console.log("prevProps==nextProps: ",JSON.stringify(s)===JSON.stringify(t)),JSON.stringify(s)===JSON.stringify(t))),$=({label:s,name:t,data:o,rules:r,field:n,...l})=>{const[i,c]=h.useState(),a=u.useFormInstance();return h.useEffect(()=>{if(o&&n){const d=[...new Set(o.map(n))],p=d.map(m=>({label:m,value:m}));c(p),a.setFieldValue(t,d[0])}},[o]),e.jsx(e.Fragment,{children:e.jsx(u.Item,{label:s,name:t,rules:r,children:e.jsx(_,{...l,options:i})})})},_=({options:s,clear:t,value:o,onChange:r,...n})=>{const l=u.useFormInstance(),i=c=>{r(c),t&&l.resetFields(t)};return e.jsx(b,{showSearch:!0,filterOption:(c,a)=>((a==null?void 0:a.label)??"").toLowerCase().includes(c.toLowerCase()),...n,options:s,value:o,onChange:i})},R=({label:s,name:t,data:o,initialValue:r,rules:n,...l})=>{const[i,c]=h.useState(),a=async()=>{let p=(await N.get("/fast-api/get_metaphlan_clade")).data.map(m=>({label:`${m.taxon.replaceAll(" ","_")}_${m.clade}`,value:m.clade}));c(p)};return h.useEffect(()=>{a()},[]),e.jsx(e.Fragment,{children:e.jsx(u.Item,{initialValue:r,label:s,name:t,rules:n,children:e.jsx(b,{...l,options:i,showSearch:!0,filterOption:(d,p)=>((p==null?void 0:p.label)??"").toLowerCase().includes(d.toLowerCase())})})})},k=({label:s,name:t,data:o,initialValue:r,rules:n,...l})=>{const i=u.useFormInstance(),c=u.useWatch(["sites1","group"],i),a=u.useWatch(["sites2","group"],i),[d,p]=h.useState();return h.useEffect(()=>{c&&a&&p([{label:"Prevalent in both sites",value:"Prevalent in both sites"},{label:`Prevalent in ${a.join("-")}`,value:`Prevalent in ${a.join("-")}`},{label:`Prevalent in ${c.join("-")}`,value:`Prevalent in ${c.join("-")}`},{label:"Not prevalent in either sites",value:"Not prevalent in either sites"}])},[c,a]),e.jsx(e.Fragment,{children:e.jsx(u.Item,{initialValue:r,label:s,name:t,rules:n,children:e.jsx(b,{showSearch:!0,filterOption:(m,S)=>((S==null?void 0:S.label)??"").toLowerCase().includes(m.toLowerCase()),...l,options:d})})})},T=({label:s,name:t,data:o,initialValue:r,rules:n,...l})=>e.jsx(e.Fragment,{children:e.jsx(u.Item,{initialValue:r,label:s,name:t,rules:n,children:e.jsx(L,{...l})})}),W=({label:s,name:t,data:o,initialValue:r,rules:n,...l})=>e.jsx(e.Fragment,{children:e.jsx(u.Item,{initialValue:r,label:s,name:t,rules:n,children:e.jsx(B,{...l})})}),D=({label:s,name:t,data:o,initialValue:r,rules:n,...l})=>e.jsx(e.Fragment,{children:e.jsx(u.Item,{initialValue:r,label:s,name:t,rules:n,children:e.jsx(P,{...l})})}),J=({label:s,name:t,data:o,initialValue:r,rules:n,...l})=>e.jsx(e.Fragment,{children:e.jsx(u.Item,{initialValue:r,label:s,name:t,rules:n,children:e.jsx(A,{...l})})}),w=({label:s,name:t,data:o,initialValue:r,rules:n,...l})=>e.jsx(e.Fragment,{children:e.jsx(u.Item,{initialValue:r||null,label:s,name:t,rules:n,children:e.jsx(_,{...l,options:o})})}),U=({label:s,name:t,rules:o,data:r,filter:n,group:l,groupField:i})=>{const[c,a]=h.useState(),[d,p]=h.useState([]),m=u.useFormInstance();let S=[];n&&(S=n.map(x=>x.name));const j=u.useWatch(x=>{const g=Object.entries(x).filter(([F])=>S.includes(F));return Object.fromEntries(g)},m),C=u.useWatch(l,m),f=(x,g)=>{const F=x.reduce((I,v)=>{const E=v[g];return I[E]||(I[E]=[]),I[E].push(v.value),I},{});a(F)};return h.useEffect(()=>{n&&j&&(r=n.reduce((x,g)=>x.filter(F=>g.method(F)===j[g.name]),r),r=r.map(x=>{const{label:g,id:F,value:I,...v}=x;return{label:`${x.label}(${n[0].method(x)})`,value:x.value,...v}})),r&&i?f(r,i):r&&C&&f(r,C),p(r)},[r,C,j]),e.jsxs(e.Fragment,{children:[e.jsx(u.Item,{label:s,name:[t,"sample"],rules:o,children:e.jsx(z,{sampleGrouped:c,sampleGroup:d,watch:[t,"group"]})}),e.jsxs(G,{gap:"small",children:[e.jsx(u.Item,{label:s,name:[t,"group"],noStyle:!0,children:e.jsx(q,{sampleGrouped:c})}),e.jsx(u.Item,{name:[t,"group_name"],children:e.jsx(B,{size:"small",placeholder:"Optional group name"})})]})]})},V=({label:s,name:t,data:o,initialValue:r,rules:n,...l})=>e.jsx(e.Fragment,{children:e.jsx(u.Item,{initialValue:r,label:s,name:t,rules:n,children:e.jsx(Y,{data:o,...l})})}),Y=({data:s,value:t,onChange:o,mode:r,...n})=>{const[l,i]=h.useState(t),c=a=>{console.log(a),o(a),i(a)};return e.jsxs(e.Fragment,{children:[e.jsx(b,{...n,mode:r,value:l,onChange:c,allowClear:!0,options:s}),r=="multiple"&&e.jsxs(O,{onClick:()=>{const a=s.map(d=>d.value);i(a),o(a)},children:["选择全部",l&&e.jsxs(e.Fragment,{children:["(",l.length,")"]})]})]})},z=({value:s,onChange:t,sampleGroup:o,watch:r,sampleGrouped:n})=>{const[l,i]=h.useState(),c=u.useFormInstance(),a=u.useWatch(r,c);h.useEffect(()=>{i(a)},[a]);const d=p=>{const m=Object.entries(n||{}).filter(([S])=>p.includes(S)).flatMap(([,S])=>S);t(m)};return h.useEffect(()=>{l&&d(l)},[l]),e.jsxs(e.Fragment,{children:[e.jsx(b,{showSearch:!0,filterOption:(p,m)=>((m==null?void 0:m.label)??"").toLowerCase().includes(p.toLowerCase()),mode:"multiple",value:s,onChange:t,options:o}),s&&e.jsxs(e.Fragment,{children:["A total of ",s.length," samples were selected"]})]})},q=({value:s,onChange:t,sampleGrouped:o})=>{const r=n=>{if((s||[]).includes(n)){const l=(s||[]).filter(i=>!i.includes(n));t(l)}else{const l=[...s||[],n];t(l)}};return e.jsx(e.Fragment,{children:e.jsx(G,{gap:"small",children:Object.entries(o||{}).map(([n,l])=>e.jsx("span",{children:e.jsxs(O,{size:"small",type:(s||[]).includes(n)?"primary":"dashed",onClick:()=>r(n),children:[n,"(",l.length,")"]})},n))})})};export{Z as F};
