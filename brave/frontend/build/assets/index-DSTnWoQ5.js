import{d_ as w,j as t,F as j,l as g,a as I,r as n,k as A,b as K,u as R,i as E,B as x,P}from"./main-DDCpF10P.js";import{b as z}from"./index-vhO2SzV8.js";import{B as O}from"./index-DOr26GHb.js";import{A as D}from"./react-window-Y-oFBpKE.js";import{L as M}from"./index-Cim_n-MI.js";import{C as N}from"./index-BPF_Hiq5.js";import{S as k}from"./index-36mrdQic.js";import{F as $}from"./Table-DSu9PW9f.js";import{T as S}from"./index-UTRMrFLi.js";import"./index-DwXJtm3g.js";import"./usePagination-HtfC8gwS.js";import"./index-3M1DwGQt.js";import"./UpOutlined-ChaI2Zov.js";import"./DeleteOutlined-CIqb_GHe.js";import"./Dropdown-BENEu6xl.js";import"./index-Bmw2VUkj.js";import"./index-DB4VWWzg.js";import"./index-CrxX4M_e.js";import"./addEventListener-CeJuYbwj.js";import"./createForOfIteratorHelper-CMm9xPXw.js";import"./DeploymentUnitOutlined-CQS9e9a3.js";import"./UserSwitchOutlined-ZboVIKUL.js";import"./AudioOutlined-DbeWwT6X.js";import"./ClearOutlined-ajVE4DvC.js";import"./TableOutlined-D0jaCC3Y.js";import"./NodeIndexOutlined-Robcb9kt.js";import"./index-Fu9C-8S6.js";import"./RedoOutlined-CqafmfEh.js";import"./UndoOutlined-UutLNt3R.js";function J({rows:i}){return w.useToken(),t.jsxs(t.Fragment,{children:[t.jsx(D,{rowComponent:Q,rowCount:i==null?void 0:i.length,rowHeight:30,rowProps:{rows:i}}),t.jsx(j,{justify:"end",gap:"small",children:t.jsxs(g,{color:"default",children:["Rows: ",i==null?void 0:i.length]})})]})}function Q({index:i,rows:c,style:f}){const e=c[i],{token:l}=w.useToken();return t.jsx(j,{align:"center",style:{...f,backgroundColor:i%2?l.colorBgContainer:l.colorFillQuaternary,borderBottom:`1px solid ${l.colorBorderSecondary}`,padding:"0 8px",fontSize:13,minWidth:"fit-content",transition:"background-color 0.2s"},className:"table-row",onMouseEnter:m=>{m.currentTarget.style.backgroundColor=l.colorFillTertiary},onMouseLeave:m=>{m.currentTarget.style.backgroundColor=i%2?l.colorBgContainer:l.colorFillQuaternary},children:JSON.stringify(e)})}const W=(i,c)=>I.post(`/fast-api/parse-analysis-result/${i}?save=${c}`),_e=n.memo(({analysis_id:i,callback:c,onClose:f})=>{const[e,l]=n.useState(),[m,h]=n.useState(!1),{messageApi:_}=A(),{modal:b,openModal:T,closeModal:B}=K(),L=n.useRef(null),[u,C]=n.useState({tabList:[],dataList:[],dataListInfo:{nrow:0,ncol:0}}),[y,v]=n.useState({tabList:[],dataList:[]});n.useEffect(()=>{const s=e==null?void 0:e.result_dict;if(!s)return;const r=Object.keys(s).map(p=>({key:p,label:p}));if(r.length===0)return;const a=r[0].key,o=s[a];C({tabKey:a,tabList:r,dataList:(o==null?void 0:o.tables)??[],dataListInfo:{nrow:(o==null?void 0:o.nrow)??0,ncol:(o==null?void 0:o.ncol)??0}})},[e==null?void 0:e.result_dict]),n.useEffect(()=>{const s=e==null?void 0:e.file_dict;if(!s)return;const r=Object.keys(s).map(p=>({key:p,label:p}));if(r.length===0)return;const a=r[0].key,o=s[a];v({tabKey:a,tabList:r,dataList:o})},[e==null?void 0:e.file_dict]);const F=R(s=>s.global.sseData);n.useEffect(()=>{const s=F;L.current==s.analysis_id&&(s.event=="analysis_complete"||s.event=="analysis_failed"||s.event=="analysis_started")&&d()},[F]);const d=async(s=!1)=>{h(!0);try{const r=await W(i,s);l(r.data),L.current=r.data.analysis_id,h(!1),c&&s&&c()}catch(r){h(!1),_.error(r.response.data.detail)}};return n.useEffect(()=>{d(!1)},[i]),t.jsxs(t.Fragment,{children:[t.jsx(N,{size:"small",variant:"borderless",style:{boxShadow:"none"},title:`Analysis Result Parse (${i})`,extra:t.jsxs(j,{gap:"small",children:[(e==null?void 0:e.file_format_list)&&t.jsx(t.Fragment,{children:e==null?void 0:e.file_format_list.map(s=>t.jsx(g,{children:s.name}))}),t.jsx(g,{children:e==null?void 0:e.job_status}),t.jsx(P,{title:"确定解析吗？",onConfirm:()=>{d(!0),_.success("解析成功")},children:t.jsx(x,{size:"small",color:"cyan",variant:"solid",children:"Parse"})}),t.jsx(x,{size:"small",color:"primary",variant:"solid",onClick:()=>d(!1),children:"Refresh"}),f&&t.jsx(x,{onClick:f,size:"small",color:"red",variant:"solid",children:"Close"})]}),children:t.jsx(k,{spinning:m,children:(e==null?void 0:e.job_status)=="failed"?t.jsx("div",{style:{textAlign:"center"},children:t.jsx("div",{style:{flex:1,overflowY:"auto",marginBottom:"1rem"},children:t.jsx(M,{file_path:e==null?void 0:e.command_log_path})})}):t.jsx(t.Fragment,{children:t.jsx(k,{spinning:(e==null?void 0:e.job_status)=="running",tip:"Analysis is running, please wait...",children:e&&t.jsx(t.Fragment,{children:e!=null&&e.error?t.jsx(E,{children:t.jsx("pre",{children:e==null?void 0:e.error})}):t.jsxs(t.Fragment,{children:[t.jsx($,{size:"small",pagination:!1,rowKey:"component_id",columns:[{title:"Name",dataIndex:"name",key:"name"},{title:"Dir",dataIndex:"dir",key:"dir"},{title:"File Component Id",dataIndex:"component_id",key:"component_id"},{title:"File Format",dataIndex:"fileFormat",key:"fileFormat",render:(s,r)=>t.jsx("div",{style:{overflowWrap:"break-word",wordBreak:"break-all"},children:JSON.stringify(r.fileFormat)})},{title:"Action",dataIndex:"action",key:"action",render:(s,r)=>t.jsx(t.Fragment,{children:t.jsx(x,{color:"cyan",variant:"solid",size:"small",onClick:()=>{T("modalC",{data:{component_id:r.component_id},structure:{component_type:"file",files:e==null?void 0:e.file_dict[r.dir]}})},children:"Edit"})})}],dataSource:e==null?void 0:e.file_format_list}),t.jsx(S,{activeKey:u.tabKey,onChange:s=>{const r=e==null?void 0:e.result_dict[s];r&&C(a=>({...a,tabKey:s,dataList:r.tables??[],dataListInfo:{nrow:r.nrow??0,ncol:r.ncol??0}}))},items:u.tabList}),t.jsx("div",{style:{height:"30vh"},children:t.jsx(O,{rows:u.dataList,shape:u.dataListInfo})}),t.jsx(S,{activeKey:y.tabKey,onChange:s=>{const r=e==null?void 0:e.result_dict[s];r&&v(a=>({...a,tabKey:s,dataList:r.tables??[],dataListInfo:{nrow:r.nrow??0,ncol:r.ncol??0}}))},items:y.tabList}),t.jsx("div",{style:{height:"30vh"},children:t.jsx(J,{rows:y.dataList})})]})})})})})}),t.jsx(z,{callback:d,visible:b.key=="modalC"&&b.visible,onClose:B,params:b.params})]})});export{_e as default,W as parseAnalysisResultAPi};
