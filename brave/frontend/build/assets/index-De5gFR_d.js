import{G as _e,H as ke,J as be,K as Me,f as x,r as _,L as Se,N as de,O as me,Q as we,U as Ce,V as Ee,W as se,X as We,Y as Ae,a as pe,d as oe,s as $e,j as te}from"./main-B2jPVJuc.js";import{C as Ne}from"./index-CFkosLO7.js";x.Component;var Re={subtree:!0,childList:!0,attributeFilter:["style","class"]};function Fe(t,e){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Re;_.useEffect(function(){if(!(!Se()||!t)){var s,i=Array.isArray(t)?t:[t];return"MutationObserver"in window&&(s=new MutationObserver(e),i.forEach(function(a){s.observe(a,n)})),function(){var a,l;(a=s)===null||a===void 0||a.takeRecords(),(l=s)===null||l===void 0||l.disconnect()}}},[n,t])}const fe=3,ae=function(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;const s=document.createElement("canvas"),i=s.getContext("2d"),a=t*n,l=e*n;return s.setAttribute("width",`${a}px`),s.setAttribute("height",`${l}px`),i.save(),[i,s,a,l]},Pe=(t,e,n)=>{const s=t*Math.cos(n)-e*Math.sin(n),i=t*Math.sin(n)+e*Math.cos(n);return[s,i]},je=()=>{const t=(e,n,s,i,a,l,m,g)=>{const[k,Q,b,H]=ae(i,a,s);if(e instanceof HTMLImageElement)k.drawImage(e,0,0,b,H);else{const{color:r,fontSize:d,fontStyle:h,fontWeight:D,fontFamily:p,textAlign:K}=l,q=Number(d)*s;k.font=`${h} normal ${D} ${q}px/${a}px ${p}`,k.fillStyle=r,k.textAlign=K,k.textBaseline="top";const F=de(e);F==null||F.forEach((I,J)=>{k.fillText(I??"",b/2,J*(q+fe*s))})}const Z=Math.PI/180*Number(n),M=Math.max(i,a),[j,T,E]=ae(M,M,s);j.translate(E/2,E/2),j.rotate(Z),b>0&&H>0&&j.drawImage(Q,-b/2,-H/2);let W=0,z=0,S=0,X=0;const N=b/2,A=H/2;[[0-N,0-A],[0+N,0-A],[0+N,0+A],[0-N,0+A]].forEach(r=>{let[d,h]=r;const[D,p]=Pe(d,h,Z);W=Math.min(W,D),z=Math.max(z,D),S=Math.min(S,p),X=Math.max(X,p)});const Y=W+E/2,L=S+E/2,$=z-W,w=X-S,R=m*s,C=g*s,U=($+R)*2,v=w+C,[B,V]=ae(U,v),O=function(){let r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,d=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;B.drawImage(T,Y,L,$,w,r,d,$,w)};return O(),O($+R,-w/2-C/2),O($+R,+w/2+C/2),[V.toDataURL(),U/s,v/s]};return x.useCallback(t,[])};function ze(t){const e=x.useRef(!1),n=x.useRef(null),s=me(t);return()=>{e.current||(e.current=!0,s(),n.current=we(()=>{e.current=!1}))}}function Oe(){const t=_.useRef([null,null]);return(n,s)=>{const i=n.map(a=>a instanceof HTMLElement||Number.isNaN(a)?"":a);return Ce(t.current[0],i)||(t.current=[i,s()]),t.current[1]}}function De(t){return t.replace(/([A-Z])/g,"-$1").toLowerCase()}function Ie(t){return Object.keys(t).map(e=>`${De(e)}: ${t[e]};`).join(" ")}function Ge(){return window.devicePixelRatio||1}const He=(t,e)=>{let n=!1;return t.removedNodes.length&&(n=Array.from(t.removedNodes).some(s=>e(s))),t.type==="attributes"&&e(t.target)&&(n=!0),n},Te={visibility:"visible !important"};function Xe(t){const e=_.useRef(new Map);return[(a,l,m)=>{if(m){if(!e.current.get(m)){const k=document.createElement("div");e.current.set(m,k)}const g=e.current.get(m);g.setAttribute("style",Ie(Object.assign(Object.assign(Object.assign({},t),{backgroundImage:`url('${a}')`,backgroundSize:`${Math.floor(l)}px`}),Te))),g.removeAttribute("class"),g.removeAttribute("hidden"),g.parentElement!==m&&m.append(g)}return e.current.get(m)},a=>{const l=e.current.get(a);l&&a&&a.removeChild(l),e.current.delete(a)},a=>Array.from(e.current.values()).includes(a)]}function ce(t,e){return t.size===e.size?t:e}const ie=100,le=100,ue={position:"relative",overflow:"hidden"},Ye=t=>{var e,n;const{zIndex:s=9,rotate:i=-22,width:a,height:l,image:m,content:g,font:k={},style:Q,className:b,rootClassName:H,gap:Z=[ie,le],offset:M,children:j,inherit:T=!0}=t,E=Object.assign(Object.assign({},ue),Q),[,W]=Ee(),{color:z=W.colorFill,fontSize:S=W.fontSizeLG,fontWeight:X="normal",fontStyle:N="normal",fontFamily:A="sans-serif",textAlign:ee="center"}=k,[Y=ie,L=le]=Z,$=Y/2,w=L/2,R=(e=M==null?void 0:M[0])!==null&&e!==void 0?e:$,C=(n=M==null?void 0:M[1])!==null&&n!==void 0?n:w,U=x.useMemo(()=>{const o={zIndex:s,position:"absolute",left:0,top:0,width:"100%",height:"100%",pointerEvents:"none",backgroundRepeat:"repeat"};let c=R-$,u=C-w;return c>0&&(o.left=`${c}px`,o.width=`calc(100% - ${c}px)`,c=0),u>0&&(o.top=`${u}px`,o.height=`calc(100% - ${u}px)`,u=0),o.backgroundPosition=`${c}px ${u}px`,o},[s,R,$,C,w]),[v,B]=x.useState(),[V,O]=x.useState(new Set),r=x.useMemo(()=>{const o=v?[v]:[];return[].concat(o,se(Array.from(V)))},[v,V]),d=o=>{let c=120,u=64;if(!m&&o.measureText){o.font=`${Number(S)}px ${A}`;const P=de(g),G=P.map(y=>{const f=o.measureText(y);return[f.width,f.fontBoundingBoxAscent+f.fontBoundingBoxDescent]});c=Math.ceil(Math.max.apply(Math,se(G.map(y=>y[0])))),u=Math.ceil(Math.max.apply(Math,se(G.map(y=>y[1]))))*P.length+(P.length-1)*fe}return[a??c,l??u]},h=je(),D=Oe(),[p,K]=x.useState(null),F=ze(()=>{const c=document.createElement("canvas").getContext("2d");if(c){const u=Ge(),[P,G]=d(c),y=f=>{const re=[f||"",i,u,P,G,{color:z,fontSize:S,fontStyle:N,fontWeight:X,fontFamily:A,textAlign:ee},Y,L],[ve,xe]=D(re,()=>h.apply(void 0,re));K([ve,xe])};if(m){const f=new Image;f.onload=()=>{y(f)},f.onerror=()=>{y(g)},f.crossOrigin="anonymous",f.referrerPolicy="no-referrer",f.src=m}else y(g)}}),[I,J,ne]=Xe(U);_.useEffect(()=>{p&&r.forEach(o=>{I(p[0],p[1],o)})},[p,r]);const ge=me(o=>{o.forEach(c=>{if(He(c,ne))F();else if(c.target===v&&c.attributeName==="style"){const u=Object.keys(ue);for(let P=0;P<u.length;P+=1){const G=u[P],y=E[G],f=v.style[G];y&&y!==f&&(v.style[G]=y)}}})});Fe(r,ge),_.useEffect(F,[i,s,a,l,m,g,z,S,X,N,A,ee,Y,L,R,C]);const he=x.useMemo(()=>({add:o=>{O(c=>{const u=new Set(c);return u.add(o),ce(c,u)})},remove:o=>{J(o),O(c=>{const u=new Set(c);return u.delete(o),ce(c,u)})}}),[]),ye=T?x.createElement(We.Provider,{value:he},j):j;return x.createElement("div",{ref:B,className:Ae(b,H),style:E},ye)},qe=async({project:t,analysisFileNames:e,params:n})=>(await pe.post("/fast-api/find-analyais-result-by-analysis-method",{project:t,analysis_method:e,...n})).data,Be=({pipeline:t,form:e,resultTableList:n,operatePipeline:s,formJson:i,formDom:a,params:l,sampleGroupApI:m,setPlotLoading:g,inputAnalysisMethod:k,saveAnalysisMethod:Q,project:b,setFilePlot:H,plotReloadTable:Z,callback:M,dataComponentIds:j,name:T,analysisResultId:E,...W})=>{const z=oe.useWatch(r=>r==null?void 0:r.analysis_id,e),S=oe.useWatch(r=>r,e),[X,N]=_.useState([]),[A,ee]=_.useState("xlsx"),[Y,L]=_.useState("pdf"),[$,w]=$e.useMessage(),R=async()=>{try{const d=(await pe.post("/fast-api/find-sample",{project:"hexiaoyan",sequencing_target:"DNA",sequencing_technique:"NGS",sample_composition:"meta_genome"})).data.map(h=>({label:h.sample_key,value:h.sample_key,sample_group:h.sample_group,sample_source:h.sample_source,host_disease:h.host_disease}));N(d)}catch(r){console.log(r)}};_.useEffect(()=>{e.resetFields()},[b]);const C={first_data_key:void 0},[U,v]=_.useState(C);_.useEffect(()=>{T&&e.setFieldValue("analysis_name",T)},[T]);const B=r=>{if(r&&Object.keys(r).length>0)return Object.keys(r)[0]},V=async r=>{const h=(await qe({project:b,analysisFileNames:r})).reduce((p,K)=>{const q=K.analysis_method;p[q]||(p[q]=[]);const{sample_key:F,id:I,sample_group:J,...ne}=K;return p[q].push({label:F,value:I,sample_group:J||"no_group",sample_key:F,id:I,...ne}),p},{}),D={...C,...n,...h,first_data_key:B(n)};v(D)};_.useEffect(()=>{if(m)R();else{let r=[];if(i&&(r=i.filter(d=>d.inputAnalysisMethod!==void 0).map(d=>d.inputAnalysisMethod)),r.length!=0)V(r);else{const d={...C,...n,first_data_key:B(n)};console.log(d),v(d)}}},[JSON.stringify(n)]);const O={...l,project:b,analysis_result_id:E,analysis_method:Q,table_type:A,imgType:Y,software:"python",component_id:W.component_id,data_component_ids:JSON.stringify(j)};return te.jsxs(te.Fragment,{children:[w,te.jsx(Ye,{content:z&&`更新分析(${S.analysis_name})(${String(S.analysis_id).slice(0,8)})`,children:te.jsx(Ne,{analysisResultId:E,form:e,requestParam:O,dataMap:U,formJson:i,databases:W.databases,callback:M})})]})};export{Be as A};
