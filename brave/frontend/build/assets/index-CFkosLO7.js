import{a as F,r as u,q as ge,k as U,j as e,F as D,i as O,l as M,B as y,M as B,d as z,I as T,P as E,v as re,m as oe,D as ae,s as xe,a2 as le,c as ye,$ as je,u as P,R as ce,C as J,S as ve,y as be,au as we,t as Se,b as de,p as Ce}from"./main-B2jPVJuc.js";import Fe from"./index-CwSQOIN4.js";import{C as he}from"./index-01a6DBbv.js";import{F as W}from"./index-D5lQbqN-.js";import{T as q}from"./index-bd5EV77p.js";import{F as ue}from"./Table-D1zuQkUf.js";import{KGMLMapSVG as _e}from"./index-Bi5GN48q.js";import{b as ze}from"./index-CjBmKVj7.js";import{S as me}from"./index-IGtn9UM1.js";import{A as ke}from"./index-ClcbhDbg.js";import{I as Me}from"./index-JnpnusFw.js";import{R as Ie}from"./index-umuRLg26.js";const bt=async i=>await F.get("/file-operation/read-file",{params:{file_path:i}}),Ee=async(i,a=0)=>await F.get("/file-operation/read-log-file",{params:{file_path:i,offset:a}}),wt=async(i,a)=>await F.post("/file-operation/write-file",{file_path:i,content:a}),St=async i=>await F.get(`/find-analysis-by-id/${i}`),Y=async(i,a)=>await F.post(`/run-analysis-v2/${i}?run_type=${a}`),Q=async(i,a)=>await F.post(`/analysis/stop-analysis/${i}?run_type=${a}`);function $(i,a,s){let r=s.initialDeps??[],n;function o(){var l,t,c,h;let d;s.key&&((l=s.debug)!=null&&l.call(s))&&(d=Date.now());const p=i();if(!(p.length!==r.length||p.some((m,x)=>r[x]!==m)))return n;r=p;let g;if(s.key&&((t=s.debug)!=null&&t.call(s))&&(g=Date.now()),n=a(...p),s.key&&((c=s.debug)!=null&&c.call(s))){const m=Math.round((Date.now()-d)*100)/100,x=Math.round((Date.now()-g)*100)/100,v=x/16,w=(C,S)=>{for(C=String(C);C.length<S;)C=" "+C;return C};console.info(`%c⏱ ${w(x,5)} /${w(m,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*v,120))}deg 100% 31%);`,s==null?void 0:s.key)}return(h=s==null?void 0:s.onChange)==null||h.call(s,n),n}return o.updateDeps=l=>{r=l},o}function X(i,a){if(i===void 0)throw new Error("Unexpected undefined");return i}const De=(i,a)=>Math.abs(i-a)<1.01,Oe=(i,a,s)=>{let r;return function(...n){i.clearTimeout(r),r=i.setTimeout(()=>a.apply(this,n),s)}},Z=i=>{const{offsetWidth:a,offsetHeight:s}=i;return{width:a,height:s}},Ae=i=>i,$e=i=>{const a=Math.max(i.startIndex-i.overscan,0),s=Math.min(i.endIndex+i.overscan,i.count-1),r=[];for(let n=a;n<=s;n++)r.push(n);return r},Ve=(i,a)=>{const s=i.scrollElement;if(!s)return;const r=i.targetWindow;if(!r)return;const n=l=>{const{width:t,height:c}=l;a({width:Math.round(t),height:Math.round(c)})};if(n(Z(s)),!r.ResizeObserver)return()=>{};const o=new r.ResizeObserver(l=>{const t=()=>{const c=l[0];if(c!=null&&c.borderBoxSize){const h=c.borderBoxSize[0];if(h){n({width:h.inlineSize,height:h.blockSize});return}}n(Z(s))};i.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(t):t()});return o.observe(s,{box:"border-box"}),()=>{o.unobserve(s)}},ee={passive:!0},te=typeof window>"u"?!0:"onscrollend"in window,Te=(i,a)=>{const s=i.scrollElement;if(!s)return;const r=i.targetWindow;if(!r)return;let n=0;const o=i.options.useScrollendEvent&&te?()=>{}:Oe(r,()=>{a(n,!1)},i.options.isScrollingResetDelay),l=d=>()=>{const{horizontal:p,isRtl:f}=i.options;n=p?s.scrollLeft*(f&&-1||1):s.scrollTop,o(),a(n,d)},t=l(!0),c=l(!1);c(),s.addEventListener("scroll",t,ee);const h=i.options.useScrollendEvent&&te;return h&&s.addEventListener("scrollend",c,ee),()=>{s.removeEventListener("scroll",t),h&&s.removeEventListener("scrollend",c)}},Le=(i,a,s)=>{if(a!=null&&a.borderBoxSize){const r=a.borderBoxSize[0];if(r)return Math.round(r[s.options.horizontal?"inlineSize":"blockSize"])}return i[s.options.horizontal?"offsetWidth":"offsetHeight"]},Pe=(i,{adjustments:a=0,behavior:s},r)=>{var n,o;const l=i+a;(o=(n=r.scrollElement)==null?void 0:n.scrollTo)==null||o.call(n,{[r.options.horizontal?"left":"top"]:l,behavior:s})};class We{constructor(a){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let s=null;const r=()=>s||(!this.targetWindow||!this.targetWindow.ResizeObserver?null:s=new this.targetWindow.ResizeObserver(n=>{n.forEach(o=>{const l=()=>{this._measureElement(o.target,o)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(l):l()})}));return{disconnect:()=>{var n;(n=r())==null||n.disconnect(),s=null},observe:n=>{var o;return(o=r())==null?void 0:o.observe(n,{box:"border-box"})},unobserve:n=>{var o;return(o=r())==null?void 0:o.unobserve(n)}}})(),this.range=null,this.setOptions=s=>{Object.entries(s).forEach(([r,n])=>{typeof n>"u"&&delete s[r]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:Ae,rangeExtractor:$e,onChange:()=>{},measureElement:Le,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...s}},this.notify=s=>{var r,n;(n=(r=this.options).onChange)==null||n.call(r,this,s)},this.maybeNotify=$(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),s=>{this.notify(s)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(s=>s()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var s;const r=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==r){if(this.cleanup(),!r){this.maybeNotify();return}this.scrollElement=r,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=((s=this.scrollElement)==null?void 0:s.window)??null,this.elementsCache.forEach(n=>{this.observer.observe(n)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,n=>{this.scrollRect=n,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(n,o)=>{this.scrollAdjustments=0,this.scrollDirection=o?this.getScrollOffset()<n?"forward":"backward":null,this.scrollOffset=n,this.isScrolling=o,this.maybeNotify()}))}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??(typeof this.options.initialOffset=="function"?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(s,r)=>{const n=new Map,o=new Map;for(let l=r-1;l>=0;l--){const t=s[l];if(n.has(t.lane))continue;const c=o.get(t.lane);if(c==null||t.end>c.end?o.set(t.lane,t):t.end<c.end&&n.set(t.lane,!0),n.size===this.options.lanes)break}return o.size===this.options.lanes?Array.from(o.values()).sort((l,t)=>l.end===t.end?l.index-t.index:l.end-t.end)[0]:void 0},this.getMeasurementOptions=$(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(s,r,n,o,l)=>(this.pendingMeasuredCacheIndexes=[],{count:s,paddingStart:r,scrollMargin:n,getItemKey:o,enabled:l}),{key:!1}),this.getMeasurements=$(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:s,paddingStart:r,scrollMargin:n,getItemKey:o,enabled:l},t)=>{if(!l)return this.measurementsCache=[],this.itemSizeCache.clear(),[];this.measurementsCache.length===0&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(d=>{this.itemSizeCache.set(d.key,d.size)}));const c=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];const h=this.measurementsCache.slice(0,c);for(let d=c;d<s;d++){const p=o(d),f=this.options.lanes===1?h[d-1]:this.getFurthestMeasurement(h,d),g=f?f.end+this.options.gap:r+n,m=t.get(p),x=typeof m=="number"?m:this.options.estimateSize(d),v=g+x,w=f?f.lane:d%this.options.lanes;h[d]={index:d,start:g,size:x,end:v,key:p,lane:w}}return this.measurementsCache=h,h},{key:!1,debug:()=>this.options.debug}),this.calculateRange=$(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(s,r,n,o)=>this.range=s.length>0&&r>0?Be({measurements:s,outerSize:r,scrollOffset:n,lanes:o}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=$(()=>{let s=null,r=null;const n=this.calculateRange();return n&&(s=n.startIndex,r=n.endIndex),this.maybeNotify.updateDeps([this.isScrolling,s,r]),[this.options.rangeExtractor,this.options.overscan,this.options.count,s,r]},(s,r,n,o,l)=>o===null||l===null?[]:s({startIndex:o,endIndex:l,overscan:r,count:n}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=s=>{const r=this.options.indexAttribute,n=s.getAttribute(r);return n?parseInt(n,10):(console.warn(`Missing attribute name '${r}={index}' on measured element.`),-1)},this._measureElement=(s,r)=>{const n=this.indexFromElement(s),o=this.measurementsCache[n];if(!o)return;const l=o.key,t=this.elementsCache.get(l);t!==s&&(t&&this.observer.unobserve(t),this.observer.observe(s),this.elementsCache.set(l,s)),s.isConnected&&this.resizeItem(n,this.options.measureElement(s,r,this))},this.resizeItem=(s,r)=>{const n=this.measurementsCache[s];if(!n)return;const o=this.itemSizeCache.get(n.key)??n.size,l=r-o;l!==0&&((this.shouldAdjustScrollPositionOnItemSizeChange!==void 0?this.shouldAdjustScrollPositionOnItemSizeChange(n,l,this):n.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=l,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(n.index),this.itemSizeCache=new Map(this.itemSizeCache.set(n.key,r)),this.notify(!1))},this.measureElement=s=>{if(!s){this.elementsCache.forEach((r,n)=>{r.isConnected||(this.observer.unobserve(r),this.elementsCache.delete(n))});return}this._measureElement(s,void 0)},this.getVirtualItems=$(()=>[this.getVirtualIndexes(),this.getMeasurements()],(s,r)=>{const n=[];for(let o=0,l=s.length;o<l;o++){const t=s[o],c=r[t];n.push(c)}return n},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=s=>{const r=this.getMeasurements();if(r.length!==0)return X(r[pe(0,r.length-1,n=>X(r[n]).start,s)])},this.getOffsetForAlignment=(s,r,n=0)=>{const o=this.getSize(),l=this.getScrollOffset();r==="auto"&&(r=s>=l+o?"end":"start"),r==="center"?s+=(n-o)/2:r==="end"&&(s-=o);const t=this.getTotalSize()+this.options.scrollMargin-o;return Math.max(Math.min(t,s),0)},this.getOffsetForIndex=(s,r="auto")=>{s=Math.max(0,Math.min(s,this.options.count-1));const n=this.measurementsCache[s];if(!n)return;const o=this.getSize(),l=this.getScrollOffset();if(r==="auto")if(n.end>=l+o-this.options.scrollPaddingEnd)r="end";else if(n.start<=l+this.options.scrollPaddingStart)r="start";else return[l,r];const t=r==="end"?n.end+this.options.scrollPaddingEnd:n.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(t,r,n.size),r]},this.isDynamicMode=()=>this.elementsCache.size>0,this.scrollToOffset=(s,{align:r="start",behavior:n}={})=>{n==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getOffsetForAlignment(s,r),{adjustments:void 0,behavior:n})},this.scrollToIndex=(s,{align:r="auto",behavior:n}={})=>{n==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),s=Math.max(0,Math.min(s,this.options.count-1));let o=0;const l=10,t=h=>{if(!this.targetWindow)return;const d=this.getOffsetForIndex(s,h);if(!d){console.warn("Failed to get offset for index:",s);return}const[p,f]=d;this._scrollToOffset(p,{adjustments:void 0,behavior:n}),this.targetWindow.requestAnimationFrame(()=>{const g=this.getScrollOffset(),m=this.getOffsetForIndex(s,f);if(!m){console.warn("Failed to get offset for index:",s);return}De(m[0],g)||c(f)})},c=h=>{this.targetWindow&&(o++,o<l?this.targetWindow.requestAnimationFrame(()=>t(h)):console.warn(`Failed to scroll to index ${s} after ${l} attempts.`))};t(r)},this.scrollBy=(s,{behavior:r}={})=>{r==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getScrollOffset()+s,{adjustments:void 0,behavior:r})},this.getTotalSize=()=>{var s;const r=this.getMeasurements();let n;if(r.length===0)n=this.options.paddingStart;else if(this.options.lanes===1)n=((s=r[r.length-1])==null?void 0:s.end)??0;else{const o=Array(this.options.lanes).fill(null);let l=r.length-1;for(;l>=0&&o.some(t=>t===null);){const t=r[l];o[t.lane]===null&&(o[t.lane]=t.end),l--}n=Math.max(...o.filter(t=>t!==null))}return Math.max(n-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(s,{adjustments:r,behavior:n})=>{this.options.scrollToFn(s,{behavior:n,adjustments:r},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(a)}}const pe=(i,a,s,r)=>{for(;i<=a;){const n=(i+a)/2|0,o=s(n);if(o<r)i=n+1;else if(o>r)a=n-1;else return n}return i>0?i-1:0};function Be({measurements:i,outerSize:a,scrollOffset:s,lanes:r}){const n=i.length-1,o=c=>i[c].start;if(i.length<=r)return{startIndex:0,endIndex:n};let l=pe(0,n,o,s),t=l;if(r===1)for(;t<n&&i[t].end<s+a;)t++;else if(r>1){const c=Array(r).fill(0);for(;t<n&&c.some(d=>d<s+a);){const d=i[t];c[d.lane]=d.end,t++}const h=Array(r).fill(s+a);for(;l>=0&&h.some(d=>d>=s);){const d=i[l];h[d.lane]=d.start,l--}l=Math.max(0,l-l%r),t=Math.min(n,t+(r-1-t%r))}return{startIndex:l,endIndex:t}}const se=typeof document<"u"?u.useLayoutEffect:u.useEffect;function Ne(i){const a=u.useReducer(()=>({}),{})[1],s={...i,onChange:(n,o)=>{var l;o?ge.flushSync(a):a(),(l=i.onChange)==null||l.call(i,n,o)}},[r]=u.useState(()=>new We(s));return r.setOptions(s),se(()=>r._didMount(),[]),se(()=>r._willUpdate()),r}function Je(i){return Ne({observeElementRect:Ve,observeElementOffset:Te,scrollToFn:Pe,...i})}const{Text:ne}=O,Ue=({file_path:i})=>{var h;u.useEffect(()=>{console.log("fileKey",i),i&&o(i)},[i]);const{messageApi:a}=U(),s=u.useRef(0),[r,n]=u.useState([]),o=async(d,p=!1)=>{const f=await Ee(d);s.current=f.data.offset,n(f.data.content),p&&a.success(`日志加载成功: ${d}`)},l=u.useRef(null),t=Je({count:r.length,getScrollElement:()=>l.current,estimateSize:()=>30,overscan:10});u.useEffect(()=>{(r==null?void 0:r.length)>0&&t.scrollToIndex(r.length-1,{align:"end",behavior:"smooth"})},[r==null?void 0:r.length]);const c=t.getVirtualItems();return e.jsx(he,{size:"small",extra:e.jsx(y,{size:"small",type:"primary",onClick:()=>{o(i)},children:"Refresh Log"}),title:e.jsxs(D,{gap:"small",wrap:"wrap",children:[e.jsxs(M,{color:"blue",children:["File: ",i]}),e.jsxs(M,{color:"purple",children:["Offset: ",s.current]})]}),bodyStyle:{padding:0},children:e.jsx("div",{ref:l,style:{height:400,overflowY:"auto",fontFamily:"monospace",backgroundColor:"#1e1e1e",color:"#d4d4d4",padding:"0 12px"},children:e.jsx("div",{style:{height:t.getTotalSize(),width:"100%",position:"relative"},children:e.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${((h=c[0])==null?void 0:h.start)??0}px)`},children:c.map(d=>e.jsx("div",{"data-index":d.index,ref:t.measureElement,style:{padding:"4px 0",borderBottom:"1px solid #333"},children:e.jsxs(D,{gap:"middle",children:[e.jsxs(ne,{type:"secondary",style:{width:60,color:"#d4d4d4"},children:["#",d.index+1]}),e.jsx(ne,{style:{whiteSpace:"pre-wrap",color:"#d4d4d4"},children:r[d.index]})]})},d.key))})})})})},qe=({visible:i,onClose:a,params:s})=>e.jsx(B,{footer:null,title:"参数",width:"50%",open:i,onCancel:a,children:e.jsx(O,{children:e.jsx("pre",{children:JSON.stringify(s,null,2)})})}),Ke=({formJson:i,openModal:a})=>{if(!i)return null;const[s,r]=u.useState([]),n=async()=>{const o=i.map(c=>c.dataKey),t=((await F.post("/list-bio-database",{type_list:o})).data||[]).reduce((c,h)=>{const d=h.type;c[d]||(c[d]=[]);const{name:p,database_id:f,...g}=h;return c[d].push({label:p,value:f,...g}),c},{});r(t),console.log(t)};return u.useEffect(()=>{n()},[i]),e.jsx(e.Fragment,{children:e.jsxs(D,{gap:"small",children:[e.jsx("div",{style:{flex:1},children:e.jsx(W,{formJson:i,dataMap:s})}),e.jsx(y,{size:"small",color:"cyan",variant:"solid",onClick:a,children:"配置数据库"}),e.jsx(y,{onClick:n,size:"small",type:"primary",children:"刷新"})]})})},Ge=({visible:i,onClose:a,params:s,callback:r})=>{if(!i)return null;const[n,o]=u.useState([]),[l,t]=u.useState(!1),[c]=z.useForm(),[h,d]=u.useState(s[0].dataKey),[p,f]=u.useState(null),g=async j=>{t(!0);const b=await F.post("/list-bio-database",j);o(b.data),t(!1)},m=async()=>({...await c.validateFields(),type:h}),x=async()=>{const j=await m();p?await F.post("/update-bio-database",{...j,database_id:p.database_id}):await F.post("/add-bio-database",j),v(),f(void 0),c.resetFields()},v=()=>{g({type:h})};u.useEffect(()=>{g({type:h})},[s]);const w=j=>{d(j),g({type:j})},C=async j=>{await F.delete(`/delete-bio-database/${j.id}`),v()},S=j=>{c.setFieldsValue(j),f(j)};return e.jsxs(B,{title:"数据库操作",open:i,onCancel:a,width:"50%",footer:null,children:[e.jsx(q,{tabBarExtraContent:e.jsxs(e.Fragment,{children:[e.jsx(y,{size:"small",color:"cyan",variant:"solid",style:{marginRight:"0.5rem"},type:"primary",onClick:v,children:" 刷新"}),e.jsxs(y,{size:"small",color:"cyan",variant:"solid",type:"primary",onClick:()=>{f(void 0),x()},children:[" ",p?"更新":"添加"]})]}),activeKey:h,onChange:w,items:s.map(j=>({key:j.name,label:j.label,children:e.jsx("div",{})}))}),e.jsxs(z,{form:c,style:{maxWidth:600},labelCol:{span:3},children:[e.jsx(z.Item,{name:"name",label:"名称",rules:[{required:!0,message:"请输入名称"}],children:e.jsx(T,{})}),e.jsx(z.Item,{name:"path",label:"路径",rules:[{required:!0,message:"请输入路径"}],children:e.jsx(T,{})}),e.jsx(z.Item,{name:"db_index",label:"索引",children:e.jsx(T,{})})]}),e.jsx(ue,{dataSource:n,columns:[{title:"名称",dataIndex:"name",key:"name"},{title:"数据库ID",dataIndex:"database_id",key:"database_id"},{title:"类型",dataIndex:"type",key:"type"},{title:"路径",dataIndex:"path",key:"path"},{title:"索引",dataIndex:"db_index",key:"db_index"},{title:"操作",dataIndex:"action",key:"action",ellipsis:!0,render:(j,b)=>e.jsxs(D,{gap:"small",children:[e.jsx(E,{title:"确定删除吗？",onConfirm:()=>{C(b)},children:e.jsx(y,{size:"small",type:"primary",danger:!0,children:"删除"})}),e.jsx(y,{size:"small",type:"primary",onClick:()=>{S(b)},children:"编辑"})]})}],loading:l,pagination:!1})]})},Re=({visible:i,params:a,onClose:s,callback:r})=>{var v,w,C;const[n]=z.useForm(),{messageApi:o,project:l}=U();u.useEffect(()=>{i&&m()},[a]);const[t,c]=u.useState(),[h,d]=u.useState(),p=()=>{s(),r&&r()},[f,g]=u.useState(),m=async()=>{g(!0);const S=await F.post(`/analysis/edit-params/${a}`);c(S.data),d(S.data.analysis_result),n.resetFields(),n.setFieldsValue(S.data.request_param),g(!1)},x=S=>{if(S&&Object.keys(S).length>0)return Object.keys(S)[0]};return e.jsx(e.Fragment,{children:e.jsx(ae,{size:"default",loading:f,title:e.jsx(e.Fragment,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(M,{children:t==null?void 0:t.component_name}),e.jsx(M,{children:t==null?void 0:t.analysis_name}),e.jsx(M,{children:String(t==null?void 0:t.analysis_id).slice(0,8)})]})}),width:"50%",open:i,onClose:s,children:t&&e.jsx(e.Fragment,{children:e.jsx(He,{form:n,requestParam:{...t.request_param,analysis_id:t==null?void 0:t.analysis_id},dataMap:{...h,first_data_key:x(h)},formJson:[...((v=t.content)==null?void 0:v.formJson)||[],...((w=t.content)==null?void 0:w.upstreamFormJson)||[],...(t==null?void 0:t.inputFormJson)||[],(t==null?void 0:t.component_type)=="software"?{name:"group_field",label:"Group Field",rules:[{required:!0,message:"该字段不能为空!"}],type:"GroupFieldSelect"}:{}],databases:(C=t.content)==null?void 0:C.databases,upstreamFormJson:t==null?void 0:t.upstreamFormJson,callback:p})})})})},He=({form:i,requestParam:a,dataMap:s,formJson:r,databases:n,callback:o,analysisResultId:l,showCancal:t=!1})=>{const{modals:c,openModals:h,closeModals:d}=re(["paramsView","bioDatabases"]),[p,f]=u.useState([]),[g,m]=u.useState([]),{messageApi:x}=U();u.useEffect(()=>{v()},[JSON.stringify(r)]);const v=()=>{if(Array.isArray(r)){const S=r.filter(b=>!(b!=null&&b.required)&&!(b!=null&&b.db)&&!b.component_id),j=r.filter(b=>(b==null?void 0:b.required)||(b==null?void 0:b.db)||b.component_id);f(j),m(S)}},w=S=>({...a,...S}),C=async(S,j=!1)=>{var I;const b=await i.validateFields(),K=w(b);try{const _=await F.post(`/fast-api/analysis-controller?save=${S}&is_submit=${j}`,K);console.log(_),S?(x.success("执行成功!"),o&&o()):h("paramsView",_.data)}catch(_){console.log(_),(I=_.response)!=null&&I.data&&x.error(_.response.data.detail)}};return e.jsxs(e.Fragment,{children:[e.jsxs(z,{form:i,onValuesChange:(S,j)=>{},children:[e.jsx(q,{items:[{key:"1",label:"Required Parameters",forceRender:!0,children:e.jsxs(e.Fragment,{children:[e.jsx(W,{analysisResultId:l,formJson:[...p],dataMap:s}),n&&e.jsx(Ke,{openModal:()=>{h("bioDatabases",n)},formJson:n})]})},{key:"2",label:"Optional parameters",forceRender:!0,children:e.jsx(e.Fragment,{children:e.jsx(W,{formJson:[...g],dataMap:{}})})}]}),e.jsx(z.Item,{label:"Analysyis Name",name:"analysis_name",style:{maxWidth:600},rules:[{required:!0,message:"This field cannot be empty!"}],children:e.jsx(T,{})}),e.jsxs(D,{gap:"small",children:[e.jsx(y,{size:"small",color:"cyan",variant:"solid",onClick:()=>{C(!1)},children:"View Parameters"}),e.jsx(y,{size:"small",color:"cyan",variant:"solid",onClick:()=>C(!0),children:a!=null&&a.analysis_id?e.jsxs(e.Fragment,{children:["Update Analysis(",a.analysis_name,")(",String(a.analysis_id).slice(0,8),")"]}):e.jsx(e.Fragment,{children:"Save Analysis"})}),(a==null?void 0:a.analysis_id)&&t&&e.jsx(y,{size:"small",color:"cyan",onClick:()=>i.setFieldValue("analysis_id",void 0),children:"Cancel Analysis"})]}),e.jsx(oe,{ghost:!0,items:[{key:"1",label:"More",children:e.jsx(e.Fragment,{children:e.jsx(z.Item,{noStyle:!0,shouldUpdate:!0,children:()=>e.jsx(O,{children:e.jsx("pre",{children:JSON.stringify(w(i.getFieldsValue()),null,2)})})})})}]})]}),e.jsx(qe,{visible:c.paramsView.visible,onClose:()=>d("paramsView"),params:c.paramsView.params}),e.jsx(Ge,{visible:c.bioDatabases.visible,onClose:()=>d("bioDatabases"),params:c.bioDatabases.params})]})},Ye=({visible:i,onClose:a,params:s,callback:r})=>{if(!i)return null;const[n,o]=u.useState(),[l,t]=xe.useMessage(),[c,h]=u.useState("main"),d=u.useRef(null),p=async f=>{try{const g=await F.get(`/get-component-module-content/${f.component_id}?script_name=${c}`);console.log(g),o(g.data)}catch(g){l.error(`${g.response.data.detail}`)}};return u.useEffect(()=>{p(s)},[JSON.stringify(s),c]),e.jsxs(e.Fragment,{children:[t,e.jsxs(ae,{extra:e.jsxs(D,{justify:"flex-end",gap:"small",children:[e.jsx(E,{title:"是否生成脚本",onConfirm:async()=>{await F.post(`/component/convert-ipynb/${s.component_id}`),l.success("是否生成脚本成功!"),p(s)},children:e.jsx(y,{size:"small",color:"cyan",variant:"solid",children:"生成脚本"})}),e.jsx(y,{size:"small",color:"cyan",variant:"solid",onClick:()=>{p(s)},children:"刷新"}),e.jsx(y,{size:"small",color:"cyan",variant:"solid",onClick:()=>{d.current.setValue(n==null?void 0:n.content)},children:"保存"})]}),title:"View File",open:i,onClose:a,width:"50%",children:[e.jsx("ul",{children:e.jsxs("li",{children:["path:",n==null?void 0:n.path]})}),e.jsx("hr",{}),e.jsx(q,{onChange:f=>{h(f)},items:[{label:"main",key:"main"},{label:"input_parse",key:"input_parse"},{label:"output_parse",key:"output_parse"}]}),e.jsx(le,{value:n==null?void 0:n.content,editorRef:d,defaultLanguage:"python"})]})]})},N=({url:i,filename:a,baseURL:s})=>e.jsx(e.Fragment,{children:i&&e.jsx(Ce,{title:e.jsx("div",{style:{wordBreak:"break-all",maxWidth:"400px"},children:`${s}${i}`}),children:e.jsxs(M,{color:"success",style:{cursor:"pointer",whiteSpace:"normal",wordBreak:"break-all",display:"inline-block"},onClick:()=>{window.open(`${s}${i}?t=${Date.now()}`,"_blank")},children:[e.jsxs("span",{children:[a," "]}),e.jsx(Ie,{})]})})}),fe=({data:i,url:a,filename:s,columns:r,baseURL:n,projectObj:o})=>{const{Search:l}=T,[t,c]=u.useState([]),[h,d]=u.useState(),[p,f]=u.useState();u.useEffect(()=>{if(o!=null&&o.research)try{const m=JSON.parse((o==null?void 0:o.research)||"{}");d(m)}catch{}},[o==null?void 0:o.research]);const g=m=>m?Object.keys(m).map(x=>({title:x,dataIndex:x,key:x,ellipsis:!0,width:150})):[];return u.useEffect(()=>{if(i){const m=i.map((x,v)=>({...x,key:v}));c(m)}},[i]),e.jsxs(e.Fragment,{children:[(h==null?void 0:h.table)&&e.jsx(e.Fragment,{children:e.jsx("div",{style:{marginBottom:"1rem"},children:h==null?void 0:h.table.map(m=>e.jsx(M,{color:"blue",style:{cursor:"pointer"},onClick:()=>{const x=i.filter(v=>Object.values(v).some(w=>typeof w=="string"&&w.includes(m)));c(x),f(m)},children:m},m))})}),Array.isArray(t)&&e.jsx(e.Fragment,{children:e.jsx(ue,{style:{border:"1px solid #f0f0f0"},size:"small",title:()=>e.jsxs(D,{gap:"small",children:[e.jsx(l,{value:p,size:"small",onChange:m=>{f(m.target.value)},placeholder:"input search text",allowClear:!0,onSearch:m=>{const x=i.filter(v=>Object.values(v).some(w=>typeof w=="string"&&w.includes(m)));c(x)},style:{width:304}}),e.jsx(N,{url:a,filename:s,baseURL:n})]}),scroll:{x:"max-content",y:55*5},dataSource:t,pagination:!1,virtual:!0,columns:r||g(i[0]),footer:()=>`A total of ${i.length} records`})})]})},ie=({data:i,url:a,filename:s,baseURL:r})=>e.jsx("div",{children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx(Me,{src:s!=null&&s.endsWith("pdf")?i:`${i}?t=${Date.now()}`,style:{maxWidth:"20rem",marginRight:"0.5rem"}}),e.jsx(N,{url:a,filename:s,baseURL:r})]})}),{Paragraph:Ct}=O,Qe=({data:i})=>e.jsx(e.Fragment,{children:e.jsx(O,{children:e.jsx("pre",{style:{margin:0},children:i})})}),Xe=({data:i})=>e.jsx("div",{children:e.jsx(ke,{closable:!0,message:i,type:"info",showIcon:!0})}),Ze=({data:i})=>e.jsx(e.Fragment,{children:e.jsx(O,{children:e.jsx("pre",{style:{margin:0},children:i})})}),et=({data:i})=>e.jsx(e.Fragment,{children:e.jsx(le,{value:i,defaultLanguage:"json"})}),tt=({data:i,url:a})=>{const{baseURL:s}=P(o=>o.user),[r,n]=u.useState(!0);return e.jsx(e.Fragment,{children:e.jsxs("div",{style:{position:"relative",width:"100%",height:"80vh"},children:[r&&e.jsx("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.8)",zIndex:1},children:e.jsx(me,{size:"large",tip:"Loading..."})}),e.jsx("iframe",{src:`${s}${a}`,width:"100%",style:{height:"100%",border:"none"},onLoad:()=>n(!1),title:"content-frame"})]})})},st=({url:i,filename:a,baseURL:s})=>e.jsx(e.Fragment,{children:e.jsx(N,{url:i,filename:a,baseURL:s})}),nt=({data:i,...a})=>{var o,l,t,c,h;const{modal:s,openModal:r,closeModal:n}=de();return e.jsxs(e.Fragment,{children:[e.jsx(fe,{data:i==null?void 0:i.list,...a,columns:[{title:"ID",dataIndex:"ID",key:"ID",ellipsis:!0,width:150},{title:"Description",dataIndex:"Description",key:"Description",ellipsis:!0,width:400},{title:"GeneRatio",dataIndex:"GeneRatio",key:"GeneRatio",ellipsis:!0,width:150},{title:"geneID",dataIndex:"geneID",key:"geneID",ellipsis:!0,width:150},{title:"Count",dataIndex:"Count",key:"Count",ellipsis:!0,width:150},{title:"pvalue",dataIndex:"pvalue",key:"pvalue",ellipsis:!0,width:150},{title:"p.adjust",dataIndex:"p.adjust",key:"p.adjust",ellipsis:!0,width:150},{title:"qvalue",dataIndex:"qvalue",key:"qvalue",ellipsis:!0,width:150},{title:"organism",dataIndex:"organism",key:"organism",ellipsis:!0,width:150},{title:"pathwayId",dataIndex:"pathwayId",key:"pathwayId",ellipsis:!0,width:150},{title:"操作",key:"action",fixed:"right",ellipsis:!0,width:200,render:(d,p)=>e.jsx(e.Fragment,{children:e.jsx(y,{onClick:()=>{r("KGMLMapSVG",p)},size:"small",color:"cyan",variant:"solid",children:"pathview"})})}]}),s.visible&&e.jsx(B,{width:"80%",title:`${(o=s.params)==null?void 0:o.Description}(${(l=s.params)==null?void 0:l.ID})`,footer:null,onCancel:n,onClose:n,open:s.visible&&s.key=="KGMLMapSVG",children:e.jsx(_e,{compound:i==null?void 0:i.compound,highlightKeys:(t=s.params)==null?void 0:t.geneID.split("/"),pathwayId:(c=s.params)==null?void 0:c.pathwayId,organisms:(h=s.params)==null?void 0:h.organism})})]})},it={table:fe,string:Qe,html:tt,json:et,text:Ze,info:Xe,kegg_map:nt,download:st},rt=({type:i,...a})=>{const s=it[i]||(()=>e.jsxs("div",{children:["未知类型 ",i]}));return e.jsx("div",{style:{marginBottom:"1rem"},children:e.jsx(s,{...a})})},Ft=u.forwardRef(({params:i,visible:a,onClose:s},r)=>{const{output_dir:n,analysis_id:o}=i||{};return a?e.jsx(e.Fragment,{children:o&&e.jsx(ot,{onClose:s,analysis_id:o})}):null}),ot=({analysis_id:i,onClose:a,cancalReportCallback:s,openPanel:r,overflowY:n="hidden"})=>{var R,H;const[o,l]=u.useState(!1),[t,c]=u.useState(null),h=ye(),{eventSourceRef:d,status:p,reconnect:f}=je(),g=u.useRef(null),m=u.useRef(null),x=be(),{modals:v,openModals:w,closeModals:C}=re(["editParams","moduleEdit","createOrUpdatePipelineComponent"]),{containerURL:S,project:j}=P(k=>k.user),[b,K]=u.useState(!1),[I]=z.useForm(),_=async k=>{l(!0);const A=await F.get(`/analysis/visualization-results/${k}`);c(A.data),I.resetFields(),I.setFieldsValue(A.data.request_param),g.current=k,l(!1)},G=k=>({analysis_id:i,...t==null?void 0:t.request_param,...k,project:j});return u.useEffect(()=>{_(i)},[i]),u.useEffect(()=>{var k;if(d){const A=L=>{const V=JSON.parse(L.data);m.current=V,g.current==V.analysis_id&&(V.event=="analysis_complete"||V.event=="analysis_failed"||V.event=="analysis_started")&&_(g.current)};return(k=d.current)==null||k.addEventListener("message",A),()=>{var L;console.log("removeEventListener"),(L=d.current)==null||L.removeEventListener("message",A)}}},[d.current]),e.jsx(e.Fragment,{children:e.jsxs(he,{size:"small",style:n=="auto"?{flex:1,display:"flex",flexDirection:"column",height:" 100%",boxShadow:"none"}:{boxShadow:"none"},styles:{body:{flex:1,display:"flex",flexDirection:"column",height:" 100%",overflowY:n}},variant:"borderless",title:e.jsx(e.Fragment,{children:t?e.jsxs(e.Fragment,{children:[e.jsx(M,{style:{cursor:"pointer"},onClick:()=>{h(`/component/${t==null?void 0:t.component_type}/${t==null?void 0:t.component_id}`)},children:t==null?void 0:t.component_name}),e.jsx(M,{children:t==null?void 0:t.analysis_name}),e.jsx(M,{children:String(t==null?void 0:t.analysis_id).slice(0,8)}),e.jsx(M,{children:t==null?void 0:t.job_status}),g.current==((R=m.current)==null?void 0:R.analysis_id)&&e.jsxs(M,{children:[" ",e.jsx(e.Fragment,{children:(H=m.current)==null?void 0:H.event})]})]}):e.jsx(e.Fragment,{})}),extra:e.jsxs(D,{gap:"small",wrap:!0,children:[r&&e.jsxs(e.Fragment,{children:[t&&e.jsxs(y,{size:"small",color:"primary",variant:"solid",onClick:()=>h(`/component/${t==null?void 0:t.component_type}/${t==null?void 0:t.component_id}`),children:["Go ",t==null?void 0:t.component_type]}),e.jsx(y,{size:"small",color:"cyan",variant:"solid",onClick:()=>{r("note")},children:"Open Note"})]}),e.jsx(y,{size:"small",color:"cyan",variant:"solid",onClick:()=>{w("createOrUpdatePipelineComponent",{data:{component_id:t==null?void 0:t.component_id},structure:{component_type:"script"}})},children:"Edit Script"}),a&&e.jsxs(e.Fragment,{children:[e.jsx(y,{size:"small",color:"cyan",variant:"solid",onClick:()=>a(),children:"Close"}),e.jsx(y,{size:"small",color:"primary",variant:"solid",onClick:()=>h(`/analysis-report?key=${t==null?void 0:t.analysis_id}&project=${j}`),children:"Go Report"})]}),t&&e.jsxs(e.Fragment,{children:[e.jsx(y,{size:"small",color:"cyan",variant:"solid",onClick:()=>{w("moduleEdit",{component_id:t==null?void 0:t.component_id})},children:"Component Code"}),e.jsx(y,{size:"small",color:"cyan",variant:"solid",onClick:()=>{w("editParams",t.analysis_id)},children:"Edit Parameters"}),(t==null?void 0:t.job_status)=="running"?e.jsx(e.Fragment,{children:e.jsx(E,{title:"Whether or not to stop?",onConfirm:async()=>{await Q(t.analysis_id,"job"),x.success("Stop Success")},children:e.jsx(y,{size:"small",color:"red",variant:"solid",children:"Stop"})})}):e.jsx(e.Fragment,{children:e.jsx(E,{title:"Whether or not to run?",onConfirm:async()=>{await Y(t.analysis_id,"job"),x.success("run successfully")},children:e.jsx(y,{size:"small",color:"cyan",variant:"solid",children:t.job_status=="created"?"Run":"Re-Run"})})}),(t==null?void 0:t.server_status)=="running"?e.jsxs(e.Fragment,{children:[e.jsx(Se,{title:e.jsx(e.Fragment,{children:`${S}/container/${t.analysis_id}/`}),children:e.jsx(y,{size:"small",color:"blue",variant:"solid",onClick:()=>{window.open(`${S}/container/${t.analysis_id}/`,"_blank")},children:"Open URL"})}),e.jsx(E,{title:"Whether or not to stop?",onConfirm:async()=>{await Q(t.analysis_id,"server")},children:e.jsx(y,{size:"small",color:"red",variant:"solid",children:"Stop Server"})})]}):e.jsx(e.Fragment,{children:e.jsx(E,{title:"Whether to start the server?",onConfirm:async()=>{await Y(t.analysis_id,"server")},children:e.jsx(y,{size:"small",color:"cyan",variant:"solid",children:"Run Server"})})}),e.jsx(E,{title:t!=null&&t.is_report?"Whether to cancel the report?":"Reported or not?",onConfirm:async()=>{await F.post(`/analysis/update-report/${t==null?void 0:t.analysis_id}`),x.success("operate successfully!"),c(null),s&&s()},children:e.jsx(y,{size:"small",color:"cyan",variant:"solid",children:t!=null&&t.is_report?"Cancel Report":"Report"})})]}),e.jsx(y,{size:"small",color:"cyan",variant:"solid",onClick:()=>_(i),children:"Refresh"})]}),children:[(t==null?void 0:t.job_status)=="failed"?e.jsx("div",{style:{textAlign:"center"},children:e.jsx("div",{style:{flex:1,overflowY:"auto",marginBottom:"1rem"},children:e.jsx(Ue,{file_path:t==null?void 0:t.command_log_path})})}):e.jsx(me,{spinning:o,tip:"loading...",style:{minHeight:"5rem"},children:e.jsxs(ce,{gutter:[8,8],children:[e.jsx(J,{lg:16,sm:16,xs:24,children:(t==null?void 0:t.job_status)=="running"&&(t==null?void 0:t.run_type)!="server"?e.jsx(ve,{active:!0}):e.jsx(e.Fragment,{children:i&&e.jsx(at,{analsyisResult:t,loading:o})})}),e.jsxs(J,{lg:8,sm:8,xs:24,style:{borderLeft:"1px solid #f0f0f0"},children:[e.jsx(z,{form:I,size:"small",layout:"vertical",children:(t==null?void 0:t.form_json)&&e.jsxs(e.Fragment,{children:[e.jsx(W,{formJson:t==null?void 0:t.form_json,dataMap:{}}),e.jsx(z.Item,{children:e.jsx(E,{title:"Whether to submit?",onConfirm:async()=>{if((t==null?void 0:t.job_status)=="running")x.error("Running, please wait!");else{const k=G(await I.validateFields());await F.post("/fast-api/analysis-controller?save=true&is_submit=true",k),console.log(k),x.success("Submit Success!")}},children:e.jsx(y,{disabled:(t==null?void 0:t.job_status)=="running",type:"primary",size:"small",children:"Submit"})})}),e.jsx(oe,{ghost:!0,items:[{key:"1",label:"More",children:e.jsx(e.Fragment,{children:e.jsx(z.Item,{noStyle:!0,shouldUpdate:!0,children:()=>e.jsx(O,{children:e.jsx("pre",{children:JSON.stringify(G(I.getFieldsValue()),null,2)})})})})}]})]})}),e.jsx(we,{}),e.jsx(Fe,{data:t==null?void 0:t.description})]})]})}),e.jsx(Re,{callback:()=>_(i),visible:v.editParams.visible,params:v.editParams.params,onClose:()=>C("editParams")}),e.jsx(Ye,{visible:v.moduleEdit.visible,onClose:()=>C("moduleEdit"),callback:()=>_(i),params:v.moduleEdit.params}),e.jsx(ze,{callback:()=>_(i),visible:v.createOrUpdatePipelineComponent.visible,onClose:()=>C("createOrUpdatePipelineComponent"),params:v.createOrUpdatePipelineComponent.params})]})})},at=({analsyisResult:i,loading:a})=>{const{baseURL:s}=P(t=>t.user),{projectObj:r}=P(t=>t.user),{modal:n,openModal:o,closeModal:l}=de();return e.jsxs("div",{children:[i&&e.jsxs(e.Fragment,{children:[i.images&&e.jsx("div",{style:{padding:"1rem"},children:Array.isArray(i.images)?e.jsx(ce,{gutter:{xs:8,sm:16,md:24,lg:32},children:i.images.map((t,c)=>e.jsx(J,{span:4,children:e.jsx(ie,{...t,baseURL:s})},c))}):e.jsx(e.Fragment,{children:e.jsx(ie,{...i.images,baseURL:s})})}),e.jsx("div",{style:{padding:"1rem"},children:i.htmls&&Array.isArray(i.htmls)&&e.jsx(e.Fragment,{children:i.htmls.map((t,c)=>e.jsxs("div",{children:[e.jsxs(y,{size:"small",color:"cyan",variant:"solid",onClick:()=>{o("HtmlPreview",{data:t.url})},children:["Open ",t.filename]})," ",e.jsx(N,{url:t.url,filename:t.filename,baseURL:s})]},c))})}),e.jsx("div",{style:{padding:"1rem"},children:i.tables&&Array.isArray(i.tables)&&e.jsx(e.Fragment,{children:i.tables.map((t,c)=>e.jsx(rt,{projectObj:r,...t,baseURL:s},c))})})]}),e.jsx(lt,{baseURL:s,visible:n.visible&&n.key=="HtmlPreview",onClose:l,params:n.params})]})},lt=({visible:i,onClose:a,params:s,baseURL:r})=>e.jsx(B,{open:i,onCancel:a,onClose:a,width:"80%",title:"HTML Preview",footer:null,children:(s==null?void 0:s.data)&&e.jsx(e.Fragment,{children:e.jsx("iframe",{src:`${r}${s==null?void 0:s.data}`,width:"100%",style:{height:"80vh",border:"none"}})})});export{Ft as A,Ge as B,He as C,Re as E,Ue as L,Ye as M,qe as P,Ke as a,bt as b,rt as c,ot as d,St as f,Y as r,Q as s,wt as w};
