import{Z as ze,a0 as Oe,a1 as ie,r as h,a5 as Me,O as G,Y as $e,aj as ke,ak as De,al as Ae,am as Be,an as Te,ao as Ne,ap as Le,aq as Pe,x as Ve,A as We,z as Re,e as T,j as e,F as b,S as N,I as B,T as Ge,B as F,a as E,g as k,n as Ke,d as L,M as H,P as R,q as ae,i as He,u as Je,U as Ue,t as qe,h as Ye,c as Xe,C as Qe,p as Ze,m as et}from"./main-DXb8rb93.js";import tt from"./index-KXj2g4Cn.js";import{C as le}from"./index-CTlwZfJX.js";import{T as O}from"./index-D6j9es1G.js";import{T as st,M as ce,R as nt}from"./index-C54HiVZI.js";import{S as rt}from"./study-page-rPHJnQiw.js";import{T as de}from"./index-Cc4yTCQW.js";import{F as ue}from"./Table-Dop9r612.js";import{D as ot}from"./index-DIQD0cKY.js";import{KGMLMapSVG as it}from"./index-Cv0-7R_6.js";import{S as at}from"./index-BaWKjIxw.js";import{_ as lt}from"./callSuper-BFEdxNFc.js";import{I as ct}from"./index-D122PzCT.js";const V=(s,i,t,n,r)=>({background:s,border:`${ie(n.lineWidth)} ${n.lineType} ${i}`,[`${r}-icon`]:{color:t}}),dt=s=>{const{componentCls:i,motionDurationSlow:t,marginXS:n,marginSM:r,fontSize:o,fontSizeLG:l,lineHeight:a,borderRadiusLG:c,motionEaseInOutCirc:u,withDescriptionIconSize:d,colorText:m,colorTextHeading:p,withDescriptionPadding:x,defaultPadding:f}=s;return{[i]:Object.assign(Object.assign({},Oe(s)),{position:"relative",display:"flex",alignItems:"center",padding:f,wordWrap:"break-word",borderRadius:c,[`&${i}-rtl`]:{direction:"rtl"},[`${i}-content`]:{flex:1,minWidth:0},[`${i}-icon`]:{marginInlineEnd:n,lineHeight:0},"&-description":{display:"none",fontSize:o,lineHeight:a},"&-message":{color:p},[`&${i}-motion-leave`]:{overflow:"hidden",opacity:1,transition:`max-height ${t} ${u}, opacity ${t} ${u},
        padding-top ${t} ${u}, padding-bottom ${t} ${u},
        margin-bottom ${t} ${u}`},[`&${i}-motion-leave-active`]:{maxHeight:0,marginBottom:"0 !important",paddingTop:0,paddingBottom:0,opacity:0}}),[`${i}-with-description`]:{alignItems:"flex-start",padding:x,[`${i}-icon`]:{marginInlineEnd:r,fontSize:d,lineHeight:0},[`${i}-message`]:{display:"block",marginBottom:n,color:p,fontSize:l},[`${i}-description`]:{display:"block",color:m}},[`${i}-banner`]:{marginBottom:0,border:"0 !important",borderRadius:0}}},ut=s=>{const{componentCls:i,colorSuccess:t,colorSuccessBorder:n,colorSuccessBg:r,colorWarning:o,colorWarningBorder:l,colorWarningBg:a,colorError:c,colorErrorBorder:u,colorErrorBg:d,colorInfo:m,colorInfoBorder:p,colorInfoBg:x}=s;return{[i]:{"&-success":V(r,n,t,s,i),"&-info":V(x,p,m,s,i),"&-warning":V(a,l,o,s,i),"&-error":Object.assign(Object.assign({},V(d,u,c,s,i)),{[`${i}-description > pre`]:{margin:0,padding:0}})}}},ht=s=>{const{componentCls:i,iconCls:t,motionDurationMid:n,marginXS:r,fontSizeIcon:o,colorIcon:l,colorIconHover:a}=s;return{[i]:{"&-action":{marginInlineStart:r},[`${i}-close-icon`]:{marginInlineStart:r,padding:0,overflow:"hidden",fontSize:o,lineHeight:ie(o),backgroundColor:"transparent",border:"none",outline:"none",cursor:"pointer",[`${t}-close`]:{color:l,transition:`color ${n}`,"&:hover":{color:a}}},"&-close-text":{color:l,transition:`color ${n}`,"&:hover":{color:a}}}}},mt=s=>({withDescriptionIconSize:s.fontSizeHeading3,defaultPadding:`${s.paddingContentVerticalSM}px 12px`,withDescriptionPadding:`${s.paddingMD}px ${s.paddingContentHorizontalLG}px`}),pt=ze("Alert",s=>[dt(s),ut(s),ht(s)],mt);var Q=function(s,i){var t={};for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&i.indexOf(n)<0&&(t[n]=s[n]);if(s!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,n=Object.getOwnPropertySymbols(s);r<n.length;r++)i.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(s,n[r])&&(t[n[r]]=s[n[r]]);return t};const ft={success:Le,info:Ne,error:Te,warning:Be},gt=s=>{const{icon:i,prefixCls:t,type:n}=s,r=ft[n]||null;return i?Ae(i,h.createElement("span",{className:`${t}-icon`},i),()=>({className:G(`${t}-icon`,i.props.className)})):h.createElement(r,{className:`${t}-icon`})},xt=s=>{const{isClosable:i,prefixCls:t,closeIcon:n,handleClose:r,ariaProps:o}=s,l=n===!0||n===void 0?h.createElement(Pe,null):n;return i?h.createElement("button",Object.assign({type:"button",onClick:r,className:`${t}-close-icon`,tabIndex:0},o),l):null},he=h.forwardRef((s,i)=>{const{description:t,prefixCls:n,message:r,banner:o,className:l,rootClassName:a,style:c,onMouseEnter:u,onMouseLeave:d,onClick:m,afterClose:p,showIcon:x,closable:f,closeText:j,closeIcon:y,action:v,id:S}=s,w=Q(s,["description","prefixCls","message","banner","className","rootClassName","style","onMouseEnter","onMouseLeave","onClick","afterClose","showIcon","closable","closeText","closeIcon","action","id"]),[g,I]=h.useState(!1),C=h.useRef(null);h.useImperativeHandle(i,()=>({nativeElement:C.current}));const{getPrefixCls:M,direction:P,closable:_,closeIcon:U,className:xe,style:ye}=Me("alert"),z=M("alert",n),[je,be,ve]=pt(z),Se=$=>{var D;I(!0),(D=s.onClose)===null||D===void 0||D.call(s,$)},q=h.useMemo(()=>s.type!==void 0?s.type:o?"warning":"info",[s.type,o]),we=h.useMemo(()=>typeof f=="object"&&f.closeIcon||j?!0:typeof f=="boolean"?f:y!==!1&&y!==null&&y!==void 0?!0:!!_,[j,y,f,_]),Y=o&&x===void 0?!0:x,Ce=G(z,`${z}-${q}`,{[`${z}-with-description`]:!!t,[`${z}-no-icon`]:!Y,[`${z}-banner`]:!!o,[`${z}-rtl`]:P==="rtl"},xe,l,a,ve,be),Ie=$e(w,{aria:!0,data:!0}),Fe=h.useMemo(()=>typeof f=="object"&&f.closeIcon?f.closeIcon:j||(y!==void 0?y:typeof _=="object"&&_.closeIcon?_.closeIcon:U),[y,f,j,U]),Ee=h.useMemo(()=>{const $=f??_;if(typeof $=="object"){const{closeIcon:D}=$;return Q($,["closeIcon"])}return{}},[f,_]);return je(h.createElement(ke,{visible:!g,motionName:`${z}-motion`,motionAppear:!1,motionEnter:!1,onLeaveStart:$=>({maxHeight:$.offsetHeight}),onLeaveEnd:p},($,D)=>{let{className:X,style:_e}=$;return h.createElement("div",Object.assign({id:S,ref:De(C,D),"data-show":!g,className:G(Ce,X),style:Object.assign(Object.assign(Object.assign({},ye),c),_e),onMouseEnter:u,onMouseLeave:d,onClick:m,role:"alert"},Ie),Y?h.createElement(gt,{description:t,icon:s.icon,prefixCls:z,type:q}):null,h.createElement("div",{className:`${z}-content`},r?h.createElement("div",{className:`${z}-message`},r):null,t?h.createElement("div",{className:`${z}-description`},t):null),v?h.createElement("div",{className:`${z}-action`},v):null,h.createElement(xt,{isClosable:we,prefixCls:z,closeIcon:Fe,handleClose:Se,ariaProps:Ee}))}))});let yt=function(s){function i(){var t;return Re(this,i),t=lt(this,i,arguments),t.state={error:void 0,info:{componentStack:""}},t}return Ve(i,s),We(i,[{key:"componentDidCatch",value:function(n,r){this.setState({error:n,info:r})}},{key:"render",value:function(){const{message:n,description:r,id:o,children:l}=this.props,{error:a,info:c}=this.state,u=(c==null?void 0:c.componentStack)||null,d=typeof n>"u"?(a||"").toString():n,m=typeof r>"u"?u:r;return a?h.createElement(he,{id:o,type:"error",message:d,description:h.createElement("pre",{style:{fontSize:"0.9em",overflowX:"auto"}},m)}):l}}])}(h.Component);const me=he;me.ErrorBoundary=yt;const jt=({type:s,dataMap:i,constDataMap:t,componentMap:n,inputAnalysisMethod:r,dataKey:o,data:l,name:a,component_id:c,inputKey:u,...d})=>{if(!i)return e.jsx("div",{children:"加载中...."});i={...i,...t};const m=n[s];if(!m)return e.jsxs("div",{children:["未知类型 ",s]});const{Component:p,dataKey:x,...f}=m;console.log(f);let j=[];return l?j=l:r?j=i[r]:o?o in i&&(j=i[o]):x?x in i&&(j=i[x]):"first_data_key"in i?j=i[i.first_data_key]:c in i&&(j=i[c]),e.jsx(p,{...f,...d,data:j,name:a})},K=h.memo(({formJson:s,dataMap:i})=>{if(!s)return null;const{projectObj:t}=T(),o={rank:[{label:"SGB",value:"SGB"},{label:"SPECIES",value:"SPECIES"},{label:"GENUS",value:"GENUS"},{label:"FAMILY",value:"FAMILY"},{label:"ORDER",value:"ORDER"},{label:"CLASS",value:"CLASS"},{label:"PHYLUM",value:"PHYLUM"}],group_field:t!=null&&t.metadata_form?t==null?void 0:t.metadata_form.map(a=>({label:a.label,value:a.name})):[]},l={GroupSelect:{Component:W,dataKey:"sample_group_list"},Input:{Component:wt},GroupCompareSelect:{Component:St},BaseSelect:{Component:W},BaseInputNumber:{Component:Ft},BaseInput:{Component:Ct},BaseSwitch:{Component:It},RankSelect:{Component:W,dataKey:"rank",mode:void 0,initialValue:"SPECIES"},GroupFieldSelect:{Component:W,dataKey:"group_field",mode:void 0,initialValue:"group"},FilterFieldSelect:{Component:bt,dataKey:"sample_group_list",mode:void 0},GroupSelectSampleButton:{Component:Et},MetaphlanCladeSelect:{Component:vt},SelectAll:{Component:_t,dataKey:"sample_group_list"}};return e.jsx(e.Fragment,{children:s.map((a,c)=>e.jsx(jt,{...a,dataMap:i,componentMap:l,constDataMap:o},c))})},(s,i)=>(console.log("prevProps==nextProps: ",JSON.stringify(s)===JSON.stringify(i)),JSON.stringify(s)===JSON.stringify(i))),bt=({label:s,name:i,data:t,rules:n,field:r,...o})=>{const[l,a]=h.useState(),c=b.useFormInstance();return h.useEffect(()=>{if(t&&r){const u=[...new Set(t.map(r))],d=u.map(m=>({label:m,value:m}));a(d),c.setFieldValue(i,u[0])}},[t]),e.jsx(e.Fragment,{children:e.jsx(b.Item,{label:s,name:i,rules:n,children:e.jsx(pe,{...o,options:l})})})},pe=({options:s,clear:i,value:t,onChange:n,...r})=>{const o=b.useFormInstance(),l=a=>{n(a),i&&o.resetFields(i)};return e.jsx(N,{showSearch:!0,filterOption:(a,c)=>((c==null?void 0:c.label)??"").toLowerCase().includes(a.toLowerCase()),...r,options:s,value:t,onChange:l})},vt=({label:s,name:i,data:t,initialValue:n,rules:r,...o})=>{const[l,a]=h.useState(),c=async()=>{let d=(await E.get("/fast-api/get_metaphlan_clade")).data.map(m=>({label:`${m.taxon.replaceAll(" ","_")}_${m.clade}`,value:m.clade}));a(d)};return h.useEffect(()=>{c()},[]),e.jsx(e.Fragment,{children:e.jsx(b.Item,{initialValue:n,label:s,name:i,rules:r,children:e.jsx(N,{...o,options:l,showSearch:!0,filterOption:(u,d)=>((d==null?void 0:d.label)??"").toLowerCase().includes(u.toLowerCase())})})})},St=({label:s,name:i,data:t,initialValue:n,rules:r,...o})=>{const l=b.useFormInstance(),a=b.useWatch(["sites1","group"],l),c=b.useWatch(["sites2","group"],l),[u,d]=h.useState();return h.useEffect(()=>{a&&c&&d([{label:"Prevalent in both sites",value:"Prevalent in both sites"},{label:`Prevalent in ${c.join("-")}`,value:`Prevalent in ${c.join("-")}`},{label:`Prevalent in ${a.join("-")}`,value:`Prevalent in ${a.join("-")}`},{label:"Not prevalent in either sites",value:"Not prevalent in either sites"}])},[a,c]),e.jsx(e.Fragment,{children:e.jsx(b.Item,{initialValue:n,label:s,name:i,rules:r,children:e.jsx(N,{showSearch:!0,filterOption:(m,p)=>((p==null?void 0:p.label)??"").toLowerCase().includes(m.toLowerCase()),...o,options:u})})})},wt=({label:s,name:i,data:t,initialValue:n,rules:r,...o})=>e.jsx(e.Fragment,{children:e.jsx(b.Item,{initialValue:n,label:s,name:i,rules:r,children:e.jsx(Ge,{...o})})}),Ct=({label:s,name:i,data:t,initialValue:n,rules:r,...o})=>e.jsx(e.Fragment,{children:e.jsx(b.Item,{initialValue:n,label:s,name:i,rules:r,children:e.jsx(B,{...o})})}),It=({label:s,name:i,data:t,initialValue:n,rules:r,...o})=>e.jsx(e.Fragment,{children:e.jsx(b.Item,{initialValue:n,label:s,name:i,rules:r,children:e.jsx(rt,{...o})})}),Ft=({label:s,name:i,data:t,initialValue:n,rules:r,...o})=>e.jsx(e.Fragment,{children:e.jsx(b.Item,{initialValue:n,label:s,name:i,rules:r,children:e.jsx(st,{...o})})}),W=({label:s,name:i,data:t,initialValue:n,rules:r,...o})=>e.jsx(e.Fragment,{children:e.jsx(b.Item,{initialValue:n||null,label:s,name:i,rules:r,children:e.jsx(pe,{...o,options:t})})}),Et=({label:s,name:i,rules:t,data:n,filter:r,group:o,groupField:l})=>{const[a,c]=h.useState(),[u,d]=h.useState([]),m=b.useFormInstance();let p=[];r&&(p=r.map(y=>y.name));const x=b.useWatch(y=>{const v=Object.entries(y).filter(([S])=>p.includes(S));return Object.fromEntries(v)},m),f=b.useWatch(o,m),j=(y,v)=>{const S=y.reduce((w,g)=>{const I=g[v];return w[I]||(w[I]=[]),w[I].push(g.value),w},{});c(S)};return h.useEffect(()=>{r&&x&&(n=r.reduce((y,v)=>y.filter(S=>v.method(S)===x[v.name]),n),n=n.map(y=>{const{label:v,id:S,value:w,...g}=y;return{label:`${y.label}(${r[0].method(y)})`,value:y.value,...g}})),n&&l?j(n,l):n&&f&&j(n,f),d(n)},[n,f,x]),e.jsxs(e.Fragment,{children:[e.jsx(b.Item,{label:s,name:[i,"sample"],rules:t,children:e.jsx(Ot,{sampleGrouped:a,sampleGroup:u,watch:[i,"group"]})}),e.jsx(b.Item,{label:s,name:[i,"group"],children:e.jsx(Mt,{sampleGrouped:a})})]})},_t=({label:s,name:i,data:t,initialValue:n,rules:r,...o})=>e.jsx(e.Fragment,{children:e.jsx(b.Item,{initialValue:n,label:s,name:i,rules:r,children:e.jsx(zt,{data:t,...o})})}),zt=({data:s,value:i,onChange:t,mode:n,...r})=>{const[o,l]=h.useState(i),a=c=>{console.log(c),t(c),l(c)};return e.jsxs(e.Fragment,{children:[e.jsx(N,{...r,mode:n,value:o,onChange:a,allowClear:!0,options:s}),n=="multiple"&&e.jsxs(F,{onClick:()=>{const c=s.map(u=>u.value);l(c),t(c)},children:["选择全部",o&&e.jsxs(e.Fragment,{children:["(",o.length,")"]})]})]})},Ot=({value:s,onChange:i,sampleGroup:t,watch:n,sampleGrouped:r})=>{const[o,l]=h.useState(),a=b.useFormInstance(),c=b.useWatch(n,a);h.useEffect(()=>{l(c)},[c]);const u=d=>{const m=Object.entries(r||{}).filter(([p])=>d.includes(p)).flatMap(([,p])=>p);i(m)};return h.useEffect(()=>{o&&u(o)},[o]),e.jsxs(e.Fragment,{children:[e.jsx(N,{showSearch:!0,filterOption:(d,m)=>((m==null?void 0:m.label)??"").toLowerCase().includes(d.toLowerCase()),mode:"multiple",value:s,onChange:i,options:t}),s&&e.jsxs(e.Fragment,{children:["一共选择",s.length,"个样本"]})]})},Mt=({value:s,onChange:i,sampleGrouped:t})=>{const n=r=>{if((s||[]).includes(r)){const o=(s||[]).filter(l=>!l.includes(r));i(o)}else{const o=[...s||[],r];i(o)}};return e.jsx(e.Fragment,{children:e.jsx(k,{gap:"small",wrap:!0,children:Object.entries(t||{}).map(([r,o])=>e.jsx("span",{children:e.jsxs(F,{size:"small",type:(s||[]).includes(r)?"primary":"dashed",onClick:()=>n(r),children:[r,"(",o.length,")"]})},r))})})},ws=async s=>await E.get("/file-operation/read-file",{params:{file_path:s}}),$t=async(s,i=0)=>await E.get("/file-operation/read-log-file",{params:{file_path:s,offset:i}}),Cs=async(s,i)=>await E.post("/file-operation/write-file",{file_path:s,content:i}),Is=async s=>await E.get(`/find-analysis-by-id/${s}`),kt=async(s,i)=>await E.post(`/run-analysis-v2/${s}?run_type=${i}`),Dt=async s=>await E.post(`/analysis/stop-analysis/${s}`);function A(s,i,t){let n=t.initialDeps??[],r;function o(){var l,a,c,u;let d;t.key&&((l=t.debug)!=null&&l.call(t))&&(d=Date.now());const m=s();if(!(m.length!==n.length||m.some((f,j)=>n[j]!==f)))return r;n=m;let x;if(t.key&&((a=t.debug)!=null&&a.call(t))&&(x=Date.now()),r=i(...m),t.key&&((c=t.debug)!=null&&c.call(t))){const f=Math.round((Date.now()-d)*100)/100,j=Math.round((Date.now()-x)*100)/100,y=j/16,v=(S,w)=>{for(S=String(S);S.length<w;)S=" "+S;return S};console.info(`%c⏱ ${v(j,5)} /${v(f,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*y,120))}deg 100% 31%);`,t==null?void 0:t.key)}return(u=t==null?void 0:t.onChange)==null||u.call(t,r),r}return o.updateDeps=l=>{n=l},o}function Z(s,i){if(s===void 0)throw new Error("Unexpected undefined");return s}const At=(s,i)=>Math.abs(s-i)<1.01,Bt=(s,i,t)=>{let n;return function(...r){s.clearTimeout(n),n=s.setTimeout(()=>i.apply(this,r),t)}},ee=s=>{const{offsetWidth:i,offsetHeight:t}=s;return{width:i,height:t}},Tt=s=>s,Nt=s=>{const i=Math.max(s.startIndex-s.overscan,0),t=Math.min(s.endIndex+s.overscan,s.count-1),n=[];for(let r=i;r<=t;r++)n.push(r);return n},Lt=(s,i)=>{const t=s.scrollElement;if(!t)return;const n=s.targetWindow;if(!n)return;const r=l=>{const{width:a,height:c}=l;i({width:Math.round(a),height:Math.round(c)})};if(r(ee(t)),!n.ResizeObserver)return()=>{};const o=new n.ResizeObserver(l=>{const a=()=>{const c=l[0];if(c!=null&&c.borderBoxSize){const u=c.borderBoxSize[0];if(u){r({width:u.inlineSize,height:u.blockSize});return}}r(ee(t))};s.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(a):a()});return o.observe(t,{box:"border-box"}),()=>{o.unobserve(t)}},te={passive:!0},se=typeof window>"u"?!0:"onscrollend"in window,Pt=(s,i)=>{const t=s.scrollElement;if(!t)return;const n=s.targetWindow;if(!n)return;let r=0;const o=s.options.useScrollendEvent&&se?()=>{}:Bt(n,()=>{i(r,!1)},s.options.isScrollingResetDelay),l=d=>()=>{const{horizontal:m,isRtl:p}=s.options;r=m?t.scrollLeft*(p&&-1||1):t.scrollTop,o(),i(r,d)},a=l(!0),c=l(!1);c(),t.addEventListener("scroll",a,te);const u=s.options.useScrollendEvent&&se;return u&&t.addEventListener("scrollend",c,te),()=>{t.removeEventListener("scroll",a),u&&t.removeEventListener("scrollend",c)}},Vt=(s,i,t)=>{if(i!=null&&i.borderBoxSize){const n=i.borderBoxSize[0];if(n)return Math.round(n[t.options.horizontal?"inlineSize":"blockSize"])}return s[t.options.horizontal?"offsetWidth":"offsetHeight"]},Wt=(s,{adjustments:i=0,behavior:t},n)=>{var r,o;const l=s+i;(o=(r=n.scrollElement)==null?void 0:r.scrollTo)==null||o.call(r,{[n.options.horizontal?"left":"top"]:l,behavior:t})};class Rt{constructor(i){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let t=null;const n=()=>t||(!this.targetWindow||!this.targetWindow.ResizeObserver?null:t=new this.targetWindow.ResizeObserver(r=>{r.forEach(o=>{const l=()=>{this._measureElement(o.target,o)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(l):l()})}));return{disconnect:()=>{var r;(r=n())==null||r.disconnect(),t=null},observe:r=>{var o;return(o=n())==null?void 0:o.observe(r,{box:"border-box"})},unobserve:r=>{var o;return(o=n())==null?void 0:o.unobserve(r)}}})(),this.range=null,this.setOptions=t=>{Object.entries(t).forEach(([n,r])=>{typeof r>"u"&&delete t[n]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:Tt,rangeExtractor:Nt,onChange:()=>{},measureElement:Vt,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...t}},this.notify=t=>{var n,r;(r=(n=this.options).onChange)==null||r.call(n,this,t)},this.maybeNotify=A(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),t=>{this.notify(t)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(t=>t()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var t;const n=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==n){if(this.cleanup(),!n){this.maybeNotify();return}this.scrollElement=n,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=((t=this.scrollElement)==null?void 0:t.window)??null,this.elementsCache.forEach(r=>{this.observer.observe(r)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,r=>{this.scrollRect=r,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(r,o)=>{this.scrollAdjustments=0,this.scrollDirection=o?this.getScrollOffset()<r?"forward":"backward":null,this.scrollOffset=r,this.isScrolling=o,this.maybeNotify()}))}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??(typeof this.options.initialOffset=="function"?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(t,n)=>{const r=new Map,o=new Map;for(let l=n-1;l>=0;l--){const a=t[l];if(r.has(a.lane))continue;const c=o.get(a.lane);if(c==null||a.end>c.end?o.set(a.lane,a):a.end<c.end&&r.set(a.lane,!0),r.size===this.options.lanes)break}return o.size===this.options.lanes?Array.from(o.values()).sort((l,a)=>l.end===a.end?l.index-a.index:l.end-a.end)[0]:void 0},this.getMeasurementOptions=A(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(t,n,r,o,l)=>(this.pendingMeasuredCacheIndexes=[],{count:t,paddingStart:n,scrollMargin:r,getItemKey:o,enabled:l}),{key:!1}),this.getMeasurements=A(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:t,paddingStart:n,scrollMargin:r,getItemKey:o,enabled:l},a)=>{if(!l)return this.measurementsCache=[],this.itemSizeCache.clear(),[];this.measurementsCache.length===0&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(d=>{this.itemSizeCache.set(d.key,d.size)}));const c=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];const u=this.measurementsCache.slice(0,c);for(let d=c;d<t;d++){const m=o(d),p=this.options.lanes===1?u[d-1]:this.getFurthestMeasurement(u,d),x=p?p.end+this.options.gap:n+r,f=a.get(m),j=typeof f=="number"?f:this.options.estimateSize(d),y=x+j,v=p?p.lane:d%this.options.lanes;u[d]={index:d,start:x,size:j,end:y,key:m,lane:v}}return this.measurementsCache=u,u},{key:!1,debug:()=>this.options.debug}),this.calculateRange=A(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(t,n,r,o)=>this.range=t.length>0&&n>0?Gt({measurements:t,outerSize:n,scrollOffset:r,lanes:o}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=A(()=>{let t=null,n=null;const r=this.calculateRange();return r&&(t=r.startIndex,n=r.endIndex),this.maybeNotify.updateDeps([this.isScrolling,t,n]),[this.options.rangeExtractor,this.options.overscan,this.options.count,t,n]},(t,n,r,o,l)=>o===null||l===null?[]:t({startIndex:o,endIndex:l,overscan:n,count:r}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=t=>{const n=this.options.indexAttribute,r=t.getAttribute(n);return r?parseInt(r,10):(console.warn(`Missing attribute name '${n}={index}' on measured element.`),-1)},this._measureElement=(t,n)=>{const r=this.indexFromElement(t),o=this.measurementsCache[r];if(!o)return;const l=o.key,a=this.elementsCache.get(l);a!==t&&(a&&this.observer.unobserve(a),this.observer.observe(t),this.elementsCache.set(l,t)),t.isConnected&&this.resizeItem(r,this.options.measureElement(t,n,this))},this.resizeItem=(t,n)=>{const r=this.measurementsCache[t];if(!r)return;const o=this.itemSizeCache.get(r.key)??r.size,l=n-o;l!==0&&((this.shouldAdjustScrollPositionOnItemSizeChange!==void 0?this.shouldAdjustScrollPositionOnItemSizeChange(r,l,this):r.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=l,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(r.index),this.itemSizeCache=new Map(this.itemSizeCache.set(r.key,n)),this.notify(!1))},this.measureElement=t=>{if(!t){this.elementsCache.forEach((n,r)=>{n.isConnected||(this.observer.unobserve(n),this.elementsCache.delete(r))});return}this._measureElement(t,void 0)},this.getVirtualItems=A(()=>[this.getVirtualIndexes(),this.getMeasurements()],(t,n)=>{const r=[];for(let o=0,l=t.length;o<l;o++){const a=t[o],c=n[a];r.push(c)}return r},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=t=>{const n=this.getMeasurements();if(n.length!==0)return Z(n[fe(0,n.length-1,r=>Z(n[r]).start,t)])},this.getOffsetForAlignment=(t,n,r=0)=>{const o=this.getSize(),l=this.getScrollOffset();n==="auto"&&(n=t>=l+o?"end":"start"),n==="center"?t+=(r-o)/2:n==="end"&&(t-=o);const a=this.getTotalSize()+this.options.scrollMargin-o;return Math.max(Math.min(a,t),0)},this.getOffsetForIndex=(t,n="auto")=>{t=Math.max(0,Math.min(t,this.options.count-1));const r=this.measurementsCache[t];if(!r)return;const o=this.getSize(),l=this.getScrollOffset();if(n==="auto")if(r.end>=l+o-this.options.scrollPaddingEnd)n="end";else if(r.start<=l+this.options.scrollPaddingStart)n="start";else return[l,n];const a=n==="end"?r.end+this.options.scrollPaddingEnd:r.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(a,n,r.size),n]},this.isDynamicMode=()=>this.elementsCache.size>0,this.scrollToOffset=(t,{align:n="start",behavior:r}={})=>{r==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getOffsetForAlignment(t,n),{adjustments:void 0,behavior:r})},this.scrollToIndex=(t,{align:n="auto",behavior:r}={})=>{r==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),t=Math.max(0,Math.min(t,this.options.count-1));let o=0;const l=10,a=u=>{if(!this.targetWindow)return;const d=this.getOffsetForIndex(t,u);if(!d){console.warn("Failed to get offset for index:",t);return}const[m,p]=d;this._scrollToOffset(m,{adjustments:void 0,behavior:r}),this.targetWindow.requestAnimationFrame(()=>{const x=this.getScrollOffset(),f=this.getOffsetForIndex(t,p);if(!f){console.warn("Failed to get offset for index:",t);return}At(f[0],x)||c(p)})},c=u=>{this.targetWindow&&(o++,o<l?this.targetWindow.requestAnimationFrame(()=>a(u)):console.warn(`Failed to scroll to index ${t} after ${l} attempts.`))};a(n)},this.scrollBy=(t,{behavior:n}={})=>{n==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getScrollOffset()+t,{adjustments:void 0,behavior:n})},this.getTotalSize=()=>{var t;const n=this.getMeasurements();let r;if(n.length===0)r=this.options.paddingStart;else if(this.options.lanes===1)r=((t=n[n.length-1])==null?void 0:t.end)??0;else{const o=Array(this.options.lanes).fill(null);let l=n.length-1;for(;l>=0&&o.some(a=>a===null);){const a=n[l];o[a.lane]===null&&(o[a.lane]=a.end),l--}r=Math.max(...o.filter(a=>a!==null))}return Math.max(r-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(t,{adjustments:n,behavior:r})=>{this.options.scrollToFn(t,{behavior:r,adjustments:n},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(i)}}const fe=(s,i,t,n)=>{for(;s<=i;){const r=(s+i)/2|0,o=t(r);if(o<n)s=r+1;else if(o>n)i=r-1;else return r}return s>0?s-1:0};function Gt({measurements:s,outerSize:i,scrollOffset:t,lanes:n}){const r=s.length-1,o=c=>s[c].start;if(s.length<=n)return{startIndex:0,endIndex:r};let l=fe(0,r,o,t),a=l;if(n===1)for(;a<r&&s[a].end<t+i;)a++;else if(n>1){const c=Array(n).fill(0);for(;a<r&&c.some(d=>d<t+i);){const d=s[a];c[d.lane]=d.end,a++}const u=Array(n).fill(t+i);for(;l>=0&&u.some(d=>d>=t);){const d=s[l];u[d.lane]=d.start,l--}l=Math.max(0,l-l%n),a=Math.min(r,a+(n-1-a%n))}return{startIndex:l,endIndex:a}}const ne=typeof document<"u"?h.useLayoutEffect:h.useEffect;function Kt(s){const i=h.useReducer(()=>({}),{})[1],t={...s,onChange:(r,o)=>{var l;o?Ke.flushSync(i):i(),(l=s.onChange)==null||l.call(s,r,o)}},[n]=h.useState(()=>new Rt(t));return n.setOptions(t),ne(()=>n._didMount(),[]),ne(()=>n._willUpdate()),n}function Ht(s){return Kt({observeElementRect:Lt,observeElementOffset:Pt,scrollToFn:Wt,...s})}const{Text:re}=L,Jt=({file_path:s})=>{var u;h.useEffect(()=>{console.log("fileKey",s),s&&o(s)},[s]);const{messageApi:i}=T(),t=h.useRef(0),[n,r]=h.useState([]),o=async(d,m=!1)=>{const p=await $t(d);t.current=p.data.offset,r(p.data.content),m&&i.success(`日志加载成功: ${d}`)},l=h.useRef(null),a=Ht({count:n.length,getScrollElement:()=>l.current,estimateSize:()=>30,overscan:10});h.useEffect(()=>{(n==null?void 0:n.length)>0&&a.scrollToIndex(n.length-1,{align:"end",behavior:"smooth"})},[n==null?void 0:n.length]);const c=a.getVirtualItems();return e.jsx(le,{size:"small",extra:e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>{o(s)},children:"刷新日志"}),title:e.jsxs(k,{gap:"small",wrap:"wrap",children:[e.jsxs(O,{color:"blue",children:["文件: ",s]}),e.jsxs(O,{color:"purple",children:["偏移量: ",t.current]})]}),bodyStyle:{padding:0},children:e.jsx("div",{ref:l,style:{height:400,overflowY:"auto",fontFamily:"monospace",backgroundColor:"#1e1e1e",color:"#d4d4d4",padding:"0 12px"},children:e.jsx("div",{style:{height:a.getTotalSize(),width:"100%",position:"relative"},children:e.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${((u=c[0])==null?void 0:u.start)??0}px)`},children:c.map(d=>e.jsx("div",{"data-index":d.index,ref:a.measureElement,style:{padding:"4px 0",borderBottom:"1px solid #333"},children:e.jsxs(k,{gap:"middle",children:[e.jsxs(re,{type:"secondary",style:{width:60,color:"#d4d4d4"},children:["#",d.index+1]}),e.jsx(re,{style:{whiteSpace:"pre-wrap",color:"#d4d4d4"},children:n[d.index]})]})},d.key))})})})})},Ut=({visible:s,onClose:i,params:t})=>e.jsx(H,{footer:null,title:"参数",width:"50%",open:s,onCancel:i,children:e.jsx(L,{children:e.jsx("pre",{children:JSON.stringify(t,null,2)})})}),qt=({formJson:s,openModal:i})=>{if(!s)return null;const[t,n]=h.useState([]),r=async()=>{const o=s.map(c=>c.dataKey),a=((await E.post("/list-bio-database",{type_list:o})).data||[]).reduce((c,u)=>{const d=u.type;c[d]||(c[d]=[]);const{name:m,database_id:p,...x}=u;return c[d].push({label:m,value:p,...x}),c},{});n(a),console.log(a)};return h.useEffect(()=>{r()},[s]),e.jsx(e.Fragment,{children:e.jsxs(k,{gap:"small",children:[e.jsx("div",{style:{flex:1},children:e.jsx(K,{formJson:s,dataMap:t})}),e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:i,children:"配置数据库"}),e.jsx(F,{onClick:r,size:"small",type:"primary",children:"刷新"})]})})},Yt=({visible:s,onClose:i,params:t,callback:n})=>{if(!s)return null;const[r,o]=h.useState([]),[l,a]=h.useState(!1),[c]=b.useForm(),[u,d]=h.useState(t[0].dataKey),[m,p]=h.useState(null),x=async g=>{a(!0);const I=await E.post("/list-bio-database",g);o(I.data),a(!1)},f=async()=>({...await c.validateFields(),type:u}),j=async()=>{const g=await f();m?await E.post("/update-bio-database",{...g,database_id:m.database_id}):await E.post("/add-bio-database",g),y(),p(void 0),c.resetFields()},y=()=>{x({type:u})};h.useEffect(()=>{x({type:u})},[t]);const v=g=>{d(g),x({type:g})},S=async g=>{await E.delete(`/delete-bio-database/${g.id}`),y()},w=g=>{c.setFieldsValue(g),p(g)};return e.jsxs(H,{title:"数据库操作",open:s,onCancel:i,width:"50%",footer:null,children:[e.jsx(de,{tabBarExtraContent:e.jsxs(e.Fragment,{children:[e.jsx(F,{size:"small",color:"cyan",variant:"solid",style:{marginRight:"0.5rem"},type:"primary",onClick:y,children:" 刷新"}),e.jsxs(F,{size:"small",color:"cyan",variant:"solid",type:"primary",onClick:()=>{p(void 0),j()},children:[" ",m?"更新":"添加"]})]}),activeKey:u,onChange:v,items:t.map(g=>({key:g.name,label:g.label,children:e.jsx("div",{})}))}),e.jsxs(b,{form:c,style:{maxWidth:600},labelCol:{span:3},children:[e.jsx(b.Item,{name:"name",label:"名称",rules:[{required:!0,message:"请输入名称"}],children:e.jsx(B,{})}),e.jsx(b.Item,{name:"path",label:"路径",rules:[{required:!0,message:"请输入路径"}],children:e.jsx(B,{})}),e.jsx(b.Item,{name:"db_index",label:"索引",children:e.jsx(B,{})})]}),e.jsx(ue,{dataSource:r,columns:[{title:"名称",dataIndex:"name",key:"name"},{title:"数据库ID",dataIndex:"database_id",key:"database_id"},{title:"类型",dataIndex:"type",key:"type"},{title:"路径",dataIndex:"path",key:"path"},{title:"索引",dataIndex:"db_index",key:"db_index"},{title:"操作",dataIndex:"action",key:"action",ellipsis:!0,render:(g,I)=>e.jsxs(k,{gap:"small",children:[e.jsx(R,{title:"确定删除吗？",onConfirm:()=>{S(I)},children:e.jsx(F,{size:"small",type:"primary",danger:!0,children:"删除"})}),e.jsx(F,{size:"small",type:"primary",onClick:()=>{w(I)},children:"编辑"})]})}],loading:l,pagination:!1})]})},Xt=({visible:s,params:i,onClose:t,callback:n})=>{var y,v,S;const[r]=b.useForm(),{messageApi:o,project:l}=T();h.useEffect(()=>{s&&f()},[i]);const[a,c]=h.useState(),[u,d]=h.useState(),m=()=>{t(),n&&n()},[p,x]=h.useState(),f=async()=>{x(!0);const w=await E.post(`/analysis/edit-params/${i}`);c(w.data),d(w.data.analysis_result),r.resetFields(),r.setFieldsValue(w.data.request_param),x(!1)},j=w=>{if(w&&Object.keys(w).length>0)return Object.keys(w)[0]};return e.jsx(e.Fragment,{children:e.jsx(ot,{size:"default",loading:p,title:e.jsx(e.Fragment,{children:a&&e.jsxs(e.Fragment,{children:[e.jsx(O,{children:a==null?void 0:a.component_name}),e.jsx(O,{children:a==null?void 0:a.analysis_name}),e.jsx(O,{children:String(a==null?void 0:a.analysis_id).slice(0,8)})]})}),width:"50%",open:s,onClose:t,children:a&&e.jsx(e.Fragment,{children:e.jsx(Qt,{form:r,requestParam:{...a.request_param,analysis_id:a==null?void 0:a.analysis_id},dataMap:{...u,first_data_key:j(u)},formJson:[...((y=a.content)==null?void 0:y.formJson)||[],...((v=a.content)==null?void 0:v.upstreamFormJson)||[],...(a==null?void 0:a.inputFormJson)||[]],databases:(S=a.content)==null?void 0:S.databases,upstreamFormJson:a==null?void 0:a.upstreamFormJson,callback:m})})})})},Qt=({form:s,requestParam:i,dataMap:t,formJson:n,databases:r,callback:o,showCancal:l=!1})=>{const{modals:a,openModals:c,closeModals:u}=ae(["paramsView","bioDatabases"]),[d,m]=h.useState([]),[p,x]=h.useState([]),{messageApi:f,projectList:j,project:y}=T();h.useEffect(()=>{v()},[JSON.stringify(n)]);const v=()=>{if(Array.isArray(n)){const g=n.filter(C=>!(C!=null&&C.required)&&!(C!=null&&C.db)&&!C.component_id),I=n.filter(C=>(C==null?void 0:C.required)||(C==null?void 0:C.db)||C.component_id);m(I),x(g)}},S=g=>({...i,...g}),w=async(g,I=!1)=>{var P;const C=await s.validateFields(),M=S(C);try{const _=await E.post(`/fast-api/analysis-controller?save=${g}&is_submit=${I}`,M);console.log(_),g?(f.success("执行成功!"),o&&o()):c("paramsView",_.data)}catch(_){console.log(_),(P=_.response)!=null&&P.data&&f.error(_.response.data.detail)}};return e.jsxs(e.Fragment,{children:[e.jsxs(b,{form:s,onValuesChange:(g,I)=>{},children:[e.jsx(de,{items:[{key:"1",label:"必填参数",forceRender:!0,children:e.jsxs(e.Fragment,{children:[e.jsx(K,{formJson:[...d],dataMap:t}),r&&e.jsx(qt,{openModal:()=>{c("bioDatabases",r)},formJson:r})]})},{key:"2",label:"可选参数",forceRender:!0,children:e.jsx(e.Fragment,{children:e.jsx(K,{formJson:[...p],dataMap:{}})})}]}),e.jsx(b.Item,{label:"分析名称",name:"analysis_name",style:{maxWidth:600},rules:[{required:!0,message:"该字段不能为空!"}],children:e.jsx(B,{})}),e.jsxs(k,{gap:"small",children:[e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>{w(!1)},children:"查看参数"}),e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>w(!0),children:i!=null&&i.analysis_id?e.jsxs(e.Fragment,{children:["更新分析(",i.analysis_name,")(",String(i.analysis_id).slice(0,8),")"]}):e.jsx(e.Fragment,{children:"保存分析"})}),(i==null?void 0:i.analysis_id)&&l&&e.jsx(F,{size:"small",color:"cyan",onClick:()=>s.setFieldValue("analysis_id",void 0),children:"取消更新"})]}),e.jsx(He,{ghost:!0,items:[{key:"1",label:"更多",children:e.jsx(e.Fragment,{children:e.jsx(b.Item,{noStyle:!0,shouldUpdate:!0,children:()=>e.jsx(L,{children:e.jsx("pre",{children:JSON.stringify(S(s.getFieldsValue()),null,2)})})})})}]})]}),e.jsx(Ut,{visible:a.paramsView.visible,onClose:()=>u("paramsView"),params:a.paramsView.params}),e.jsx(Yt,{visible:a.bioDatabases.visible,onClose:()=>u("bioDatabases"),params:a.bioDatabases.params})]})},J=({url:s,filename:i,baseURL:t})=>e.jsx(e.Fragment,{children:s&&e.jsx(et,{title:`${t}${s}`,children:e.jsxs(O,{color:"success",style:{cursor:"pointer"},onClick:()=>{window.open(`${t}${s}?t=${Date.now()}`,"_blank")},children:[i," ",e.jsx(nt,{})]})})}),ge=({data:s,url:i,filename:t,columns:n,baseURL:r})=>{const{Search:o}=B,[l,a]=h.useState([]),c=u=>u?Object.keys(u).map(d=>({title:d,dataIndex:d,key:d,ellipsis:!0,width:150})):[];return h.useEffect(()=>{if(s){const u=s.map((d,m)=>({...d,key:m}));a(u)}},[s]),e.jsx(e.Fragment,{children:Array.isArray(l)&&e.jsx(e.Fragment,{children:e.jsx(ue,{style:{border:"1px solid #f0f0f0"},size:"small",title:()=>e.jsxs(k,{gap:"small",children:[e.jsx(o,{size:"small",placeholder:"input search text",allowClear:!0,onSearch:u=>{const d=s.filter(m=>Object.values(m).some(p=>typeof p=="string"&&p.includes(u)));a(d)},style:{width:304}}),e.jsx(J,{url:i,filename:t,baseURL:r})]}),scroll:{x:"max-content",y:55*5},dataSource:l,pagination:!1,virtual:!0,columns:n||c(s[0]),footer:()=>`一共${s.length}条记录`})})})},oe=({data:s,url:i,filename:t,baseURL:n})=>e.jsx("div",{children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx(ct,{src:t!=null&&t.endsWith("pdf")?s:`${s}?t=${Date.now()}`,style:{maxWidth:"20rem",marginRight:"0.5rem"}}),e.jsx(J,{url:i,filename:t,baseURL:n})]})}),{Paragraph:Fs}=L,Zt=({data:s})=>e.jsx(e.Fragment,{children:e.jsx(ce,{value:s})}),es=({data:s})=>e.jsx("div",{children:e.jsx(me,{closable:!0,message:s,type:"info",showIcon:!0})}),ts=({data:s})=>e.jsx(e.Fragment,{children:e.jsx(L,{children:e.jsx("pre",{style:{margin:0},children:s})})}),ss=({data:s})=>e.jsx(e.Fragment,{children:e.jsx(ce,{value:s,defaultLanguage:"json"})}),ns=({data:s})=>e.jsx(e.Fragment,{children:s&&s.startsWith("/brave")?e.jsx(e.Fragment,{children:e.jsx("iframe",{src:s,width:"100%",style:{height:"80vh",border:"none"}})}):e.jsx(e.Fragment,{children:s})}),rs=({url:s,filename:i,baseURL:t})=>e.jsx(e.Fragment,{children:e.jsx(J,{url:s,filename:i,baseURL:t})}),os=({data:s,...i})=>{var o,l,a,c,u;const{modal:t,openModal:n,closeModal:r}=Ze();return e.jsxs(e.Fragment,{children:[e.jsx(ge,{data:s==null?void 0:s.list,...i,columns:[{title:"ID",dataIndex:"ID",key:"ID",ellipsis:!0,width:150},{title:"Description",dataIndex:"Description",key:"Description",ellipsis:!0,width:400},{title:"GeneRatio",dataIndex:"GeneRatio",key:"GeneRatio",ellipsis:!0,width:150},{title:"geneID",dataIndex:"geneID",key:"geneID",ellipsis:!0,width:150},{title:"Count",dataIndex:"Count",key:"Count",ellipsis:!0,width:150},{title:"pvalue",dataIndex:"pvalue",key:"pvalue",ellipsis:!0,width:150},{title:"p.adjust",dataIndex:"p.adjust",key:"p.adjust",ellipsis:!0,width:150},{title:"qvalue",dataIndex:"qvalue",key:"qvalue",ellipsis:!0,width:150},{title:"organism",dataIndex:"organism",key:"organism",ellipsis:!0,width:150},{title:"pathwayId",dataIndex:"pathwayId",key:"pathwayId",ellipsis:!0,width:150},{title:"操作",key:"action",fixed:"right",ellipsis:!0,width:200,render:(d,m)=>e.jsx(e.Fragment,{children:e.jsx(F,{onClick:()=>{n("KGMLMapSVG",m)},size:"small",color:"cyan",variant:"solid",children:"pathview"})})}]}),t.visible&&e.jsx(H,{width:"80%",title:`${(o=t.params)==null?void 0:o.Description}(${(l=t.params)==null?void 0:l.ID})`,footer:null,onCancel:r,onClose:r,open:t.visible&&t.key=="KGMLMapSVG",children:e.jsx(it,{compound:s==null?void 0:s.compound,highlightKeys:(a=t.params)==null?void 0:a.geneID.split("/"),pathwayId:(c=t.params)==null?void 0:c.pathwayId,organisms:(u=t.params)==null?void 0:u.organism})})]})},is={table:ge,string:Zt,html:ns,json:ss,text:ts,info:es,kegg_map:os,download:rs},as=({type:s,...i})=>{const t=is[s]||(()=>e.jsxs("div",{children:["未知类型 ",s]}));return e.jsx("div",{style:{marginBottom:"1rem"},children:e.jsx(t,{...i})})},Es=h.forwardRef(({params:s,visible:i,onClose:t},n)=>{const{output_dir:r,analysis_id:o}=s||{};return i?e.jsx(e.Fragment,{children:o&&e.jsx(ls,{onClose:t,analysis_id:o})}):null}),ls=({analysis_id:s,onClose:i,cancalReportCallback:t})=>{var S,w;const[n,r]=h.useState(!1),[o,l]=h.useState(null),a=Je(),{eventSourceRef:c,status:u,reconnect:d}=Ue(),m=h.useRef(null),p=h.useRef(null),{messageApi:x}=T(),{modals:f,openModals:j,closeModals:y}=ae(["editParams"]),v=async g=>{r(!0);const I=await E.get(`/analysis/visualization-results/${g}`);l(I.data),m.current=g,r(!1)};return h.useEffect(()=>{v(s)},[s]),h.useEffect(()=>{var g;if(c){const I=C=>{const M=JSON.parse(C.data);p.current=M,m.current==M.analysis_id&&(M.event=="analysis_complete"||M.event=="analysis_failed"||M.event=="analysis_started")&&v(m.current)};return(g=c.current)==null||g.addEventListener("message",I),()=>{var C;console.log("removeEventListener"),(C=c.current)==null||C.removeEventListener("message",I)}}},[c.current]),e.jsx(e.Fragment,{children:e.jsxs(le,{size:"small",bodyStyle:{padding:0},title:e.jsx(e.Fragment,{children:o?e.jsxs(e.Fragment,{children:[e.jsx(O,{style:{cursor:"pointer"},onClick:()=>{a(`/component/${o==null?void 0:o.component_type}/${o==null?void 0:o.component_id}`)},children:o==null?void 0:o.component_name}),e.jsx(O,{children:o==null?void 0:o.analysis_name}),e.jsx(O,{children:String(o==null?void 0:o.analysis_id).slice(0,8)}),e.jsx(O,{children:o==null?void 0:o.analysis_status}),m.current==((S=p.current)==null?void 0:S.analysis_id)&&e.jsxs(O,{children:[" ",e.jsx(e.Fragment,{children:(w=p.current)==null?void 0:w.event})]})]}):e.jsx(e.Fragment,{})}),extra:e.jsxs(k,{gap:"small",children:[i&&e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>i(),children:"关闭"}),o&&e.jsxs(e.Fragment,{children:[e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>{j("editParams",o.analysis_id)},children:"编辑参数"}),(o==null?void 0:o.analysis_status)=="running"?e.jsx(e.Fragment,{children:e.jsx(R,{title:"是否停止!",onConfirm:async()=>{await Dt(o.analysis_id),x.success("停止成功")},children:e.jsx(F,{size:"small",color:"cyan",variant:"solid",children:"停止"})})}):e.jsx(e.Fragment,{children:e.jsx(R,{title:"是否运行!",onConfirm:async()=>{await kt(o.analysis_id,"job"),x.success("运行成功")},children:e.jsx(F,{size:"small",color:"cyan",variant:"solid",children:o.analysis_status=="created"?"运行":"重新运行"})})})]}),e.jsx(R,{title:o!=null&&o.is_report?"是否取消报告":"是否报告",onConfirm:async()=>{await E.post(`/analysis/update-report/${o==null?void 0:o.analysis_id}`),x.success("操作成功!"),l(null),t&&t()},children:e.jsx(F,{size:"small",color:"cyan",variant:"solid",children:o!=null&&o.is_report?"取消报告":"报告"})}),e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>v(s),children:"刷新"})]}),children:[(o==null?void 0:o.analysis_status)=="failed"?e.jsx("div",{style:{textAlign:"center"},children:e.jsx(Jt,{file_path:o==null?void 0:o.command_log_path})}):e.jsx(e.Fragment,{children:(o==null?void 0:o.analysis_status)=="running"&&(o==null?void 0:o.run_type)!="server"?e.jsx(qe,{active:!0}):e.jsx(e.Fragment,{children:s&&e.jsx(cs,{analsyisResult:o,loading:n})})}),e.jsx(Xt,{callback:()=>v(s),visible:f.editParams.visible,params:f.editParams.params,onClose:()=>y("editParams")})]})})},cs=({analsyisResult:s,loading:i})=>{const{baseURL:t}=Ye(n=>n.user);return e.jsxs(at,{spinning:i,children:[s&&e.jsxs(e.Fragment,{children:[s.images&&e.jsx("div",{style:{marginBottom:"1rem",padding:"1rem",borderBottom:"1px solid #f0f0f0"},children:Array.isArray(s.images)?e.jsx(Xe,{gutter:{xs:8,sm:16,md:24,lg:32},children:s.images.map((n,r)=>e.jsx(Qe,{span:4,children:e.jsx(oe,{...n,baseURL:t})},r))}):e.jsx(e.Fragment,{children:e.jsx(oe,{...s.images,baseURL:t})})}),e.jsx("div",{style:{padding:"1rem"},children:s.tables&&Array.isArray(s.tables)&&e.jsx(e.Fragment,{children:s.tables.map((n,r)=>e.jsx(as,{...n,baseURL:t},r))})})]}),e.jsx(tt,{data:s==null?void 0:s.description})]})};export{Es as A,Yt as B,Qt as C,Xt as E,K as F,Jt as L,Ut as P,qt as a,ws as b,as as c,ls as d,Is as f,kt as r,Dt as s,Cs as w};
